
"use strict";
var configurationError = require("./utils/configurationError");
var getModulePath = require("./utils/getModulePath");
var _ = require("lodash");
var fs = require("fs");
var globjoin = require("globjoin");
var normalizeRuleSettings = require("./normalizeRuleSettings");
var path = require("path");
var rules = require("./rules");
var dynamicRequire = require("./dynamicRequire");

var DEFAULT_IGNORE_FILENAME = ".stylelintignore";
var FILE_NOT_FOUND_ERROR_CODE = "ENOENT";

// - Merges config and configOverrides
// - Makes all paths absolute
// - Merges extends
function augmentConfigBasic(stylelint, /*: stylelint$internalApi*/
config, /*: stylelint$config*/
configDir, /*: string*/
allowOverrides /*:: ?: boolean*/
) /*: Promise<stylelint$config>*/{
  return Promise.resolve().then(function () {
    if (!allowOverrides) return config;
    return _.merge(config, stylelint._options.configOverrides);
  }).then(function (augmentedConfig) {
    return extendConfig(stylelint, augmentedConfig, configDir);
  }).then(function (augmentedConfig) {
    return absolutizePaths(augmentedConfig, configDir);
  });
}

// Extended configs need to be run through augmentConfigBasic
// but do not need the full treatment. Things like pluginFunctions
// will be resolved and added by the parent config.
function augmentConfigExtended(stylelint, /*: stylelint$internalApi*/
cosmiconfigResultArg /*: ?{
                     config: stylelint$config,
                     filepath: string,
                     }*/
) /*: Promise<?{ config: stylelint$config, filepath: string }>*/{
  var cosmiconfigResult = cosmiconfigResultArg; // Lock in for Flow
  if (!cosmiconfigResult) return Promise.resolve(null);

  var configDir = path.dirname(cosmiconfigResult.filepath || "");
  var cleanedConfig = _.omit(cosmiconfigResult.config, "ignoreFiles");
  return augmentConfigBasic(stylelint, cleanedConfig, configDir).then(function (augmentedConfig) {
    return {
      config: augmentedConfig,
      filepath: cosmiconfigResult.filepath
    };
  });
}

function augmentConfigFull(stylelint, /*: stylelint$internalApi*/
cosmiconfigResultArg /*: ?{
                     config: stylelint$config,
                     filepath: string,
                     }*/
) /*: Promise<?{ config: stylelint$config, filepath: string }>*/{
  var cosmiconfigResult = cosmiconfigResultArg; // Lock in for Flow
  if (!cosmiconfigResult) return Promise.resolve(null);

  var config = cosmiconfigResult.config,
      filepath = cosmiconfigResult.filepath;

  var configDir = stylelint._options.configBasedir || path.dirname(filepath || "");

  return augmentConfigBasic(stylelint, config, configDir, true).then(function (augmentedConfig) {
    return addIgnorePatterns(stylelint, augmentedConfig);
  }).then(function (augmentedConfig) {
    return addPluginFunctions(augmentedConfig);
  }).then(function (augmentedConfig) {
    return addProcessorFunctions(augmentedConfig);
  }).then(function (augmentedConfig) {
    if (!augmentedConfig.rules) {
      throw configurationError("No rules found within configuration. Have you provided a \"rules\" property?");
    }

    return normalizeAllRuleSettings(augmentedConfig);
  }).then(function (augmentedConfig) {
    return {
      config: augmentedConfig,
      filepath: cosmiconfigResult.filepath
    };
  });
}

// Load a file ignore ignore patterns, if there is one;
// then add them to the config as an ignorePatterns property
function addIgnorePatterns(stylelint, /*: stylelint$internalApi*/
config /*: stylelint$config*/
) /*: Promise<stylelint$config>*/{
  var ignoreFilePath = stylelint._options.ignorePath || DEFAULT_IGNORE_FILENAME;
  var absoluteIgnoreFilePath = path.isAbsolute(ignoreFilePath) ? ignoreFilePath : path.resolve(process.cwd(), ignoreFilePath);

  return new Promise(function (resolve, reject) {
    fs.readFile(absoluteIgnoreFilePath, "utf8", function (err, data) {
      if (err) {
        // If the file's not found, fine, we'll just
        // consider it an empty array of globs
        if (err.code === FILE_NOT_FOUND_ERROR_CODE) {
          return resolve(config);
        }
        return reject(err);
      }
      // Add an ignorePatterns property to the config, containing the
      // .gitignore-patterned globs loaded from .stylelintignore
      var augmentedConfig /*: stylelint$config*/ = Object.assign({}, config, {
        ignorePatterns: data
      });
      resolve(augmentedConfig);
    });
  });
}

// Make all paths in the config absolute:
// - ignoreFiles
// - plugins
// - processors
// (extends handled elsewhere)
function absolutizePaths(config, /*: stylelint$config*/
configDir /*: string*/
) /*: stylelint$config*/{
  if (config.ignoreFiles) {
    config.ignoreFiles = [].concat(config.ignoreFiles).map(function (glob) {
      if (path.isAbsolute(glob.replace(/^!/, ""))) return glob;
      return globjoin(configDir, glob);
    });
  }

  if (config.plugins) {
    config.plugins = [].concat(config.plugins).map(function (lookup) {
      return getModulePath(configDir, lookup);
    });
  }

  if (config.processors) {
    config.processors = absolutizeProcessors(config.processors, configDir);
  }

  return config;
}

// Processors are absolutized in their own way because
// they can be and return a string or an array
function absolutizeProcessors(processors, /*: stylelint$configProcessors*/
configDir /*: string*/
) /*: stylelint$configProcessors*/{
  var normalizedProcessors = Array.isArray(processors) ? processors : [processors];

  return normalizedProcessors.map(function (item) {
    if (typeof item === "string") {
      return getModulePath(configDir, item);
    }

    return [getModulePath(configDir, item[0]), item[1]];
  });
}

function extendConfig(stylelint, /*: stylelint$internalApi*/
config, /*: stylelint$config*/
configDir /*: string*/
) /*: Promise<stylelint$config>*/{
  if (config["extends"] === undefined) return Promise.resolve(config);
  var normalizedExtends = Array.isArray(config["extends"]) ? config["extends"] : [config["extends"]];

  var originalWithoutExtends = _.omit(config, "extends");
  var loadExtends = normalizedExtends.reduce(function (resultPromise, extendLookup) {
    return resultPromise.then(function (resultConfig) {
      return loadExtendedConfig(stylelint, resultConfig, configDir, extendLookup).then(function (extendResult) {
        if (!extendResult) return resultConfig;
        return mergeConfigs(resultConfig, extendResult.config);
      });
    });
  }, Promise.resolve(originalWithoutExtends));

  return loadExtends.then(function (resultConfig) {
    return mergeConfigs(resultConfig, originalWithoutExtends);
  });
}

function loadExtendedConfig(stylelint, /*: stylelint$internalApi*/
config, /*: stylelint$config*/
configDir, /*: string*/
extendLookup /*: string*/
) /*: Promise<?{ config: stylelint$config, filepath: string }>*/{
  var extendPath = getModulePath(configDir, extendLookup);
  return stylelint._extendExplorer.load(null, extendPath);
}

// When merging configs (via extends)
// - plugin and processor arrays are joined
// - rules are merged via Object.assign, so there is no attempt made to
//   merge any given rule's settings. If b contains the same rule as a,
//   b's rule settings will override a's rule settings entirely.
// - Everything else is merged via Object.assign
function mergeConfigs(a, /*: stylelint$config*/b /*: stylelint$config*/) /*: stylelint$config*/{
  var pluginMerger = {};
  if (a.plugins || b.plugins) {
    pluginMerger.plugins = [];
    if (a.plugins) {
      pluginMerger.plugins = pluginMerger.plugins.concat(a.plugins);
    }
    if (b.plugins) {
      pluginMerger.plugins = _.uniq(pluginMerger.plugins.concat(b.plugins));
    }
  }

  var processorMerger = {};
  if (a.processors || b.processors) {
    processorMerger.processors = [];
    if (a.processors) {
      processorMerger.processors = processorMerger.processors.concat(a.processors);
    }
    if (b.processors) {
      processorMerger.processors = _.uniq(processorMerger.processors.concat(b.processors));
    }
  }

  var rulesMerger = {};
  if (a.rules || b.rules) {
    rulesMerger.rules = Object.assign({}, a.rules, b.rules);
  }

  var result = Object.assign({}, a, b, processorMerger, pluginMerger, rulesMerger);
  return result;
}

function addPluginFunctions(config /*: stylelint$config*/) /*: stylelint$config*/{
  if (!config.plugins) return config;

  var normalizedPlugins = Array.isArray(config.plugins) ? config.plugins : [config.plugins];

  var pluginFunctions = normalizedPlugins.reduce(function (result, pluginLookup) {
    var pluginImport = dynamicRequire(pluginLookup);
    // Handle either ES6 or CommonJS modules
    pluginImport = pluginImport["default"] || pluginImport;

    // A plugin can export either a single rule definition
    // or an array of them
    var normalizedPluginImport = Array.isArray(pluginImport) ? pluginImport : [pluginImport];

    normalizedPluginImport.forEach(function (pluginRuleDefinition) {
      if (!pluginRuleDefinition.ruleName) {
        throw configurationError("stylelint v3+ requires plugins to expose a ruleName. " + ("The plugin \"" + pluginLookup + "\" is not doing this, so will not work ") + "with stylelint v3+. Please file an issue with the plugin.");
      }

      if (!_.includes(pluginRuleDefinition.ruleName, "/")) {
        throw configurationError("stylelint v7+ requires plugin rules to be namspaced, " + "i.e. only `plugin-namespace/plugin-rule-name` plugin rule names are supported. " + ("The plugin rule \"" + pluginRuleDefinition.ruleName + "\" does not do this, so will not work. ") + "Please file an issue with the plugin.");
      }

      result[pluginRuleDefinition.ruleName] = pluginRuleDefinition.rule;
    });

    return result;
  }, {});

  config.pluginFunctions = pluginFunctions;
  return config;
}

function normalizeAllRuleSettings(config /*: stylelint$config*/) /*: stylelint$config*/{
  var normalizedRules = {};
  if (!config.rules) return config;
  Object.keys(config.rules).forEach(function (ruleName) {
    var rawRuleSettings = _.get(config, ["rules", ruleName]);
    var rule = rules[ruleName] || _.get(config, ["pluginFunctions", ruleName]);
    if (!rule) {
      throw configurationError("Undefined rule " + ruleName);
    }
    normalizedRules[ruleName] = normalizeRuleSettings(rawRuleSettings, ruleName, _.get(rule, "primaryOptionArray"));
  });
  config.rules = normalizedRules;
  return config;
}

// Given an array of processors strings, we want to add two
// properties to the augmented config:
// - codeProcessors: functions that will run on code as it comes in
// - resultProcessors: functions that will run on results as they go out
//
// To create these properties, we need to:
// - Find the processor module
// - Intialize the processor module by calling its functions with any
//   provided options
// - Push the processor's code and result processors to their respective arrays
var processorCache = new Map();
function addProcessorFunctions(config /*: stylelint$config*/) /*: stylelint$config*/{
  if (!config.processors) return config;

  var codeProcessors = [];
  var resultProcessors = [];[].concat(config.processors).forEach(function (processorConfig) {
    var processorKey = JSON.stringify(processorConfig);

    var initializedProcessor = undefined;
    if (processorCache.has(processorKey)) {
      initializedProcessor = processorCache.get(processorKey);
    } else {
      processorConfig = [].concat(processorConfig);
      var processorLookup = processorConfig[0];
      var processorOptions = processorConfig[1];
      var processor = dynamicRequire(processorLookup);
      processor = processor["default"] || processor;
      initializedProcessor = processor(processorOptions);
      processorCache.set(processorKey, initializedProcessor);
    }

    if (initializedProcessor && initializedProcessor.code) {
      codeProcessors.push(initializedProcessor.code);
    }
    if (initializedProcessor && initializedProcessor.result) {
      resultProcessors.push(initializedProcessor.result);
    }
  });

  config.codeProcessors = codeProcessors;
  config.resultProcessors = resultProcessors;
  return config;
}

module.exports = { augmentConfigExtended: augmentConfigExtended, augmentConfigFull: augmentConfigFull };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2xpbnRlci1zdHlsZWxpbnQvbm9kZV9tb2R1bGVzL3N0eWxlbGludC9saWIvYXVnbWVudENvbmZpZy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsWUFBWSxDQUFBO0FBQ1osSUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsNEJBQTRCLENBQUMsQ0FBQTtBQUNoRSxJQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQTtBQUN0RCxJQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDM0IsSUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3hCLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtBQUNwQyxJQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO0FBQ2hFLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUM1QixJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDaEMsSUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUE7O0FBRWxELElBQU0sdUJBQXVCLEdBQUcsa0JBQWtCLENBQUE7QUFDbEQsSUFBTSx5QkFBeUIsR0FBRyxRQUFRLENBQUE7Ozs7O0FBSzFDLFNBQVMsa0JBQWtCLENBQ3pCLFNBQVM7QUFDVCxNQUFNO0FBQ04sU0FBUztBQUNULGNBQWM7aUNBQ2lCO0FBQy9CLFNBQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFNO0FBQ2xDLFFBQUksQ0FBQyxjQUFjLEVBQUUsT0FBTyxNQUFNLENBQUE7QUFDbEMsV0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFBO0dBQzNELENBQUMsQ0FB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QUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUE7S0FDbkQ7R0FDRixDQUFDLENBQUE7O0FBRUYsUUFBTSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUE7QUFDdEMsUUFBTSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFBO0FBQzFDLFNBQU8sTUFBTSxDQUFBO0NBQ2Q7O0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLHFCQUFxQixFQUFyQixxQkFBcUIsRUFBRSxpQkFBaUIsRUFBakIsaUJBQWlCLEVBQUUsQ0FBQSIsImZpbGUiOiIvaG9tZS9qZXN1cy8uYXRvbS9wYWNrYWdlcy9saW50ZXItc3R5bGVsaW50L25vZGVfbW9kdWxlcy9zdHlsZWxpbnQvbGliL2F1Z21lbnRDb25maWcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXCJ1c2Ugc3RyaWN0XCJcbmNvbnN0IGNvbmZpZ3VyYXRpb25FcnJvciA9IHJlcXVpcmUoXCIuL3V0aWxzL2NvbmZpZ3VyYXRpb25FcnJvclwiKVxuY29uc3QgZ2V0TW9kdWxlUGF0aCA9IHJlcXVpcmUoXCIuL3V0aWxzL2dldE1vZHVsZVBhdGhcIilcbmNvbnN0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpXG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmc1wiKVxuY29uc3QgZ2xvYmpvaW4gPSByZXF1aXJlKFwiZ2xvYmpvaW5cIilcbmNvbnN0IG5vcm1hbGl6ZVJ1bGVTZXR0aW5ncyA9IHJlcXVpcmUoXCIuL25vcm1hbGl6ZVJ1bGVTZXR0aW5nc1wiKVxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpXG5jb25zdCBydWxlcyA9IHJlcXVpcmUoXCIuL3J1bGVzXCIpXG5jb25zdCBkeW5hbWljUmVxdWlyZSA9IHJlcXVpcmUoXCIuL2R5bmFtaWNSZXF1aXJlXCIpXG5cbmNvbnN0IERFRkFVTFRfSUdOT1JFX0ZJTEVOQU1FID0gXCIuc3R5bGVsaW50aWdub3JlXCJcbmNvbnN0IEZJTEVfTk9UX0ZPVU5EX0VSUk9SX0NPREUgPSBcIkVOT0VOVFwiXG5cbi8vIC0gTWVyZ2VzIGNvbmZpZyBhbmQgY29uZmlnT3ZlcnJpZGVzXG4vLyAtIE1ha2VzIGFsbCBwYXRocyBhYnNvbHV0ZVxuLy8gLSBNZXJnZXMgZXh0ZW5kc1xuZnVuY3Rpb24gYXVnbWVudENvbmZpZ0Jhc2ljKFxuICBzdHlsZWxpbnQvKjogc3R5bGVsaW50JGludGVybmFsQXBpKi8sXG4gIGNvbmZpZy8qOiBzdHlsZWxpbnQkY29uZmlnKi8sXG4gIGNvbmZpZ0Rpci8qOiBzdHJpbmcqLyxcbiAgYWxsb3dPdmVycmlkZXMvKjo6ID86IGJvb2xlYW4qL1xuKS8qOiBQcm9taXNlPHN0eWxlbGludCRjb25maWc+Ki8ge1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7XG4gICAgaWYgKCFhbGxvd092ZXJyaWRlcykgcmV0dXJuIGNvbmZpZ1xuICAgIHJldHVybiBfLm1lcmdlKGNvbmZpZywgc3R5bGVsaW50Ll9vcHRpb25zLmNvbmZpZ092ZXJyaWRlcylcbiAgfSkudGhlbihhdWdtZW50ZWRDb25maWcgPT4ge1xuICAgIHJldHVybiBleHRlbmRDb25maWcoc3R5bGVsaW50LCBhdWdtZW50ZWRDb25maWcsIGNvbmZpZ0RpcilcbiAgfSkudGhlbihhdWdtZW50ZWRDb25maWcgPT4ge1xuICAgIHJldHVybiBhYnNvbHV0aXplUGF0aHMoYXVnbWVudGVkQ29uZmlnLCBjb25maWdEaXIpXG4gIH0pXG59XG5cbi8vIEV4dGVuZGVkIGNvbmZpZ3MgbmVlZCB0byBiZSBydW4gdGhyb3VnaCBhdWdtZW50Q29uZmlnQmFzaWNcbi8vIGJ1dCBkbyBub3QgbmVlZCB0aGUgZnVsbCB0cmVhdG1lbnQuIFRoaW5ncyBsaWtlIHBsdWdpbkZ1bmN0aW9uc1xuLy8gd2lsbCBiZSByZXNvbHZlZCBhbmQgYWRkZWQgYnkgdGhlIHBhcmVudCBjb25maWcuXG5mdW5jdGlvbiBhdWdtZW50Q29uZmlnRXh0ZW5kZWQoXG4gIHN0eWxlbGludC8qOiBzdHlsZWxpbnQkaW50ZXJuYWxBcGkqLyxcbiAgY29zbWljb25maWdSZXN1bHRBcmcvKjogP3tcbiAgICAgY29uZmlnOiBzdHlsZWxpbnQkY29uZmlnLFxuICAgICBmaWxlcGF0aDogc3RyaW5nLFxuICAgfSovXG4gKS8qOiBQcm9taXNlPD97IGNvbmZpZzogc3R5bGVsaW50JGNvbmZpZywgZmlsZXBhdGg6IHN0cmluZyB9PiovIHtcbiAgY29uc3QgY29zbWljb25maWdSZXN1bHQgPSBjb3NtaWNvbmZpZ1Jlc3VsdEFyZyAvLyBMb2NrIGluIGZvciBGbG93XG4gIGlmICghY29zbWljb25maWdSZXN1bHQpIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbClcblxuICBjb25zdCBjb25maWdEaXIgPSBwYXRoLmRpcm5hbWUoY29zbWljb25maWdSZXN1bHQuZmlsZXBhdGggfHwgXCJcIilcbiAgY29uc3QgY2xlYW5lZENvbmZpZyA9IF8ub21pdChjb3NtaWNvbmZpZ1Jlc3VsdC5jb25maWcsIFwiaWdub3JlRmlsZXNcIilcbiAgcmV0dXJuIGF1Z21lbnRDb25maWdCYXNpYyhzdHlsZWxpbnQsIGNsZWFuZWRDb25maWcsIGNvbmZpZ0RpcikudGhlbihhdWdtZW50ZWRDb25maWcgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBjb25maWc6IGF1Z21lbnRlZENvbmZpZyxcbiAgICAgIGZpbGVwYXRoOiBjb3NtaWNvbmZpZ1Jlc3VsdC5maWxlcGF0aCxcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGF1Z21lbnRDb25maWdGdWxsKFxuICBzdHlsZWxpbnQvKjogc3R5bGVsaW50JGludGVybmFsQXBpKi8sXG4gICBjb3NtaWNvbmZpZ1Jlc3VsdEFyZy8qOiA/e1xuICAgY29uZmlnOiBzdHlsZWxpbnQkY29uZmlnLFxuICAgZmlsZXBhdGg6IHN0cmluZyxcbiAgfSovXG4pLyo6IFByb21pc2U8P3sgY29uZmlnOiBzdHlsZWxpbnQkY29uZmlnLCBmaWxlcGF0aDogc3RyaW5nIH0+Ki8ge1xuICBjb25zdCBjb3NtaWNvbmZpZ1Jlc3VsdCA9IGNvc21pY29uZmlnUmVzdWx0QXJnIC8vIExvY2sgaW4gZm9yIEZsb3dcbiAgaWYgKCFjb3NtaWNvbmZpZ1Jlc3VsdCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKVxuXG4gIGNvbnN0IGNvbmZpZyA9IGNvc21pY29uZmlnUmVzdWx0LmNvbmZpZyxcbiAgICBmaWxlcGF0aCA9IGNvc21pY29uZmlnUmVzdWx0LmZpbGVwYXRoXG5cbiAgY29uc3QgY29uZmlnRGlyID0gc3R5bGVsaW50Ll9vcHRpb25zLmNvbmZpZ0Jhc2VkaXIgfHwgcGF0aC5kaXJuYW1lKGZpbGVwYXRoIHx8IFwiXCIpXG5cbiAgcmV0dXJuIGF1Z21lbnRDb25maWdCYXNpYyhzdHlsZWxpbnQsIGNvbmZpZywgY29uZmlnRGlyLCB0cnVlKS50aGVuKGF1Z21lbnRlZENvbmZpZyA9PiB7XG4gICAgcmV0dXJuIGFkZElnbm9yZVBhdHRlcm5zKHN0eWxlbGludCwgYXVnbWVudGVkQ29uZmlnKVxuICB9KS50aGVuKGF1Z21lbnRlZENvbmZpZyA9PiB7XG4gICAgcmV0dXJuIGFkZFBsdWdpbkZ1bmN0aW9ucyhhdWdtZW50ZWRDb25maWcpXG4gIH0pLnRoZW4oYXVnbWVudGVkQ29uZmlnID0+IHtcbiAgICByZXR1cm4gYWRkUHJvY2Vzc29yRnVuY3Rpb25zKGF1Z21lbnRlZENvbmZpZylcbiAgfSkudGhlbihhdWdtZW50ZWRDb25maWcgPT4ge1xuICAgIGlmICghYXVnbWVudGVkQ29uZmlnLnJ1bGVzKSB7XG4gICAgICB0aHJvdyBjb25maWd1cmF0aW9uRXJyb3IoXCJObyBydWxlcyBmb3VuZCB3aXRoaW4gY29uZmlndXJhdGlvbi4gSGF2ZSB5b3UgcHJvdmlkZWQgYSBcXFwicnVsZXNcXFwiIHByb3BlcnR5P1wiKVxuICAgIH1cblxuICAgIHJldHVybiBub3JtYWxpemVBbGxSdWxlU2V0dGluZ3MoYXVnbWVudGVkQ29uZmlnKVxuICB9KS50aGVuKGF1Z21lbnRlZENvbmZpZyA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbmZpZzogYXVnbWVudGVkQ29uZmlnLFxuICAgICAgZmlsZXBhdGg6IGNvc21pY29uZmlnUmVzdWx0LmZpbGVwYXRoLFxuICAgIH1cbiAgfSlcbn1cblxuLy8gTG9hZCBhIGZpbGUgaWdub3JlIGlnbm9yZSBwYXR0ZXJucywgaWYgdGhlcmUgaXMgb25lO1xuLy8gdGhlbiBhZGQgdGhlbSB0byB0aGUgY29uZmlnIGFzIGFuIGlnbm9yZVBhdHRlcm5zIHByb3BlcnR5XG5mdW5jdGlvbiBhZGRJZ25vcmVQYXR0ZXJucyhcbiAgc3R5bGVsaW50Lyo6IHN0eWxlbGludCRpbnRlcm5hbEFwaSovLFxuICBjb25maWcvKjogc3R5bGVsaW50JGNvbmZpZyovXG4pLyo6IFByb21pc2U8c3R5bGVsaW50JGNvbmZpZz4qLyB7XG4gIGNvbnN0IGlnbm9yZUZpbGVQYXRoID0gc3R5bGVsaW50Ll9vcHRpb25zLmlnbm9yZVBhdGggfHwgREVGQVVMVF9JR05PUkVfRklMRU5BTUVcbiAgY29uc3QgYWJzb2x1dGVJZ25vcmVGaWxlUGF0aCA9IHBhdGguaXNBYnNvbHV0ZShpZ25vcmVGaWxlUGF0aCkgPyBpZ25vcmVGaWxlUGF0aCA6IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBpZ25vcmVGaWxlUGF0aClcblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGZzLnJlYWRGaWxlKGFic29sdXRlSWdub3JlRmlsZVBhdGgsIFwidXRmOFwiLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIC8vIElmIHRoZSBmaWxlJ3Mgbm90IGZvdW5kLCBmaW5lLCB3ZSdsbCBqdXN0XG4gICAgICAgIC8vIGNvbnNpZGVyIGl0IGFuIGVtcHR5IGFycmF5IG9mIGdsb2JzXG4gICAgICAgIGlmIChlcnIuY29kZSA9PT0gRklMRV9OT1RfRk9VTkRfRVJST1JfQ09ERSkge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKGNvbmZpZylcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVqZWN0KGVycilcbiAgICAgIH1cbiAgICAgIC8vIEFkZCBhbiBpZ25vcmVQYXR0ZXJucyBwcm9wZXJ0eSB0byB0aGUgY29uZmlnLCBjb250YWluaW5nIHRoZVxuICAgICAgLy8gLmdpdGlnbm9yZS1wYXR0ZXJuZWQgZ2xvYnMgbG9hZGVkIGZyb20gLnN0eWxlbGludGlnbm9yZVxuICAgICAgY29uc3QgYXVnbWVudGVkQ29uZmlnLyo6IHN0eWxlbGludCRjb25maWcqLyA9IE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZywge1xuICAgICAgICBpZ25vcmVQYXR0ZXJuczogZGF0YSxcbiAgICAgIH0pXG4gICAgICByZXNvbHZlKGF1Z21lbnRlZENvbmZpZylcbiAgICB9KVxuICB9KVxufVxuXG4vLyBNYWtlIGFsbCBwYXRocyBpbiB0aGUgY29uZmlnIGFic29sdXRlOlxuLy8gLSBpZ25vcmVGaWxlc1xuLy8gLSBwbHVnaW5zXG4vLyAtIHByb2Nlc3NvcnNcbi8vIChleHRlbmRzIGhhbmRsZWQgZWxzZXdoZXJlKVxuZnVuY3Rpb24gYWJzb2x1dGl6ZVBhdGhzKFxuICBjb25maWcvKjogc3R5bGVsaW50JGNvbmZpZyovLFxuICBjb25maWdEaXIvKjogc3RyaW5nKi9cbikvKjogc3R5bGVsaW50JGNvbmZpZyovIHtcbiAgaWYgKGNvbmZpZy5pZ25vcmVGaWxlcykge1xuICAgIGNvbmZpZy5pZ25vcmVGaWxlcyA9IFtdLmNvbmNhdChjb25maWcuaWdub3JlRmlsZXMpLm1hcChnbG9iID0+IHtcbiAgICAgIGlmIChwYXRoLmlzQWJzb2x1dGUoZ2xvYi5yZXBsYWNlKC9eIS8sIFwiXCIpKSkgcmV0dXJuIGdsb2JcbiAgICAgIHJldHVybiBnbG9iam9pbihjb25maWdEaXIsIGdsb2IpXG4gICAgfSlcbiAgfVxuXG4gIGlmIChjb25maWcucGx1Z2lucykge1xuICAgIGNvbmZpZy5wbHVnaW5zID0gW10uY29uY2F0KGNvbmZpZy5wbHVnaW5zKS5tYXAobG9va3VwID0+IHtcbiAgICAgIHJldHVybiBnZXRNb2R1bGVQYXRoKGNvbmZpZ0RpciwgbG9va3VwKVxuICAgIH0pXG4gIH1cblxuICBpZiAoY29uZmlnLnByb2Nlc3NvcnMpIHtcbiAgICBjb25maWcucHJvY2Vzc29ycyA9IGFic29sdXRpemVQcm9jZXNzb3JzKGNvbmZpZy5wcm9jZXNzb3JzLCBjb25maWdEaXIpXG4gIH1cblxuICByZXR1cm4gY29uZmlnXG59XG5cbi8vIFByb2Nlc3NvcnMgYXJlIGFic29sdXRpemVkIGluIHRoZWlyIG93biB3YXkgYmVjYXVzZVxuLy8gdGhleSBjYW4gYmUgYW5kIHJldHVybiBhIHN0cmluZyBvciBhbiBhcnJheVxuZnVuY3Rpb24gYWJzb2x1dGl6ZVByb2Nlc3NvcnMoXG4gIHByb2Nlc3NvcnMvKjogc3R5bGVsaW50JGNvbmZpZ1Byb2Nlc3NvcnMqLyxcbiAgY29uZmlnRGlyLyo6IHN0cmluZyovXG4pLyo6IHN0eWxlbGludCRjb25maWdQcm9jZXNzb3JzKi8ge1xuICBjb25zdCBub3JtYWxpemVkUHJvY2Vzc29ycyA9IEFycmF5LmlzQXJyYXkocHJvY2Vzc29ycykgPyBwcm9jZXNzb3JzIDogW3Byb2Nlc3NvcnNdXG5cbiAgcmV0dXJuIG5vcm1hbGl6ZWRQcm9jZXNzb3JzLm1hcChpdGVtID0+IHtcbiAgICBpZiAodHlwZW9mIGl0ZW0gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBnZXRNb2R1bGVQYXRoKGNvbmZpZ0RpciwgaXRlbSlcbiAgICB9XG5cbiAgICByZXR1cm4gWyBnZXRNb2R1bGVQYXRoKGNvbmZpZ0RpciwgaXRlbVswXSksIGl0ZW1bMV0gXVxuICB9KVxufVxuXG5mdW5jdGlvbiBleHRlbmRDb25maWcoXG4gIHN0eWxlbGludC8qOiBzdHlsZWxpbnQkaW50ZXJuYWxBcGkqLyxcbiAgY29uZmlnLyo6IHN0eWxlbGludCRjb25maWcqLyxcbiAgY29uZmlnRGlyLyo6IHN0cmluZyovXG4pLyo6IFByb21pc2U8c3R5bGVsaW50JGNvbmZpZz4qLyB7XG4gIGlmIChjb25maWcuZXh0ZW5kcyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbmZpZylcbiAgY29uc3Qgbm9ybWFsaXplZEV4dGVuZHMgPSBBcnJheS5pc0FycmF5KGNvbmZpZy5leHRlbmRzKSA/IGNvbmZpZy5leHRlbmRzIDogW2NvbmZpZy5leHRlbmRzXVxuXG4gIGNvbnN0IG9yaWdpbmFsV2l0aG91dEV4dGVuZHMgPSBfLm9taXQoY29uZmlnLCBcImV4dGVuZHNcIilcbiAgY29uc3QgbG9hZEV4dGVuZHMgPSBub3JtYWxpemVkRXh0ZW5kcy5yZWR1Y2UoKHJlc3VsdFByb21pc2UsIGV4dGVuZExvb2t1cCkgPT4ge1xuICAgIHJldHVybiByZXN1bHRQcm9taXNlLnRoZW4ocmVzdWx0Q29uZmlnID0+IHtcbiAgICAgIHJldHVybiBsb2FkRXh0ZW5kZWRDb25maWcoc3R5bGVsaW50LCByZXN1bHRDb25maWcsIGNvbmZpZ0RpciwgZXh0ZW5kTG9va3VwKS50aGVuKGV4dGVuZFJlc3VsdCA9PiB7XG4gICAgICAgIGlmICghZXh0ZW5kUmVzdWx0KSByZXR1cm4gcmVzdWx0Q29uZmlnXG4gICAgICAgIHJldHVybiBtZXJnZUNvbmZpZ3MocmVzdWx0Q29uZmlnLCBleHRlbmRSZXN1bHQuY29uZmlnKVxuICAgICAgfSlcbiAgICB9KVxuICB9LCBQcm9taXNlLnJlc29sdmUob3JpZ2luYWxXaXRob3V0RXh0ZW5kcykpXG5cbiAgcmV0dXJuIGxvYWRFeHRlbmRzLnRoZW4ocmVzdWx0Q29uZmlnID0+IHtcbiAgICByZXR1cm4gbWVyZ2VDb25maWdzKHJlc3VsdENvbmZpZywgb3JpZ2luYWxXaXRob3V0RXh0ZW5kcylcbiAgfSlcbn1cblxuZnVuY3Rpb24gbG9hZEV4dGVuZGVkQ29uZmlnKFxuICBzdHlsZWxpbnQvKjogc3R5bGVsaW50JGludGVybmFsQXBpKi8sXG4gIGNvbmZpZy8qOiBzdHlsZWxpbnQkY29uZmlnKi8sXG4gIGNvbmZpZ0Rpci8qOiBzdHJpbmcqLyxcbiAgZXh0ZW5kTG9va3VwLyo6IHN0cmluZyovXG4pLyo6IFByb21pc2U8P3sgY29uZmlnOiBzdHlsZWxpbnQkY29uZmlnLCBmaWxlcGF0aDogc3RyaW5nIH0+Ki8ge1xuICBjb25zdCBleHRlbmRQYXRoID0gZ2V0TW9kdWxlUGF0aChjb25maWdEaXIsIGV4dGVuZExvb2t1cClcbiAgcmV0dXJuIHN0eWxlbGludC5fZXh0ZW5kRXhwbG9yZXIubG9hZChudWxsLCBleHRlbmRQYXRoKVxufVxuXG4vLyBXaGVuIG1lcmdpbmcgY29uZmlncyAodmlhIGV4dGVuZHMpXG4vLyAtIHBsdWdpbiBhbmQgcHJvY2Vzc29yIGFycmF5cyBhcmUgam9pbmVkXG4vLyAtIHJ1bGVzIGFyZSBtZXJnZWQgdmlhIE9iamVjdC5hc3NpZ24sIHNvIHRoZXJlIGlzIG5vIGF0dGVtcHQgbWFkZSB0b1xuLy8gICBtZXJnZSBhbnkgZ2l2ZW4gcnVsZSdzIHNldHRpbmdzLiBJZiBiIGNvbnRhaW5zIHRoZSBzYW1lIHJ1bGUgYXMgYSxcbi8vICAgYidzIHJ1bGUgc2V0dGluZ3Mgd2lsbCBvdmVycmlkZSBhJ3MgcnVsZSBzZXR0aW5ncyBlbnRpcmVseS5cbi8vIC0gRXZlcnl0aGluZyBlbHNlIGlzIG1lcmdlZCB2aWEgT2JqZWN0LmFzc2lnblxuZnVuY3Rpb24gbWVyZ2VDb25maWdzKGEvKjogc3R5bGVsaW50JGNvbmZpZyovLCBiLyo6IHN0eWxlbGludCRjb25maWcqLykvKjogc3R5bGVsaW50JGNvbmZpZyovIHtcbiAgY29uc3QgcGx1Z2luTWVyZ2VyID0ge31cbiAgaWYgKGEucGx1Z2lucyB8fCBiLnBsdWdpbnMpIHtcbiAgICBwbHVnaW5NZXJnZXIucGx1Z2lucyA9IFtdXG4gICAgaWYgKGEucGx1Z2lucykge1xuICAgICAgcGx1Z2luTWVyZ2VyLnBsdWdpbnMgPSBwbHVnaW5NZXJnZXIucGx1Z2lucy5jb25jYXQoYS5wbHVnaW5zKVxuICAgIH1cbiAgICBpZiAoYi5wbHVnaW5zKSB7XG4gICAgICBwbHVnaW5NZXJnZXIucGx1Z2lucyA9IF8udW5pcShwbHVnaW5NZXJnZXIucGx1Z2lucy5jb25jYXQoYi5wbHVnaW5zKSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBwcm9jZXNzb3JNZXJnZXIgPSB7fVxuICBpZiAoYS5wcm9jZXNzb3JzIHx8IGIucHJvY2Vzc29ycykge1xuICAgIHByb2Nlc3Nvck1lcmdlci5wcm9jZXNzb3JzID0gW11cbiAgICBpZiAoYS5wcm9jZXNzb3JzKSB7XG4gICAgICBwcm9jZXNzb3JNZXJnZXIucHJvY2Vzc29ycyA9IHByb2Nlc3Nvck1lcmdlci5wcm9jZXNzb3JzLmNvbmNhdChhLnByb2Nlc3NvcnMpXG4gICAgfVxuICAgIGlmIChiLnByb2Nlc3NvcnMpIHtcbiAgICAgIHByb2Nlc3Nvck1lcmdlci5wcm9jZXNzb3JzID0gXy51bmlxKHByb2Nlc3Nvck1lcmdlci5wcm9jZXNzb3JzLmNvbmNhdChiLnByb2Nlc3NvcnMpKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHJ1bGVzTWVyZ2VyID0ge31cbiAgaWYgKGEucnVsZXMgfHwgYi5ydWxlcykge1xuICAgIHJ1bGVzTWVyZ2VyLnJ1bGVzID0gT2JqZWN0LmFzc2lnbih7fSwgYS5ydWxlcywgYi5ydWxlcylcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5hc3NpZ24oe30sIGEsIGIsIHByb2Nlc3Nvck1lcmdlciwgcGx1Z2luTWVyZ2VyLCBydWxlc01lcmdlcilcbiAgcmV0dXJuIHJlc3VsdFxufVxuXG5mdW5jdGlvbiBhZGRQbHVnaW5GdW5jdGlvbnMoY29uZmlnLyo6IHN0eWxlbGludCRjb25maWcqLykvKjogc3R5bGVsaW50JGNvbmZpZyovIHtcbiAgaWYgKCFjb25maWcucGx1Z2lucykgcmV0dXJuIGNvbmZpZ1xuXG4gIGNvbnN0IG5vcm1hbGl6ZWRQbHVnaW5zID0gQXJyYXkuaXNBcnJheShjb25maWcucGx1Z2lucykgPyBjb25maWcucGx1Z2lucyA6IFtjb25maWcucGx1Z2luc11cblxuICBjb25zdCBwbHVnaW5GdW5jdGlvbnMgPSBub3JtYWxpemVkUGx1Z2lucy5yZWR1Y2UoKHJlc3VsdCwgcGx1Z2luTG9va3VwKSA9PiB7XG4gICAgbGV0IHBsdWdpbkltcG9ydCA9IGR5bmFtaWNSZXF1aXJlKHBsdWdpbkxvb2t1cClcbiAgICAvLyBIYW5kbGUgZWl0aGVyIEVTNiBvciBDb21tb25KUyBtb2R1bGVzXG4gICAgcGx1Z2luSW1wb3J0ID0gcGx1Z2luSW1wb3J0LmRlZmF1bHQgfHwgcGx1Z2luSW1wb3J0XG5cbiAgICAvLyBBIHBsdWdpbiBjYW4gZXhwb3J0IGVpdGhlciBhIHNpbmdsZSBydWxlIGRlZmluaXRpb25cbiAgICAvLyBvciBhbiBhcnJheSBvZiB0aGVtXG4gICAgY29uc3Qgbm9ybWFsaXplZFBsdWdpbkltcG9ydCA9IEFycmF5LmlzQXJyYXkocGx1Z2luSW1wb3J0KSA/IHBsdWdpbkltcG9ydCA6IFtwbHVnaW5JbXBvcnRdXG5cbiAgICBub3JtYWxpemVkUGx1Z2luSW1wb3J0LmZvckVhY2gocGx1Z2luUnVsZURlZmluaXRpb24gPT4ge1xuICAgICAgaWYgKCFwbHVnaW5SdWxlRGVmaW5pdGlvbi5ydWxlTmFtZSkge1xuICAgICAgICB0aHJvdyBjb25maWd1cmF0aW9uRXJyb3IoXCJzdHlsZWxpbnQgdjMrIHJlcXVpcmVzIHBsdWdpbnMgdG8gZXhwb3NlIGEgcnVsZU5hbWUuIFwiICsgYFRoZSBwbHVnaW4gXCIke3BsdWdpbkxvb2t1cH1cIiBpcyBub3QgZG9pbmcgdGhpcywgc28gd2lsbCBub3Qgd29yayBgICsgXCJ3aXRoIHN0eWxlbGludCB2MysuIFBsZWFzZSBmaWxlIGFuIGlzc3VlIHdpdGggdGhlIHBsdWdpbi5cIilcbiAgICAgIH1cblxuICAgICAgaWYgKCFfLmluY2x1ZGVzKHBsdWdpblJ1bGVEZWZpbml0aW9uLnJ1bGVOYW1lLCBcIi9cIikpIHtcbiAgICAgICAgdGhyb3cgY29uZmlndXJhdGlvbkVycm9yKFwic3R5bGVsaW50IHY3KyByZXF1aXJlcyBwbHVnaW4gcnVsZXMgdG8gYmUgbmFtc3BhY2VkLCBcIiArIFwiaS5lLiBvbmx5IGBwbHVnaW4tbmFtZXNwYWNlL3BsdWdpbi1ydWxlLW5hbWVgIHBsdWdpbiBydWxlIG5hbWVzIGFyZSBzdXBwb3J0ZWQuIFwiICsgYFRoZSBwbHVnaW4gcnVsZSBcIiR7cGx1Z2luUnVsZURlZmluaXRpb24ucnVsZU5hbWV9XCIgZG9lcyBub3QgZG8gdGhpcywgc28gd2lsbCBub3Qgd29yay4gYCArIFwiUGxlYXNlIGZpbGUgYW4gaXNzdWUgd2l0aCB0aGUgcGx1Z2luLlwiKVxuICAgICAgfVxuXG4gICAgICByZXN1bHRbcGx1Z2luUnVsZURlZmluaXRpb24ucnVsZU5hbWVdID0gcGx1Z2luUnVsZURlZmluaXRpb24ucnVsZVxuICAgIH0pXG5cbiAgICByZXR1cm4gcmVzdWx0XG4gIH0sIHt9KVxuXG4gIGNvbmZpZy5wbHVnaW5GdW5jdGlvbnMgPSBwbHVnaW5GdW5jdGlvbnNcbiAgcmV0dXJuIGNvbmZpZ1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVBbGxSdWxlU2V0dGluZ3MoY29uZmlnLyo6IHN0eWxlbGludCRjb25maWcqLykvKjogc3R5bGVsaW50JGNvbmZpZyovIHtcbiAgY29uc3Qgbm9ybWFsaXplZFJ1bGVzID0ge31cbiAgaWYgKCFjb25maWcucnVsZXMpIHJldHVybiBjb25maWdcbiAgT2JqZWN0LmtleXMoY29uZmlnLnJ1bGVzKS5mb3JFYWNoKHJ1bGVOYW1lID0+IHtcbiAgICBjb25zdCByYXdSdWxlU2V0dGluZ3MgPSBfLmdldChjb25maWcsIFsgXCJydWxlc1wiLCBydWxlTmFtZSBdKVxuICAgIGNvbnN0IHJ1bGUgPSBydWxlc1tydWxlTmFtZV0gfHwgXy5nZXQoY29uZmlnLCBbIFwicGx1Z2luRnVuY3Rpb25zXCIsIHJ1bGVOYW1lIF0pXG4gICAgaWYgKCFydWxlKSB7XG4gICAgICB0aHJvdyBjb25maWd1cmF0aW9uRXJyb3IoYFVuZGVmaW5lZCBydWxlICR7cnVsZU5hbWV9YClcbiAgICB9XG4gICAgbm9ybWFsaXplZFJ1bGVzW3J1bGVOYW1lXSA9IG5vcm1hbGl6ZVJ1bGVTZXR0aW5ncyhyYXdSdWxlU2V0dGluZ3MsIHJ1bGVOYW1lLCBfLmdldChydWxlLCBcInByaW1hcnlPcHRpb25BcnJheVwiKSlcbiAgfSlcbiAgY29uZmlnLnJ1bGVzID0gbm9ybWFsaXplZFJ1bGVzXG4gIHJldHVybiBjb25maWdcbn1cblxuLy8gR2l2ZW4gYW4gYXJyYXkgb2YgcHJvY2Vzc29ycyBzdHJpbmdzLCB3ZSB3YW50IHRvIGFkZCB0d29cbi8vIHByb3BlcnRpZXMgdG8gdGhlIGF1Z21lbnRlZCBjb25maWc6XG4vLyAtIGNvZGVQcm9jZXNzb3JzOiBmdW5jdGlvbnMgdGhhdCB3aWxsIHJ1biBvbiBjb2RlIGFzIGl0IGNvbWVzIGluXG4vLyAtIHJlc3VsdFByb2Nlc3NvcnM6IGZ1bmN0aW9ucyB0aGF0IHdpbGwgcnVuIG9uIHJlc3VsdHMgYXMgdGhleSBnbyBvdXRcbi8vXG4vLyBUbyBjcmVhdGUgdGhlc2UgcHJvcGVydGllcywgd2UgbmVlZCB0bzpcbi8vIC0gRmluZCB0aGUgcHJvY2Vzc29yIG1vZHVsZVxuLy8gLSBJbnRpYWxpemUgdGhlIHByb2Nlc3NvciBtb2R1bGUgYnkgY2FsbGluZyBpdHMgZnVuY3Rpb25zIHdpdGggYW55XG4vLyAgIHByb3ZpZGVkIG9wdGlvbnNcbi8vIC0gUHVzaCB0aGUgcHJvY2Vzc29yJ3MgY29kZSBhbmQgcmVzdWx0IHByb2Nlc3NvcnMgdG8gdGhlaXIgcmVzcGVjdGl2ZSBhcnJheXNcbmNvbnN0IHByb2Nlc3NvckNhY2hlID0gbmV3IE1hcCgpXG5mdW5jdGlvbiBhZGRQcm9jZXNzb3JGdW5jdGlvbnMoY29uZmlnLyo6IHN0eWxlbGludCRjb25maWcqLykvKjogc3R5bGVsaW50JGNvbmZpZyovIHtcbiAgaWYgKCFjb25maWcucHJvY2Vzc29ycykgcmV0dXJuIGNvbmZpZ1xuXG4gIGNvbnN0IGNvZGVQcm9jZXNzb3JzID0gW11cbiAgY29uc3QgcmVzdWx0UHJvY2Vzc29ycyA9IFtdXG5cbiAgO1tdLmNvbmNhdChjb25maWcucHJvY2Vzc29ycykuZm9yRWFjaChwcm9jZXNzb3JDb25maWcgPT4ge1xuICAgIGNvbnN0IHByb2Nlc3NvcktleSA9IEpTT04uc3RyaW5naWZ5KHByb2Nlc3NvckNvbmZpZylcblxuICAgIGxldCBpbml0aWFsaXplZFByb2Nlc3NvclxuICAgIGlmIChwcm9jZXNzb3JDYWNoZS5oYXMocHJvY2Vzc29yS2V5KSkge1xuICAgICAgaW5pdGlhbGl6ZWRQcm9jZXNzb3IgPSBwcm9jZXNzb3JDYWNoZS5nZXQocHJvY2Vzc29yS2V5KVxuICAgIH0gZWxzZSB7XG4gICAgICBwcm9jZXNzb3JDb25maWcgPSBbXS5jb25jYXQocHJvY2Vzc29yQ29uZmlnKVxuICAgICAgY29uc3QgcHJvY2Vzc29yTG9va3VwID0gcHJvY2Vzc29yQ29uZmlnWzBdXG4gICAgICBjb25zdCBwcm9jZXNzb3JPcHRpb25zID0gcHJvY2Vzc29yQ29uZmlnWzFdXG4gICAgICBsZXQgcHJvY2Vzc29yID0gZHluYW1pY1JlcXVpcmUocHJvY2Vzc29yTG9va3VwKVxuICAgICAgcHJvY2Vzc29yID0gcHJvY2Vzc29yLmRlZmF1bHQgfHwgcHJvY2Vzc29yXG4gICAgICBpbml0aWFsaXplZFByb2Nlc3NvciA9IHByb2Nlc3Nvcihwcm9jZXNzb3JPcHRpb25zKVxuICAgICAgcHJvY2Vzc29yQ2FjaGUuc2V0KHByb2Nlc3NvcktleSwgaW5pdGlhbGl6ZWRQcm9jZXNzb3IpXG4gICAgfVxuXG4gICAgaWYgKGluaXRpYWxpemVkUHJvY2Vzc29yICYmIGluaXRpYWxpemVkUHJvY2Vzc29yLmNvZGUpIHtcbiAgICAgIGNvZGVQcm9jZXNzb3JzLnB1c2goaW5pdGlhbGl6ZWRQcm9jZXNzb3IuY29kZSlcbiAgICB9XG4gICAgaWYgKGluaXRpYWxpemVkUHJvY2Vzc29yICYmIGluaXRpYWxpemVkUHJvY2Vzc29yLnJlc3VsdCkge1xuICAgICAgcmVzdWx0UHJvY2Vzc29ycy5wdXNoKGluaXRpYWxpemVkUHJvY2Vzc29yLnJlc3VsdClcbiAgICB9XG4gIH0pXG5cbiAgY29uZmlnLmNvZGVQcm9jZXNzb3JzID0gY29kZVByb2Nlc3NvcnNcbiAgY29uZmlnLnJlc3VsdFByb2Nlc3NvcnMgPSByZXN1bHRQcm9jZXNzb3JzXG4gIHJldHVybiBjb25maWdcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7IGF1Z21lbnRDb25maWdFeHRlbmRlZCwgYXVnbWVudENvbmZpZ0Z1bGwgfVxuIl19