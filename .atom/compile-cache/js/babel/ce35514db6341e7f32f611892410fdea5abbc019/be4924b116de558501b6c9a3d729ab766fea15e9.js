
"use strict";
var _ = require("lodash");

var COMMAND_PREFIX = "stylelint-";
var disableCommand = COMMAND_PREFIX + "disable";
var enableCommand = COMMAND_PREFIX + "enable";
var disableLineCommand = COMMAND_PREFIX + "disable-line";
var disableNextLineCommand = COMMAND_PREFIX + "disable-next-line";
var ALL_RULES = "all";

/*:: type disabledRangeObject = {
  [ruleName: string]: Array<{
    start: number,
    end?: number,
  }>
}*/

// Run it like a plugin ...
module.exports = function (root, /*: Object*/
result /*: Object*/
) /*: postcss$result*/{
  result.stylelint = result.stylelint || {};

  // Most of the functions below work via side effects mutating
  // this object
  var disabledRanges /*: disabledRangeObject*/ = {
    all: []
  };
  result.stylelint.disabledRanges = disabledRanges;
  root.walkComments(checkComment);

  return result;

  function processDisableLineCommand(comment /*: postcss$comment*/) {
    getCommandRules(disableLineCommand, comment.text).forEach(function (ruleName) {
      disableLine(comment.source.start.line, ruleName, comment);
    });
  }

  function processDisableNextLineCommand(comment /*: postcss$comment*/) {
    getCommandRules(disableNextLineCommand, comment.text).forEach(function (ruleName) {
      disableLine(comment.source.start.line + 1, ruleName, comment);
    });
  }

  function disableLine(line, /*: number*/
  ruleName, /*: string*/
  comment /*: postcss$comment*/
  ) {
    if (ruleIsDisabled(ALL_RULES)) {
      throw comment.error("All rules have already been disabled", {
        plugin: "stylelint"
      });
    }
    if (ruleIsDisabled(ruleName)) {
      throw comment.error("\"" + ruleName + "\" has already been disabled", {
        plugin: "stylelint"
      });
    }
    if (ruleName === ALL_RULES) {
      Object.keys(disabledRanges).forEach(function (disabledRuleName) {
        startDisabledRange(line, disabledRuleName);
        endDisabledRange(line, disabledRuleName);
      });
    } else {
      startDisabledRange(line, ruleName);
      endDisabledRange(line, ruleName);
    }
  }

  function processDisableCommand(comment /*: postcss$comment*/) {
    getCommandRules(disableCommand, comment.text).forEach(function (ruleToDisable) {
      if (ruleToDisable === ALL_RULES) {
        if (ruleIsDisabled(ALL_RULES)) {
          throw comment.error("All rules have already been disabled", {
            plugin: "stylelint"
          });
        }
        Object.keys(disabledRanges).forEach(function (ruleName) {
          startDisabledRange(comment.source.start.line, ruleName);
        });
        return;
      }

      if (ruleIsDisabled(ruleToDisable)) {
        throw comment.error("\"" + ruleToDisable + "\" has already been disabled", {
          plugin: "stylelint"
        });
      }
      startDisabledRange(comment.source.start.line, ruleToDisable);
    });
  }

  function processEnableCommand(comment /*: postcss$comment*/) {
    getCommandRules(enableCommand, comment.text).forEach(function (ruleToEnable) {
      if (ruleToEnable === ALL_RULES) {
        if (_.values(disabledRanges).every(function (ranges) {
          return _.isEmpty(ranges) || !!_.last(ranges.end);
        })) {
          throw comment.error("No rules have been disabled", {
            plugin: "stylelint"
          });
        }
        Object.keys(disabledRanges).forEach(function (ruleName) {
          if (!_.get(_.last(disabledRanges[ruleName]), "end")) {
            endDisabledRange(comment.source.end.line, ruleName);
          }
        });
        return;
      }

      if (ruleIsDisabled(ALL_RULES) && disabledRanges[ruleToEnable] === undefined) {
        // Get a starting point from the where all rules were disabled
        if (!disabledRanges[ruleToEnable]) {
          disabledRanges[ruleToEnable] = _.cloneDeep(disabledRanges.all);
        } else {
          disabledRanges[ruleToEnable].push(_.clone(_.last(disabledRanges[ALL_RULES])));
        }
        endDisabledRange(comment.source.end.line, ruleToEnable);
        return;
      }

      if (ruleIsDisabled(ruleToEnable)) {
        endDisabledRange(comment.source.end.line, ruleToEnable);
        return;
      }

      throw comment.error("\"" + ruleToEnable + "\" has not been disabled", {
        plugin: "stylelint"
      });
    });
  }

  function checkComment(comment /*: postcss$comment*/) {
    var text = comment.text;

    // Ignore comments that are not relevant commands

    if (text.indexOf(COMMAND_PREFIX) !== 0) {
      return result;
    }

    if (text.indexOf(disableLineCommand) === 0) {
      processDisableLineCommand(comment);
    } else if (text.indexOf(disableNextLineCommand) === 0) {
      processDisableNextLineCommand(comment);
    } else if (text.indexOf(disableCommand) === 0) {
      processDisableCommand(comment);
    } else if (text.indexOf(enableCommand) === 0) {
      processEnableCommand(comment);
    }
  }

  function getCommandRules(command, /*: string*/
  fullText /*: string*/
  ) /*: Array<string>*/{
    var rules = _.compact(fullText.slice(command.length).split(",")).map(function (r) {
      return r.trim();
    });
    if (_.isEmpty(rules)) {
      return [ALL_RULES];
    }
    return rules;
  }

  function startDisabledRange(line, /*: number*/ruleName /*: string*/) {
    var rangeObj = { start: line };
    ensureRuleRanges(ruleName);
    disabledRanges[ruleName].push(rangeObj);
  }

  function endDisabledRange(line, /*: number*/ruleName /*: string*/) {
    var lastRangeForRule = _.last(disabledRanges[ruleName]);
    if (!lastRangeForRule) {
      return;
    }
    // Add an `end` prop to the last range of that rule
    lastRangeForRule.end = line;
  }

  function ensureRuleRanges(ruleName /*: string*/) {
    if (!disabledRanges[ruleName]) {
      disabledRanges[ruleName] = _.cloneDeep(disabledRanges.all);
    }
  }

  function ruleIsDisabled(ruleName /*: string*/) /*: boolean*/{
    if (disabledRanges[ruleName] === undefined) return false;
    if (_.last(disabledRanges[ruleName]) === undefined) return false;
    if (_.get(_.last(disabledRanges[ruleName]), "end") === undefined) return true;
    return false;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2xpbnRlci1zdHlsZWxpbnQvbm9kZV9tb2R1bGVzL3N0eWxlbGludC9saWIvYXNzaWduRGlzYWJsZWRSYW5nZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLFlBQVksQ0FBQztBQUNiLElBQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzs7QUFFNUIsSUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFDO0FBQ3BDLElBQU0sY0FBYyxHQUFHLGNBQWMsR0FBRyxTQUFTLENBQUM7QUFDbEQsSUFBTSxhQUFhLEdBQUcsY0FBYyxHQUFHLFFBQVEsQ0FBQztBQUNoRCxJQUFNLGtCQUFrQixHQUFHLGNBQWMsR0FBRyxjQUFjLENBQUM7QUFDM0QsSUFBTSxzQkFBc0IsR0FBRyxjQUFjLEdBQUcsbUJBQW1CLENBQUM7QUFDcEUsSUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDOzs7Ozs7Ozs7O0FBVXhCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFDZixJQUFJO0FBQ0osTUFBTTtzQkFDZTtBQUNyQixRQUFNLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDOzs7O0FBSTFDLE1BQU0sY0FBYyw2QkFBNkI7QUFDL0MsT0FBRyxFQUFFLEVBQUU7R0FDUixDQUFDO0FBQ0YsUUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO0FBQ2pELE1BQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7O0FBRWhDLFNBQU8sTUFBTSxDQUFDOztBQUVkLFdBQVMseUJBQXlCLENBQUMsT0FBTyx3QkFBd0I7QUFDaEUsbUJBQWUsQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsUUFBUSxFQUFJO0FBQ3BFLGlCQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztLQUMzRCxDQUFDLENBQUM7R0FDSjs7QUFFRCxXQUFTLDZCQUE2QixDQUFDLE9BQU8sd0JBQXdCO0FBQ3BFLG1CQUFlLENBQUMsc0JBQXNCLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLFFBQVEsRUFBSTtBQUN4RSxpQkFBVyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQy9ELENBQUMsQ0FBQztHQUNKOztBQUVELFdBQVMsV0FBVyxDQUNsQixJQUFJO0FBQ0osVUFBUTtBQUNSLFNBQU87SUFDUDtBQUNBLFFBQUksY0FBYyxDQUFDLFNBQVMsQ0FBQyxFQUFFO0FBQzdCLFlBQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRTtBQUMxRCxjQUFNLEVBQUUsV0FBVztPQUNwQixDQUFDLENBQUM7S0FDSjtBQUNELFFBQUksY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFFO0FBQzVCLFlBQU0sT0FBTyxDQUFDLEtBQUssUUFBSyxRQUFRLG1DQUErQjtBQUM3RCxjQUFNLEVBQUUsV0FBVztPQUNwQixDQUFDLENBQUM7S0FDSjtBQUNELFFBQUksUUFBUSxLQUFLLFNBQVMsRUFBRTtBQUMxQixZQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLGdCQUFnQixFQUFJO0FBQ3RELDBCQUFrQixDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzNDLHdCQUFnQixDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO09BQzFDLENBQUMsQ0FBQztLQUNKLE1BQU07QUFDTCx3QkFBa0IsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDbkMsc0JBQWdCLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ2xDO0dBQ0Y7O0FBRUQsV0FBUyxxQkFBcUIsQ0FBQyxPQUFPLHdCQUF3QjtBQUM1RCxtQkFBZSxDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsYUFBYSxFQUFJO0FBQ3JFLFVBQUksYUFBYSxLQUFLLFNBQVMsRUFBRTtBQUMvQixZQUFJLGNBQWMsQ0FBQyxTQUFTLENBQUMsRUFBRTtBQUM3QixnQkFBTSxPQUFPLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxFQUFFO0FBQzFELGtCQUFNLEVBQUUsV0FBVztXQUNwQixDQUFDLENBQUM7U0FDSjtBQUNELGNBQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsUUFBUSxFQUFJO0FBQzlDLDRCQUFrQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN6RCxDQUFDLENBQUM7QUFDSCxlQUFPO09BQ1I7O0FBRUQsVUFBSSxjQUFjLENBQUMsYUFBYSxDQUFDLEVBQUU7QUFDakMsY0FBTSxPQUFPLENBQUMsS0FBSyxRQUFLLGFBQWEsbUNBQStCO0FBQ2xFLGdCQUFNLEVBQUUsV0FBVztTQUNwQixDQUFDLENBQUM7T0FDSjtBQUNELHdCQUFrQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztLQUM5RCxDQUFDLENBQUM7R0FDSjs7QUFFRCxXQUFTLG9CQUFvQixDQUFDLE9BQU8sd0JBQXdCO0FBQzNELG1CQUFlLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxZQUFZLEVBQUk7QUFDbkUsVUFBSSxZQUFZLEtBQUssU0FBUyxFQUFFO0FBQzlCLFlBQ0UsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxLQUFLLENBQzVCLFVBQUEsTUFBTTtpQkFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7U0FBQSxDQUNwRCxFQUNEO0FBQ0EsZ0JBQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRTtBQUNqRCxrQkFBTSxFQUFFLFdBQVc7V0FDcEIsQ0FBQyxDQUFDO1NBQ0o7QUFDRCxjQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLFFBQVEsRUFBSTtBQUM5QyxjQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFO0FBQ25ELDRCQUFnQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztXQUNyRDtTQUNGLENBQUMsQ0FBQztBQUNILGVBQU87T0FDUjs7QUFFRCxVQUNFLGNBQWMsQ0FBQyxTQUFTLENBQUMsSUFDekIsY0FBYyxDQUFDLFlBQVksQ0FBQyxLQUFLLFNBQVMsRUFDMUM7O0FBRUEsWUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsRUFBRTtBQUNqQyx3QkFBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2hFLE1BQU07QUFDTCx3QkFBYyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDL0IsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQzNDLENBQUM7U0FDSDtBQUNELHdCQUFnQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztBQUN4RCxlQUFPO09BQ1I7O0FBRUQsVUFBSSxjQUFjLENBQUMsWUFBWSxDQUFDLEVBQUU7QUFDaEMsd0JBQWdCLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3hELGVBQU87T0FDUjs7QUFFRCxZQUFNLE9BQU8sQ0FBQyxLQUFLLFFBQUssWUFBWSwrQkFBMkI7QUFDN0QsY0FBTSxFQUFFLFdBQVc7T0FDcEIsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsV0FBUyxZQUFZLENBQUMsT0FBTyx3QkFBd0I7QUFDbkQsUUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQzs7OztBQUkxQixRQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ3RDLGFBQU8sTUFBTSxDQUFDO0tBQ2Y7O0FBRUQsUUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQzFDLCtCQUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3BDLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ3JELG1DQUE2QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3hDLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUM3QywyQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUNoQyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDNUMsMEJBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDL0I7R0FDRjs7QUFFRCxXQUFTLGVBQWUsQ0FDdEIsT0FBTztBQUNQLFVBQVE7dUJBQ1k7QUFDcEIsUUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDO2FBQ3RFLENBQUMsQ0FBQyxJQUFJLEVBQUU7S0FBQSxDQUNULENBQUM7QUFDRixRQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDcEIsYUFBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ3BCO0FBQ0QsV0FBTyxLQUFLLENBQUM7R0FDZDs7QUFFRCxXQUFTLGtCQUFrQixDQUFDLElBQUksY0FBZSxRQUFRLGVBQWU7QUFDcEUsUUFBTSxRQUFRLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDakMsb0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDM0Isa0JBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7R0FDekM7O0FBRUQsV0FBUyxnQkFBZ0IsQ0FBQyxJQUFJLGNBQWUsUUFBUSxlQUFlO0FBQ2xFLFFBQU0sZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUMxRCxRQUFJLENBQUMsZ0JBQWdCLEVBQUU7QUFDckIsYUFBTztLQUNSOztBQUVELG9CQUFnQixDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7R0FDN0I7O0FBRUQsV0FBUyxnQkFBZ0IsQ0FBQyxRQUFRLGVBQWU7QUFDL0MsUUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBRTtBQUM3QixvQkFBYyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQzVEO0dBQ0Y7O0FBRUQsV0FBUyxjQUFjLENBQUMsUUFBUSw0QkFBNkI7QUFDM0QsUUFBSSxjQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssU0FBUyxFQUFFLE9BQU8sS0FBSyxDQUFDO0FBQ3pELFFBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxTQUFTLEVBQUUsT0FBTyxLQUFLLENBQUM7QUFDakUsUUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEtBQUssU0FBUyxFQUM5RCxPQUFPLElBQUksQ0FBQztBQUNkLFdBQU8sS0FBSyxDQUFDO0dBQ2Q7Q0FDRixDQUFDIiwiZmlsZSI6Ii9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2xpbnRlci1zdHlsZWxpbnQvbm9kZV9tb2R1bGVzL3N0eWxlbGludC9saWIvYXNzaWduRGlzYWJsZWRSYW5nZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5jb25zdCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcblxuY29uc3QgQ09NTUFORF9QUkVGSVggPSBcInN0eWxlbGludC1cIjtcbmNvbnN0IGRpc2FibGVDb21tYW5kID0gQ09NTUFORF9QUkVGSVggKyBcImRpc2FibGVcIjtcbmNvbnN0IGVuYWJsZUNvbW1hbmQgPSBDT01NQU5EX1BSRUZJWCArIFwiZW5hYmxlXCI7XG5jb25zdCBkaXNhYmxlTGluZUNvbW1hbmQgPSBDT01NQU5EX1BSRUZJWCArIFwiZGlzYWJsZS1saW5lXCI7XG5jb25zdCBkaXNhYmxlTmV4dExpbmVDb21tYW5kID0gQ09NTUFORF9QUkVGSVggKyBcImRpc2FibGUtbmV4dC1saW5lXCI7XG5jb25zdCBBTExfUlVMRVMgPSBcImFsbFwiO1xuXG4vKjo6IHR5cGUgZGlzYWJsZWRSYW5nZU9iamVjdCA9IHtcbiAgW3J1bGVOYW1lOiBzdHJpbmddOiBBcnJheTx7XG4gICAgc3RhcnQ6IG51bWJlcixcbiAgICBlbmQ/OiBudW1iZXIsXG4gIH0+XG59Ki9cblxuLy8gUnVuIGl0IGxpa2UgYSBwbHVnaW4gLi4uXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFxuICByb290IC8qOiBPYmplY3QqLyxcbiAgcmVzdWx0IC8qOiBPYmplY3QqL1xuKSAvKjogcG9zdGNzcyRyZXN1bHQqLyB7XG4gIHJlc3VsdC5zdHlsZWxpbnQgPSByZXN1bHQuc3R5bGVsaW50IHx8IHt9O1xuXG4gIC8vIE1vc3Qgb2YgdGhlIGZ1bmN0aW9ucyBiZWxvdyB3b3JrIHZpYSBzaWRlIGVmZmVjdHMgbXV0YXRpbmdcbiAgLy8gdGhpcyBvYmplY3RcbiAgY29uc3QgZGlzYWJsZWRSYW5nZXMgLyo6IGRpc2FibGVkUmFuZ2VPYmplY3QqLyA9IHtcbiAgICBhbGw6IFtdXG4gIH07XG4gIHJlc3VsdC5zdHlsZWxpbnQuZGlzYWJsZWRSYW5nZXMgPSBkaXNhYmxlZFJhbmdlcztcbiAgcm9vdC53YWxrQ29tbWVudHMoY2hlY2tDb21tZW50KTtcblxuICByZXR1cm4gcmVzdWx0O1xuXG4gIGZ1bmN0aW9uIHByb2Nlc3NEaXNhYmxlTGluZUNvbW1hbmQoY29tbWVudCAvKjogcG9zdGNzcyRjb21tZW50Ki8pIHtcbiAgICBnZXRDb21tYW5kUnVsZXMoZGlzYWJsZUxpbmVDb21tYW5kLCBjb21tZW50LnRleHQpLmZvckVhY2gocnVsZU5hbWUgPT4ge1xuICAgICAgZGlzYWJsZUxpbmUoY29tbWVudC5zb3VyY2Uuc3RhcnQubGluZSwgcnVsZU5hbWUsIGNvbW1lbnQpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJvY2Vzc0Rpc2FibGVOZXh0TGluZUNvbW1hbmQoY29tbWVudCAvKjogcG9zdGNzcyRjb21tZW50Ki8pIHtcbiAgICBnZXRDb21tYW5kUnVsZXMoZGlzYWJsZU5leHRMaW5lQ29tbWFuZCwgY29tbWVudC50ZXh0KS5mb3JFYWNoKHJ1bGVOYW1lID0+IHtcbiAgICAgIGRpc2FibGVMaW5lKGNvbW1lbnQuc291cmNlLnN0YXJ0LmxpbmUgKyAxLCBydWxlTmFtZSwgY29tbWVudCk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBkaXNhYmxlTGluZShcbiAgICBsaW5lIC8qOiBudW1iZXIqLyxcbiAgICBydWxlTmFtZSAvKjogc3RyaW5nKi8sXG4gICAgY29tbWVudCAvKjogcG9zdGNzcyRjb21tZW50Ki9cbiAgKSB7XG4gICAgaWYgKHJ1bGVJc0Rpc2FibGVkKEFMTF9SVUxFUykpIHtcbiAgICAgIHRocm93IGNvbW1lbnQuZXJyb3IoXCJBbGwgcnVsZXMgaGF2ZSBhbHJlYWR5IGJlZW4gZGlzYWJsZWRcIiwge1xuICAgICAgICBwbHVnaW46IFwic3R5bGVsaW50XCJcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAocnVsZUlzRGlzYWJsZWQocnVsZU5hbWUpKSB7XG4gICAgICB0aHJvdyBjb21tZW50LmVycm9yKGBcIiR7cnVsZU5hbWV9XCIgaGFzIGFscmVhZHkgYmVlbiBkaXNhYmxlZGAsIHtcbiAgICAgICAgcGx1Z2luOiBcInN0eWxlbGludFwiXG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKHJ1bGVOYW1lID09PSBBTExfUlVMRVMpIHtcbiAgICAgIE9iamVjdC5rZXlzKGRpc2FibGVkUmFuZ2VzKS5mb3JFYWNoKGRpc2FibGVkUnVsZU5hbWUgPT4ge1xuICAgICAgICBzdGFydERpc2FibGVkUmFuZ2UobGluZSwgZGlzYWJsZWRSdWxlTmFtZSk7XG4gICAgICAgIGVuZERpc2FibGVkUmFuZ2UobGluZSwgZGlzYWJsZWRSdWxlTmFtZSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RhcnREaXNhYmxlZFJhbmdlKGxpbmUsIHJ1bGVOYW1lKTtcbiAgICAgIGVuZERpc2FibGVkUmFuZ2UobGluZSwgcnVsZU5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHByb2Nlc3NEaXNhYmxlQ29tbWFuZChjb21tZW50IC8qOiBwb3N0Y3NzJGNvbW1lbnQqLykge1xuICAgIGdldENvbW1hbmRSdWxlcyhkaXNhYmxlQ29tbWFuZCwgY29tbWVudC50ZXh0KS5mb3JFYWNoKHJ1bGVUb0Rpc2FibGUgPT4ge1xuICAgICAgaWYgKHJ1bGVUb0Rpc2FibGUgPT09IEFMTF9SVUxFUykge1xuICAgICAgICBpZiAocnVsZUlzRGlzYWJsZWQoQUxMX1JVTEVTKSkge1xuICAgICAgICAgIHRocm93IGNvbW1lbnQuZXJyb3IoXCJBbGwgcnVsZXMgaGF2ZSBhbHJlYWR5IGJlZW4gZGlzYWJsZWRcIiwge1xuICAgICAgICAgICAgcGx1Z2luOiBcInN0eWxlbGludFwiXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmtleXMoZGlzYWJsZWRSYW5nZXMpLmZvckVhY2gocnVsZU5hbWUgPT4ge1xuICAgICAgICAgIHN0YXJ0RGlzYWJsZWRSYW5nZShjb21tZW50LnNvdXJjZS5zdGFydC5saW5lLCBydWxlTmFtZSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChydWxlSXNEaXNhYmxlZChydWxlVG9EaXNhYmxlKSkge1xuICAgICAgICB0aHJvdyBjb21tZW50LmVycm9yKGBcIiR7cnVsZVRvRGlzYWJsZX1cIiBoYXMgYWxyZWFkeSBiZWVuIGRpc2FibGVkYCwge1xuICAgICAgICAgIHBsdWdpbjogXCJzdHlsZWxpbnRcIlxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHN0YXJ0RGlzYWJsZWRSYW5nZShjb21tZW50LnNvdXJjZS5zdGFydC5saW5lLCBydWxlVG9EaXNhYmxlKTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHByb2Nlc3NFbmFibGVDb21tYW5kKGNvbW1lbnQgLyo6IHBvc3Rjc3MkY29tbWVudCovKSB7XG4gICAgZ2V0Q29tbWFuZFJ1bGVzKGVuYWJsZUNvbW1hbmQsIGNvbW1lbnQudGV4dCkuZm9yRWFjaChydWxlVG9FbmFibGUgPT4ge1xuICAgICAgaWYgKHJ1bGVUb0VuYWJsZSA9PT0gQUxMX1JVTEVTKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBfLnZhbHVlcyhkaXNhYmxlZFJhbmdlcykuZXZlcnkoXG4gICAgICAgICAgICByYW5nZXMgPT4gXy5pc0VtcHR5KHJhbmdlcykgfHwgISFfLmxhc3QocmFuZ2VzLmVuZClcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IGNvbW1lbnQuZXJyb3IoXCJObyBydWxlcyBoYXZlIGJlZW4gZGlzYWJsZWRcIiwge1xuICAgICAgICAgICAgcGx1Z2luOiBcInN0eWxlbGludFwiXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmtleXMoZGlzYWJsZWRSYW5nZXMpLmZvckVhY2gocnVsZU5hbWUgPT4ge1xuICAgICAgICAgIGlmICghXy5nZXQoXy5sYXN0KGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSksIFwiZW5kXCIpKSB7XG4gICAgICAgICAgICBlbmREaXNhYmxlZFJhbmdlKGNvbW1lbnQuc291cmNlLmVuZC5saW5lLCBydWxlTmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoXG4gICAgICAgIHJ1bGVJc0Rpc2FibGVkKEFMTF9SVUxFUykgJiZcbiAgICAgICAgZGlzYWJsZWRSYW5nZXNbcnVsZVRvRW5hYmxlXSA9PT0gdW5kZWZpbmVkXG4gICAgICApIHtcbiAgICAgICAgLy8gR2V0IGEgc3RhcnRpbmcgcG9pbnQgZnJvbSB0aGUgd2hlcmUgYWxsIHJ1bGVzIHdlcmUgZGlzYWJsZWRcbiAgICAgICAgaWYgKCFkaXNhYmxlZFJhbmdlc1tydWxlVG9FbmFibGVdKSB7XG4gICAgICAgICAgZGlzYWJsZWRSYW5nZXNbcnVsZVRvRW5hYmxlXSA9IF8uY2xvbmVEZWVwKGRpc2FibGVkUmFuZ2VzLmFsbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGlzYWJsZWRSYW5nZXNbcnVsZVRvRW5hYmxlXS5wdXNoKFxuICAgICAgICAgICAgXy5jbG9uZShfLmxhc3QoZGlzYWJsZWRSYW5nZXNbQUxMX1JVTEVTXSkpXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBlbmREaXNhYmxlZFJhbmdlKGNvbW1lbnQuc291cmNlLmVuZC5saW5lLCBydWxlVG9FbmFibGUpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChydWxlSXNEaXNhYmxlZChydWxlVG9FbmFibGUpKSB7XG4gICAgICAgIGVuZERpc2FibGVkUmFuZ2UoY29tbWVudC5zb3VyY2UuZW5kLmxpbmUsIHJ1bGVUb0VuYWJsZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgY29tbWVudC5lcnJvcihgXCIke3J1bGVUb0VuYWJsZX1cIiBoYXMgbm90IGJlZW4gZGlzYWJsZWRgLCB7XG4gICAgICAgIHBsdWdpbjogXCJzdHlsZWxpbnRcIlxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBjaGVja0NvbW1lbnQoY29tbWVudCAvKjogcG9zdGNzcyRjb21tZW50Ki8pIHtcbiAgICBjb25zdCB0ZXh0ID0gY29tbWVudC50ZXh0O1xuXG4gICAgLy8gSWdub3JlIGNvbW1lbnRzIHRoYXQgYXJlIG5vdCByZWxldmFudCBjb21tYW5kc1xuXG4gICAgaWYgKHRleHQuaW5kZXhPZihDT01NQU5EX1BSRUZJWCkgIT09IDApIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgaWYgKHRleHQuaW5kZXhPZihkaXNhYmxlTGluZUNvbW1hbmQpID09PSAwKSB7XG4gICAgICBwcm9jZXNzRGlzYWJsZUxpbmVDb21tYW5kKGNvbW1lbnQpO1xuICAgIH0gZWxzZSBpZiAodGV4dC5pbmRleE9mKGRpc2FibGVOZXh0TGluZUNvbW1hbmQpID09PSAwKSB7XG4gICAgICBwcm9jZXNzRGlzYWJsZU5leHRMaW5lQ29tbWFuZChjb21tZW50KTtcbiAgICB9IGVsc2UgaWYgKHRleHQuaW5kZXhPZihkaXNhYmxlQ29tbWFuZCkgPT09IDApIHtcbiAgICAgIHByb2Nlc3NEaXNhYmxlQ29tbWFuZChjb21tZW50KTtcbiAgICB9IGVsc2UgaWYgKHRleHQuaW5kZXhPZihlbmFibGVDb21tYW5kKSA9PT0gMCkge1xuICAgICAgcHJvY2Vzc0VuYWJsZUNvbW1hbmQoY29tbWVudCk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZ2V0Q29tbWFuZFJ1bGVzKFxuICAgIGNvbW1hbmQgLyo6IHN0cmluZyovLFxuICAgIGZ1bGxUZXh0IC8qOiBzdHJpbmcqL1xuICApIC8qOiBBcnJheTxzdHJpbmc+Ki8ge1xuICAgIGNvbnN0IHJ1bGVzID0gXy5jb21wYWN0KGZ1bGxUZXh0LnNsaWNlKGNvbW1hbmQubGVuZ3RoKS5zcGxpdChcIixcIikpLm1hcChyID0+XG4gICAgICByLnRyaW0oKVxuICAgICk7XG4gICAgaWYgKF8uaXNFbXB0eShydWxlcykpIHtcbiAgICAgIHJldHVybiBbQUxMX1JVTEVTXTtcbiAgICB9XG4gICAgcmV0dXJuIHJ1bGVzO1xuICB9XG5cbiAgZnVuY3Rpb24gc3RhcnREaXNhYmxlZFJhbmdlKGxpbmUgLyo6IG51bWJlciovLCBydWxlTmFtZSAvKjogc3RyaW5nKi8pIHtcbiAgICBjb25zdCByYW5nZU9iaiA9IHsgc3RhcnQ6IGxpbmUgfTtcbiAgICBlbnN1cmVSdWxlUmFuZ2VzKHJ1bGVOYW1lKTtcbiAgICBkaXNhYmxlZFJhbmdlc1tydWxlTmFtZV0ucHVzaChyYW5nZU9iaik7XG4gIH1cblxuICBmdW5jdGlvbiBlbmREaXNhYmxlZFJhbmdlKGxpbmUgLyo6IG51bWJlciovLCBydWxlTmFtZSAvKjogc3RyaW5nKi8pIHtcbiAgICBjb25zdCBsYXN0UmFuZ2VGb3JSdWxlID0gXy5sYXN0KGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSk7XG4gICAgaWYgKCFsYXN0UmFuZ2VGb3JSdWxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIEFkZCBhbiBgZW5kYCBwcm9wIHRvIHRoZSBsYXN0IHJhbmdlIG9mIHRoYXQgcnVsZVxuICAgIGxhc3RSYW5nZUZvclJ1bGUuZW5kID0gbGluZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGVuc3VyZVJ1bGVSYW5nZXMocnVsZU5hbWUgLyo6IHN0cmluZyovKSB7XG4gICAgaWYgKCFkaXNhYmxlZFJhbmdlc1tydWxlTmFtZV0pIHtcbiAgICAgIGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSA9IF8uY2xvbmVEZWVwKGRpc2FibGVkUmFuZ2VzLmFsbCk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gcnVsZUlzRGlzYWJsZWQocnVsZU5hbWUgLyo6IHN0cmluZyovKSAvKjogYm9vbGVhbiovIHtcbiAgICBpZiAoZGlzYWJsZWRSYW5nZXNbcnVsZU5hbWVdID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTtcbiAgICBpZiAoXy5sYXN0KGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSkgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlO1xuICAgIGlmIChfLmdldChfLmxhc3QoZGlzYWJsZWRSYW5nZXNbcnVsZU5hbWVdKSwgXCJlbmRcIikgPT09IHVuZGVmaW5lZClcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufTtcbiJdfQ==