Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.normalizeString = normalizeString;
exports.getRow = getRow;
exports.getTextInRange = getTextInRange;
exports.getRows = getRows;
exports.getSelectedText = getSelectedText;
exports.isComment = isComment;
exports.isBlank = isBlank;
exports.escapeBlankRows = escapeBlankRows;
exports.getFoldRange = getFoldRange;
exports.getFoldContents = getFoldContents;
exports.getCodeToInspect = getCodeToInspect;
exports.getRegexString = getRegexString;
exports.getBreakpoints = getBreakpoints;
exports.getCurrentCell = getCurrentCell;
exports.getCells = getCells;
exports.getCellsForBreakPoints = getCellsForBreakPoints;
exports.moveDown = moveDown;
exports.findPrecedingBlock = findPrecedingBlock;
exports.findCodeBlock = findCodeBlock;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _atom = require("atom");

var _escapeStringRegexp = require("escape-string-regexp");

var _escapeStringRegexp2 = _interopRequireDefault(_escapeStringRegexp);

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var _utils = require("./utils");

function normalizeString(code) {
  if (code) {
    return code.replace(/\r\n|\r/g, "\n").trim();
  }
  return null;
}

function getRow(editor, row) {
  return normalizeString(editor.lineTextForBufferRow(row));
}

function getTextInRange(editor, start, end) {
  var code = editor.getTextInBufferRange([start, end]);
  return normalizeString(code);
}

function getRows(editor, startRow, endRow) {
  var code = editor.getTextInBufferRange({
    start: {
      row: startRow,
      column: 0
    },
    end: {
      row: endRow,
      column: 9999999
    }
  });
  return normalizeString(code);
}

function getSelectedText(editor) {
  return normalizeString(editor.getSelectedText());
}

function isComment(editor, position) {
  var scope = editor.scopeDescriptorForBufferPosition(position);
  var scopeString = scope.getScopeChain();
  return _lodash2["default"].includes(scopeString, "comment.line");
}

function isBlank(editor, row) {
  return editor.getBuffer().isRowBlank(row) || editor.isBufferRowCommented(row);
}

function escapeBlankRows(editor, startRow, endRow) {
  while (endRow > startRow) {
    if (!isBlank(editor, endRow)) break;
    endRow -= 1;
  }
  return endRow;
}

function getFoldRange(editor, row) {
  var range = editor.languageMode.rowRangeForCodeFoldAtBufferRow(row);
  if (!range) return;
  if (range[1] < editor.getLastBufferRow() && getRow(editor, range[1] + 1) === "end") {
    range[1] += 1;
  }
  (0, _utils.log)("getFoldRange:", range);
  return range;
}

function getFoldContents(editor, row) {
  var range = getFoldRange(editor, row);
  if (!range) return;
  return [getRows(editor, range[0], range[1]), range[1]];
}

function getCodeToInspect(editor) {
  var selectedText = getSelectedText(editor);
  var code = undefined;
  var cursorPosition = undefined;
  if (selectedText) {
    code = selectedText;
    cursorPosition = code.length;
  } else {
    var cursor = editor.getLastCursor();
    var row = cursor.getBufferRow();
    code = getRow(editor, row);
    cursorPosition = cursor.getBufferColumn();

    // TODO: use kernel.complete to find a selection
    var identifierEnd = code ? code.slice(cursorPosition).search(/\W/) : -1;
    if (identifierEnd !== -1) {
      cursorPosition += identifierEnd;
    }
  }

  return [code, cursorPosition];
}

function getRegexString(editor) {
  var scope = editor.getRootScopeDescriptor();

  var _editor$getCommentStrings = editor.getCommentStrings(scope);

  var commentStartString = _editor$getCommentStrings.commentStartString;

  if (!commentStartString) {
    (0, _utils.log)("CellManager: No comment string defined in root scope");
    return null;
  }

  var escapedCommentStartString = (0, _escapeStringRegexp2["default"])(commentStartString.trimRight());

  var regexString = escapedCommentStartString + "(%%| %%| <codecell>| In[[0-9 ]*]:?)";

  return regexString;
}

function getBreakpoints(editor) {
  var buffer = editor.getBuffer();
  var breakpoints = [];

  var regexString = getRegexString(editor);
  if (regexString) {
    var regex = new RegExp(regexString, "g");
    buffer.scan(regex, function (_ref) {
      var range = _ref.range;

      breakpoints.push(range.start);
    });
  }

  breakpoints.push(buffer.getEndPosition());

  (0, _utils.log)("CellManager: Breakpoints:", breakpoints);

  return breakpoints;
}

function getCurrentCodeCell(editor) {
  var buffer = editor.getBuffer();
  var start = new _atom.Point(0, 0);
  var end = buffer.getEndPosition();
  var regexString = getRegexString(editor);

  if (!regexString) {
    return new _atom.Range(start, end);
  }

  var regex = new RegExp(regexString);
  var cursor = editor.getCursorBufferPosition();

  while (cursor.row < end.row && isComment(editor, cursor)) {
    cursor.row += 1;
    cursor.column = 0;
  }

  if (cursor.row > 0) {
    buffer.backwardsScanInRange(regex, new _atom.Range(start, cursor), function (_ref2) {
      var range = _ref2.range;

      start = new _atom.Point(range.start.row + 1, 0);
    });
  }

  buffer.scanInRange(regex, new _atom.Range(cursor, end), function (_ref3) {
    var range = _ref3.range;

    end = range.start;
  });

  (0, _utils.log)("CellManager: Cell [start, end]:", [start, end], "cursor:", cursor);

  return new _atom.Range(start, end);
}

function isEmbeddedCode(editor, referenceScope, row) {
  var scopes = editor.scopeDescriptorForBufferPosition(new _atom.Point(row, 0)).getScopesArray();
  return _lodash2["default"].includes(scopes, referenceScope);
}

function getCurrentFencedCodeBlock(editor) {
  var buffer = editor.getBuffer();

  var _buffer$getEndPosition = buffer.getEndPosition();

  var bufferEndRow = _buffer$getEndPosition.row;

  var cursor = editor.getCursorBufferPosition();
  var start = cursor.row;
  var end = cursor.row;
  var scope = (0, _utils.getEmbeddedScope)(editor, cursor);
  if (!scope) return getCurrentCodeCell(editor);
  while (start > 0 && isEmbeddedCode(editor, scope, start - 1)) {
    start -= 1;
  }

  while (end < bufferEndRow && isEmbeddedCode(editor, scope, end + 1)) {
    end += 1;
  }

  return new _atom.Range([start, 0], [end, 9999999]);
}

function getCurrentCell(editor) {
  if ((0, _utils.isMultilanguageGrammar)(editor.getGrammar())) {
    return getCurrentFencedCodeBlock(editor);
  }
  return getCurrentCodeCell(editor);
}

function getCells(editor) {
  var breakpoints = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];

  if (breakpoints.length !== 0) {
    breakpoints.sort(function (a, b) {
      return a.compare(b);
    });
  } else {
    breakpoints = getBreakpoints(editor);
  }
  return getCellsForBreakPoints(breakpoints);
}

function getCellsForBreakPoints(breakpoints) {
  var start = new _atom.Point(0, 0);
  return _lodash2["default"].map(breakpoints, function (end) {
    var cell = new _atom.Range(start, end);
    start = new _atom.Point(end.row + 1, 0);
    return cell;
  });
}

function moveDown(editor, row) {
  var lastRow = editor.getLastBufferRow();

  if (row >= lastRow) {
    editor.moveToBottom();
    editor.insertNewline();
    return;
  }

  while (row < lastRow) {
    row += 1;
    if (!isBlank(editor, row)) break;
  }

  editor.setCursorBufferPosition({
    row: row,
    column: 0
  });
}

function findPrecedingBlock(editor, row, indentLevel) {
  var previousRow = row - 1;
  while (previousRow >= 0) {
    var previousIndentLevel = editor.indentationForBufferRow(previousRow);
    var sameIndent = previousIndentLevel <= indentLevel;
    var blank = isBlank(editor, previousRow);
    var isEnd = getRow(editor, previousRow) === "end";

    if (isBlank(editor, row)) {
      row = previousRow;
    }
    if (sameIndent && !blank && !isEnd) {
      return [getRows(editor, previousRow, row), row];
    }
    previousRow -= 1;
  }
  return null;
}

function findCodeBlock(editor) {
  var selectedText = getSelectedText(editor);

  if (selectedText) {
    var selectedRange = editor.getSelectedBufferRange();
    var endRow = selectedRange.end.row;
    if (selectedRange.end.column === 0) {
      endRow -= 1;
    }
    endRow = escapeBlankRows(editor, selectedRange.start.row, endRow);
    return [selectedText, endRow];
  }

  var cursor = editor.getLastCursor();

  var row = cursor.getBufferRow();
  (0, _utils.log)("findCodeBlock:", row);

  var indentLevel = cursor.getIndentLevel();
  var foldable = editor.isFoldableAtBufferRow(row);
  var foldRange = editor.languageMode.rowRangeForCodeFoldAtBufferRow(row);
  if (!foldRange || foldRange[0] == null || foldRange[1] == null) {
    foldable = false;
  }

  if (foldable) {
    return getFoldContents(editor, row);
  }
  if (isBlank(editor, row) || getRow(editor, row) === "end") {
    return findPrecedingBlock(editor, row, indentLevel);
  }
  return [getRow(editor, row), row];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL0h5ZHJvZ2VuL2xpYi9jb2RlLW1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFFNkIsTUFBTTs7a0NBRUosc0JBQXNCOzs7O3NCQUN2QyxRQUFROzs7O3FCQUVKLFNBQVM7Ozs7cUJBQ21DLFNBQVM7O0FBRWhFLFNBQVMsZUFBZSxDQUFDLElBQWEsRUFBRTtBQUM3QyxNQUFJLElBQUksRUFBRTtBQUNSLFdBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7R0FDOUM7QUFDRCxTQUFPLElBQUksQ0FBQztDQUNiOztBQUVNLFNBQVMsTUFBTSxDQUFDLE1BQXVCLEVBQUUsR0FBVyxFQUFFO0FBQzNELFNBQU8sZUFBZSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0NBQzFEOztBQUVNLFNBQVMsY0FBYyxDQUM1QixNQUF1QixFQUN2QixLQUFpQixFQUNqQixHQUFlLEVBQ2Y7QUFDQSxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUN2RCxTQUFPLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztDQUM5Qjs7QUFFTSxTQUFTLE9BQU8sQ0FDckIsTUFBdUIsRUFDdkIsUUFBZ0IsRUFDaEIsTUFBYyxFQUNkO0FBQ0EsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDO0FBQ3ZDLFNBQUssRUFBRTtBQUNMLFNBQUcsRUFBRSxRQUFRO0FBQ2IsWUFBTSxFQUFFLENBQUM7S0FDVjtBQUNELE9BQUcsRUFBRTtBQUNILFNBQUcsRUFBRSxNQUFNO0FBQ1gsWUFBTSxFQUFFLE9BQU87S0FDaEI7R0FDRixDQUFDLENBQUM7QUFDSCxTQUFPLGVBQWUsQ0FBQyxJQUFJ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QUM1QyxNQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDakQsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyw4QkFBOEIsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxRSxNQUFJLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRTtBQUM5RCxZQUFRLEdBQUcsS0FBSyxDQUFDO0dBQ2xCOztBQUVELE1BQUksUUFBUSxFQUFFO0FBQ1osV0FBTyxlQUFlLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0dBQ3JDO0FBQ0QsTUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEtBQUssS0FBSyxFQUFFO0FBQ3pELFdBQU8sa0JBQWtCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztHQUNyRDtBQUNELFNBQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0NBQ25DIiwiZmlsZSI6Ii9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL0h5ZHJvZ2VuL2xpYi9jb2RlLW1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5pbXBvcnQgeyBQb2ludCwgUmFuZ2UgfSBmcm9tIFwiYXRvbVwiO1xuXG5pbXBvcnQgZXNjYXBlU3RyaW5nUmVnZXhwIGZyb20gXCJlc2NhcGUtc3RyaW5nLXJlZ2V4cFwiO1xuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuXG5pbXBvcnQgc3RvcmUgZnJvbSBcIi4vc3RvcmVcIjtcbmltcG9ydCB7IGxvZywgaXNNdWx0aWxhbmd1YWdlR3JhbW1hciwgZ2V0RW1iZWRkZWRTY29wZSB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVTdHJpbmcoY29kZTogP3N0cmluZykge1xuICBpZiAoY29kZSkge1xuICAgIHJldHVybiBjb2RlLnJlcGxhY2UoL1xcclxcbnxcXHIvZywgXCJcXG5cIikudHJpbSgpO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um93KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCByb3c6IG51bWJlcikge1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGVkaXRvci5saW5lVGV4dEZvckJ1ZmZlclJvdyhyb3cpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRleHRJblJhbmdlKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgc3RhcnQ6IGF0b20kUG9pbnQsXG4gIGVuZDogYXRvbSRQb2ludFxuKSB7XG4gIGNvbnN0IGNvZGUgPSBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoW3N0YXJ0LCBlbmRdKTtcbiAgcmV0dXJuIG5vcm1hbGl6ZVN0cmluZyhjb2RlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJvd3MoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydFJvdzogbnVtYmVyLFxuICBlbmRSb3c6IG51bWJlclxuKSB7XG4gIGNvbnN0IGNvZGUgPSBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2Uoe1xuICAgIHN0YXJ0OiB7XG4gICAgICByb3c6IHN0YXJ0Um93LFxuICAgICAgY29sdW1uOiAwXG4gICAgfSxcbiAgICBlbmQ6IHtcbiAgICAgIHJvdzogZW5kUm93LFxuICAgICAgY29sdW1uOiA5OTk5OTk5XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG5vcm1hbGl6ZVN0cmluZyhjb2RlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNlbGVjdGVkVGV4dChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikge1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGVkaXRvci5nZXRTZWxlY3RlZFRleHQoKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NvbW1lbnQoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHBvc2l0aW9uOiBhdG9tJFBvaW50KSB7XG4gIGNvbnN0IHNjb3BlID0gZWRpdG9yLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgY29uc3Qgc2NvcGVTdHJpbmcgPSBzY29wZS5nZXRTY29wZUNoYWluKCk7XG4gIHJldHVybiBfLmluY2x1ZGVzKHNjb3BlU3RyaW5nLCBcImNvbW1lbnQubGluZVwiKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQmxhbmsoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIHJldHVybiBlZGl0b3IuZ2V0QnVmZmVyKCkuaXNSb3dCbGFuayhyb3cpIHx8IGVkaXRvci5pc0J1ZmZlclJvd0NvbW1lbnRlZChyb3cpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXNjYXBlQmxhbmtSb3dzKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgc3RhcnRSb3c6IG51bWJlcixcbiAgZW5kUm93OiBudW1iZXJcbikge1xuICB3aGlsZSAoZW5kUm93ID4gc3RhcnRSb3cpIHtcbiAgICBpZiAoIWlzQmxhbmsoZWRpdG9yLCBlbmRSb3cpKSBicmVhaztcbiAgICBlbmRSb3cgLT0gMTtcbiAgfVxuICByZXR1cm4gZW5kUm93O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Rm9sZFJhbmdlKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCByb3c6IG51bWJlcikge1xuICBjb25zdCByYW5nZSA9IGVkaXRvci5sYW5ndWFnZU1vZGUucm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KHJvdyk7XG4gIGlmICghcmFuZ2UpIHJldHVybjtcbiAgaWYgKFxuICAgIHJhbmdlWzFdIDwgZWRpdG9yLmdldExhc3RCdWZmZXJSb3coKSAmJlxuICAgIGdldFJvdyhlZGl0b3IsIHJhbmdlWzFdICsgMSkgPT09IFwiZW5kXCJcbiAgKSB7XG4gICAgcmFuZ2VbMV0gKz0gMTtcbiAgfVxuICBsb2coXCJnZXRGb2xkUmFuZ2U6XCIsIHJhbmdlKTtcbiAgcmV0dXJuIHJhbmdlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Rm9sZENvbnRlbnRzKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCByb3c6IG51bWJlcikge1xuICBjb25zdCByYW5nZSA9IGdldEZvbGRSYW5nZShlZGl0b3IsIHJvdyk7XG4gIGlmICghcmFuZ2UpIHJldHVybjtcbiAgcmV0dXJuIFtnZXRSb3dzKGVkaXRvciwgcmFuZ2VbMF0sIHJhbmdlWzFdKSwgcmFuZ2VbMV1dO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29kZVRvSW5zcGVjdChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikge1xuICBjb25zdCBzZWxlY3RlZFRleHQgPSBnZXRTZWxlY3RlZFRleHQoZWRpdG9yKTtcbiAgbGV0IGNvZGU7XG4gIGxldCBjdXJzb3JQb3NpdGlvbjtcbiAgaWYgKHNlbGVjdGVkVGV4dCkge1xuICAgIGNvZGUgPSBzZWxlY3RlZFRleHQ7XG4gICAgY3Vyc29yUG9zaXRpb24gPSBjb2RlLmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpO1xuICAgIGNvbnN0IHJvdyA9IGN1cnNvci5nZXRCdWZmZXJSb3coKTtcbiAgICBjb2RlID0gZ2V0Um93KGVkaXRvciwgcm93KTtcbiAgICBjdXJzb3JQb3NpdGlvbiA9IGN1cnNvci5nZXRCdWZmZXJDb2x1bW4oKTtcblxuICAgIC8vIFRPRE86IHVzZSBrZXJuZWwuY29tcGxldGUgdG8gZmluZCBhIHNlbGVjdGlvblxuICAgIGNvbnN0IGlkZW50aWZpZXJFbmQgPSBjb2RlID8gY29kZS5zbGljZShjdXJzb3JQb3NpdGlvbikuc2VhcmNoKC9cXFcvKSA6IC0xO1xuICAgIGlmIChpZGVudGlmaWVyRW5kICE9PSAtMSkge1xuICAgICAgY3Vyc29yUG9zaXRpb24gKz0gaWRlbnRpZmllckVuZDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gW2NvZGUsIGN1cnNvclBvc2l0aW9uXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlZ2V4U3RyaW5nKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHNjb3BlID0gZWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKTtcblxuICBjb25zdCB7IGNvbW1lbnRTdGFydFN0cmluZyB9ID0gZWRpdG9yLmdldENvbW1lbnRTdHJpbmdzKHNjb3BlKTtcblxuICBpZiAoIWNvbW1lbnRTdGFydFN0cmluZykge1xuICAgIGxvZyhcIkNlbGxNYW5hZ2VyOiBObyBjb21tZW50IHN0cmluZyBkZWZpbmVkIGluIHJvb3Qgc2NvcGVcIik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBlc2NhcGVkQ29tbWVudFN0YXJ0U3RyaW5nID0gZXNjYXBlU3RyaW5nUmVnZXhwKFxuICAgIGNvbW1lbnRTdGFydFN0cmluZy50cmltUmlnaHQoKVxuICApO1xuXG4gIGNvbnN0IHJlZ2V4U3RyaW5nID0gYCR7ZXNjYXBlZENvbW1lbnRTdGFydFN0cmluZ30oJSV8ICUlfCA8Y29kZWNlbGw+fCBJblxcW1swLTkgXSpcXF06PylgO1xuXG4gIHJldHVybiByZWdleFN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEJyZWFrcG9pbnRzKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgYnJlYWtwb2ludHMgPSBbXTtcblxuICBjb25zdCByZWdleFN0cmluZyA9IGdldFJlZ2V4U3RyaW5nKGVkaXRvcik7XG4gIGlmIChyZWdleFN0cmluZykge1xuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFN0cmluZywgXCJnXCIpO1xuICAgIGJ1ZmZlci5zY2FuKHJlZ2V4LCAoeyByYW5nZSB9KSA9PiB7XG4gICAgICBicmVha3BvaW50cy5wdXNoKHJhbmdlLnN0YXJ0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGJyZWFrcG9pbnRzLnB1c2goYnVmZmVyLmdldEVuZFBvc2l0aW9uKCkpO1xuXG4gIGxvZyhcIkNlbGxNYW5hZ2VyOiBCcmVha3BvaW50czpcIiwgYnJlYWtwb2ludHMpO1xuXG4gIHJldHVybiBicmVha3BvaW50cztcbn1cblxuZnVuY3Rpb24gZ2V0Q3VycmVudENvZGVDZWxsKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgbGV0IHN0YXJ0ID0gbmV3IFBvaW50KDAsIDApO1xuICBsZXQgZW5kID0gYnVmZmVyLmdldEVuZFBvc2l0aW9uKCk7XG4gIGNvbnN0IHJlZ2V4U3RyaW5nID0gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yKTtcblxuICBpZiAoIXJlZ2V4U3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBSYW5nZShzdGFydCwgZW5kKTtcbiAgfVxuXG4gIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFN0cmluZyk7XG4gIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpO1xuXG4gIHdoaWxlIChjdXJzb3Iucm93IDwgZW5kLnJvdyAmJiBpc0NvbW1lbnQoZWRpdG9yLCBjdXJzb3IpKSB7XG4gICAgY3Vyc29yLnJvdyArPSAxO1xuICAgIGN1cnNvci5jb2x1bW4gPSAwO1xuICB9XG5cbiAgaWYgKGN1cnNvci5yb3cgPiAwKSB7XG4gICAgYnVmZmVyLmJhY2t3YXJkc1NjYW5JblJhbmdlKFxuICAgICAgcmVnZXgsXG4gICAgICBuZXcgUmFuZ2Uoc3RhcnQsIGN1cnNvciksXG4gICAgICAoeyByYW5nZSB9KSA9PiB7XG4gICAgICAgIHN0YXJ0ID0gbmV3IFBvaW50KHJhbmdlLnN0YXJ0LnJvdyArIDEsIDApO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBidWZmZXIuc2NhbkluUmFuZ2UocmVnZXgsIG5ldyBSYW5nZShjdXJzb3IsIGVuZCksICh7IHJhbmdlIH0pID0+IHtcbiAgICBlbmQgPSByYW5nZS5zdGFydDtcbiAgfSk7XG5cbiAgbG9nKFwiQ2VsbE1hbmFnZXI6IENlbGwgW3N0YXJ0LCBlbmRdOlwiLCBbc3RhcnQsIGVuZF0sIFwiY3Vyc29yOlwiLCBjdXJzb3IpO1xuXG4gIHJldHVybiBuZXcgUmFuZ2Uoc3RhcnQsIGVuZCk7XG59XG5cbmZ1bmN0aW9uIGlzRW1iZWRkZWRDb2RlKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgcmVmZXJlbmNlU2NvcGU6IHN0cmluZyxcbiAgcm93OiBudW1iZXJcbikge1xuICBjb25zdCBzY29wZXMgPSBlZGl0b3JcbiAgICAuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24obmV3IFBvaW50KHJvdywgMCkpXG4gICAgLmdldFNjb3Blc0FycmF5KCk7XG4gIHJldHVybiBfLmluY2x1ZGVzKHNjb3BlcywgcmVmZXJlbmNlU2NvcGUpO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50RmVuY2VkQ29kZUJsb2NrKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgeyByb3c6IGJ1ZmZlckVuZFJvdyB9ID0gYnVmZmVyLmdldEVuZFBvc2l0aW9uKCk7XG5cbiAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCk7XG4gIGxldCBzdGFydCA9IGN1cnNvci5yb3c7XG4gIGxldCBlbmQgPSBjdXJzb3Iucm93O1xuICBjb25zdCBzY29wZSA9IGdldEVtYmVkZGVkU2NvcGUoZWRpdG9yLCBjdXJzb3IpO1xuICBpZiAoIXNjb3BlKSByZXR1cm4gZ2V0Q3VycmVudENvZGVDZWxsKGVkaXRvcik7XG4gIHdoaWxlIChzdGFydCA+IDAgJiYgaXNFbWJlZGRlZENvZGUoZWRpdG9yLCBzY29wZSwgc3RhcnQgLSAxKSkge1xuICAgIHN0YXJ0IC09IDE7XG4gIH1cblxuICB3aGlsZSAoZW5kIDwgYnVmZmVyRW5kUm93ICYmIGlzRW1iZWRkZWRDb2RlKGVkaXRvciwgc2NvcGUsIGVuZCArIDEpKSB7XG4gICAgZW5kICs9IDE7XG4gIH1cblxuICByZXR1cm4gbmV3IFJhbmdlKFtzdGFydCwgMF0sIFtlbmQsIDk5OTk5OTldKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEN1cnJlbnRDZWxsKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGlmIChpc011bHRpbGFuZ3VhZ2VHcmFtbWFyKGVkaXRvci5nZXRHcmFtbWFyKCkpKSB7XG4gICAgcmV0dXJuIGdldEN1cnJlbnRGZW5jZWRDb2RlQmxvY2soZWRpdG9yKTtcbiAgfVxuICByZXR1cm4gZ2V0Q3VycmVudENvZGVDZWxsKGVkaXRvcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDZWxscyhcbiAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gIGJyZWFrcG9pbnRzOiBBcnJheTxhdG9tJFBvaW50PiA9IFtdXG4pIHtcbiAgaWYgKGJyZWFrcG9pbnRzLmxlbmd0aCAhPT0gMCkge1xuICAgIGJyZWFrcG9pbnRzLnNvcnQoKGEsIGIpID0+IGEuY29tcGFyZShiKSk7XG4gIH0gZWxzZSB7XG4gICAgYnJlYWtwb2ludHMgPSBnZXRCcmVha3BvaW50cyhlZGl0b3IpO1xuICB9XG4gIHJldHVybiBnZXRDZWxsc0ZvckJyZWFrUG9pbnRzKGJyZWFrcG9pbnRzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENlbGxzRm9yQnJlYWtQb2ludHMoYnJlYWtwb2ludHM6IEFycmF5PGF0b20kUG9pbnQ+KSB7XG4gIGxldCBzdGFydCA9IG5ldyBQb2ludCgwLCAwKTtcbiAgcmV0dXJuIF8ubWFwKGJyZWFrcG9pbnRzLCBlbmQgPT4ge1xuICAgIGNvbnN0IGNlbGwgPSBuZXcgUmFuZ2Uoc3RhcnQsIGVuZCk7XG4gICAgc3RhcnQgPSBuZXcgUG9pbnQoZW5kLnJvdyArIDEsIDApO1xuICAgIHJldHVybiBjZWxsO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1vdmVEb3duKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCByb3c6IG51bWJlcikge1xuICBjb25zdCBsYXN0Um93ID0gZWRpdG9yLmdldExhc3RCdWZmZXJSb3coKTtcblxuICBpZiAocm93ID49IGxhc3RSb3cpIHtcbiAgICBlZGl0b3IubW92ZVRvQm90dG9tKCk7XG4gICAgZWRpdG9yLmluc2VydE5ld2xpbmUoKTtcbiAgICByZXR1cm47XG4gIH1cblxuICB3aGlsZSAocm93IDwgbGFzdFJvdykge1xuICAgIHJvdyArPSAxO1xuICAgIGlmICghaXNCbGFuayhlZGl0b3IsIHJvdykpIGJyZWFrO1xuICB9XG5cbiAgZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKHtcbiAgICByb3csXG4gICAgY29sdW1uOiAwXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFByZWNlZGluZ0Jsb2NrKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgcm93OiBudW1iZXIsXG4gIGluZGVudExldmVsOiBudW1iZXJcbikge1xuICBsZXQgcHJldmlvdXNSb3cgPSByb3cgLSAxO1xuICB3aGlsZSAocHJldmlvdXNSb3cgPj0gMCkge1xuICAgIGNvbnN0IHByZXZpb3VzSW5kZW50TGV2ZWwgPSBlZGl0b3IuaW5kZW50YXRpb25Gb3JCdWZmZXJSb3cocHJldmlvdXNSb3cpO1xuICAgIGNvbnN0IHNhbWVJbmRlbnQgPSBwcmV2aW91c0luZGVudExldmVsIDw9IGluZGVudExldmVsO1xuICAgIGNvbnN0IGJsYW5rID0gaXNCbGFuayhlZGl0b3IsIHByZXZpb3VzUm93KTtcbiAgICBjb25zdCBpc0VuZCA9IGdldFJvdyhlZGl0b3IsIHByZXZpb3VzUm93KSA9PT0gXCJlbmRcIjtcblxuICAgIGlmIChpc0JsYW5rKGVkaXRvciwgcm93KSkge1xuICAgICAgcm93ID0gcHJldmlvdXNSb3c7XG4gICAgfVxuICAgIGlmIChzYW1lSW5kZW50ICYmICFibGFuayAmJiAhaXNFbmQpIHtcbiAgICAgIHJldHVybiBbZ2V0Um93cyhlZGl0b3IsIHByZXZpb3VzUm93LCByb3cpLCByb3ddO1xuICAgIH1cbiAgICBwcmV2aW91c1JvdyAtPSAxO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZENvZGVCbG9jayhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikge1xuICBjb25zdCBzZWxlY3RlZFRleHQgPSBnZXRTZWxlY3RlZFRleHQoZWRpdG9yKTtcblxuICBpZiAoc2VsZWN0ZWRUZXh0KSB7XG4gICAgY29uc3Qgc2VsZWN0ZWRSYW5nZSA9IGVkaXRvci5nZXRTZWxlY3RlZEJ1ZmZlclJhbmdlKCk7XG4gICAgbGV0IGVuZFJvdyA9IHNlbGVjdGVkUmFuZ2UuZW5kLnJvdztcbiAgICBpZiAoc2VsZWN0ZWRSYW5nZS5lbmQuY29sdW1uID09PSAwKSB7XG4gICAgICBlbmRSb3cgLT0gMTtcbiAgICB9XG4gICAgZW5kUm93ID0gZXNjYXBlQmxhbmtSb3dzKGVkaXRvciwgc2VsZWN0ZWRSYW5nZS5zdGFydC5yb3csIGVuZFJvdyk7XG4gICAgcmV0dXJuIFtzZWxlY3RlZFRleHQsIGVuZFJvd107XG4gIH1cblxuICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpO1xuXG4gIGNvbnN0IHJvdyA9IGN1cnNvci5nZXRCdWZmZXJSb3coKTtcbiAgbG9nKFwiZmluZENvZGVCbG9jazpcIiwgcm93KTtcblxuICBjb25zdCBpbmRlbnRMZXZlbCA9IGN1cnNvci5nZXRJbmRlbnRMZXZlbCgpO1xuICBsZXQgZm9sZGFibGUgPSBlZGl0b3IuaXNGb2xkYWJsZUF0QnVmZmVyUm93KHJvdyk7XG4gIGNvbnN0IGZvbGRSYW5nZSA9IGVkaXRvci5sYW5ndWFnZU1vZGUucm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KHJvdyk7XG4gIGlmICghZm9sZFJhbmdlIHx8IGZvbGRSYW5nZVswXSA9PSBudWxsIHx8IGZvbGRSYW5nZVsxXSA9PSBudWxsKSB7XG4gICAgZm9sZGFibGUgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChmb2xkYWJsZSkge1xuICAgIHJldHVybiBnZXRGb2xkQ29udGVudHMoZWRpdG9yLCByb3cpO1xuICB9XG4gIGlmIChpc0JsYW5rKGVkaXRvciwgcm93KSB8fCBnZXRSb3coZWRpdG9yLCByb3cpID09PSBcImVuZFwiKSB7XG4gICAgcmV0dXJuIGZpbmRQcmVjZWRpbmdCbG9jayhlZGl0b3IsIHJvdywgaW5kZW50TGV2ZWwpO1xuICB9XG4gIHJldHVybiBbZ2V0Um93KGVkaXRvciwgcm93KSwgcm93XTtcbn1cbiJdfQ==