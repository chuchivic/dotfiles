Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.provideStructure = provideStructure;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _lodashTrim = require('lodash/trim');

var _lodashTrim2 = _interopRequireDefault(_lodashTrim);

var _utils = require('./utils');

var _tokenizer = require('./tokenizer');

'use babel';

var STRING = _tokenizer.TokenType.STRING;
var NULL = _tokenizer.TokenType.NULL;
var SYMBOL = _tokenizer.TokenType.SYMBOL;
var NUMBER = _tokenizer.TokenType.NUMBER;
var BEGIN_OBJECT = _tokenizer.TokenType.BEGIN_OBJECT;
var END_OBJECT = _tokenizer.TokenType.END_OBJECT;
var BEGIN_ARRAY = _tokenizer.TokenType.BEGIN_ARRAY;
var END_ARRAY = _tokenizer.TokenType.END_ARRAY;
var END_LABEL = _tokenizer.TokenType.END_LABEL;
var COMMA = _tokenizer.TokenType.COMMA;

function intersectsWithToken(position, token) {
  var tRow = token.line - 1;
  var pRow = position.row;
  var tCol = token.col;
  var tLength = token.src.length;
  var pCol = position.column;

  if (token.type === STRING) {
    return tRow === pRow && tCol <= pCol && tCol + tLength - 1 > pCol; // attention to ""
  }
  return tRow === pRow && tCol <= pCol && tCol + tLength > pCol;
}

function isBetweenTokenType(position, firstToken, secondToken) {
  var pRow = position.row;
  var pCol = position.column;
  var fRow = firstToken.line - 1;
  var sRow = secondToken.line - 1;
  var fEnd = firstToken.col + firstToken.src.length - 1;
  var sStart = secondToken.col;

  // cursor position and the 2 tokens are on the same line
  if (pRow === fRow && pRow === sRow) {
    return pCol >= fEnd && pCol < sStart;
  }
  // cursor position is not on the same line as the 2 other tokens but is between them
  return pRow > fRow && pRow < sRow || // firstToken \n+ position \n+ secondToken
  pRow === fRow && pRow < sRow && pCol >= fEnd // fistToken position \n+ secondToken
   || pRow > fRow && pRow === sRow && pCol < sStart; // firstToken \n+ position secondToken
}

function consumeValue(tokens, container, position, posInfo, posInfoHolder) {
  var valueStartToken = tokens.next();

  function checkPosition() {
    if (!posInfoHolder.hasValue() && intersectsWithToken(position, valueStartToken)) {
      var info = posInfo.setValuePosition().setEditedToken(valueStartToken).setPreviousToken(tokens.peekPrevious()).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
  }

  switch (valueStartToken.type) {
    case STRING:
      container.push((0, _lodashTrim2['default'])(valueStartToken.src, '"'));
      checkPosition();
      break;
    case NULL:
      container.push(null);
      checkPosition();
      break;
    case SYMBOL:
      container.push(undefined);
      checkPosition();
      break;
    case NUMBER:
      container.push(Number(valueStartToken.src));
      checkPosition();
      break;
    case BEGIN_OBJECT:
      var object = {};
      consumeObject(object, tokens, position, posInfo, posInfoHolder);
      container.push(object);
      break;
    case BEGIN_ARRAY:
      var array = [];
      consumeArray(array, tokens, position, posInfo, posInfoHolder);
      container.push(array);
      break;
    default:
      break;
  }
  return posInfo;
}

function consumeKeyValuePair(object, tokens, position, posInfo, posInfoHolder) {
  if (tokens.hasNext() && tokens.peekNext().type === END_OBJECT) {
    if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.current(), tokens.peekNext())) {
      var info = posInfo.setKeyPosition().setPreviousToken(tokens.current()).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
    return;
  }

  if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.current(), tokens.peekNext())) {
    var info = posInfo.setKeyPosition().setPreviousToken(tokens.current()).setNextToken(tokens.peekNext()).toObject();
    posInfoHolder.set(info);
  }

  var keyToken = tokens.next();
  // First token is not a key, skip it.
  if (keyToken.type !== STRING && keyToken.type !== SYMBOL) {
    return;
  }

  if (!posInfoHolder.hasValue() && intersectsWithToken(position, keyToken)) {
    var info = posInfo.setKeyPosition().setPreviousToken(tokens.peekPrevious()).setEditedToken(keyToken).setNextToken(tokens.peekNext()).toObject();
    posInfoHolder.set(info);
  }

  var key = (0, _lodashTrim2['default'])(keyToken.src, '"');
  var separatorToken = tokens.next();
  if (separatorToken.type === END_LABEL) {
    var pathWithKey = posInfo.add(key);
    if (!posInfoHolder.hasValue() && isBetweenTokenType(position, separatorToken, tokens.peekNext())) {
      var info = pathWithKey.setValuePosition().setPreviousToken(separatorToken).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
    // Complete key-value pair
    var valContainer = [];
    consumeValue(tokens, valContainer, position, pathWithKey, posInfoHolder);
    var value = valContainer[0];

    object[key] = value;
  } else {
    // separator in place, value probably under editing
    object[key] = undefined;
  }
}

function consumeObject(object, tokens, position, posInfo, posInfoHolder) {
  while (tokens.hasNext()) {
    consumeKeyValuePair(object, tokens, position, posInfo, posInfoHolder);
    if (tokens.hasNext()) {
      var token = tokens.next();
      switch (token.type) {
        case END_OBJECT:
          return; // end of object
        case COMMA:
          break; // ',' read - nothing else to do
        default:
          tokens.previous(); // something else, go back
      }
    }
  }
}

function consumeArray(array, tokens, position, posInfo, posInfoHolder) {
  var index = 0;
  while (tokens.hasNext()) {
    if (tokens.hasNext()) {
      var token = tokens.next();
      if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.peekPrevious(), token)) {
        var info = posInfo.add(index).setValuePosition().setPreviousToken(tokens.peekPrevious()).setNextToken(token).toObject();
        posInfoHolder.set(info);
      }
      switch (token.type) {
        case END_ARRAY:
          return; // end of array
        default:
          tokens.previous(); // something else, go back
      }
    }

    var valContainer = [];
    consumeValue(tokens, valContainer, position, posInfo.add(index), posInfoHolder);
    var value = valContainer[0];

    array.push(value);
    index++;

    if (tokens.hasNext()) {
      var token = tokens.next();
      if (!posInfoHolder.hasValue() && isBetweenTokenType(position, token, tokens.peekNext())) {
        var info = posInfo.add(index).setValuePosition().setPreviousToken(token).setNextToken(tokens.peekNext()).toObject();
        posInfoHolder.set(info);
      }
      switch (token.type) {
        case END_ARRAY:
          return; // end of object
        case COMMA:
          break; // ',' read - nothing else to do
        default:
          tokens.previous(); // something else, go back
      }
    }
  }
}

function provideStructure(tokensArray, position) {
  var tokens = new _utils.ArrayTraverser(tokensArray);

  if (!tokens.hasNext()) {
    return { contents: null, positionInfo: null, tokens: tokensArray }; // no tokens
  }

  var posInfoHolder = new _utils.ValueHolder();
  var firstToken = tokens.next();
  if (firstToken.type === BEGIN_OBJECT) {
    var object = {};
    consumeObject(object, tokens, position, new _utils.PositionInfo(), posInfoHolder);
    return { contents: object, positionInfo: posInfoHolder.getOrElse(null), tokens: tokensArray };
  } else if (firstToken.type === BEGIN_ARRAY) {
    var array = [];
    consumeArray(array, tokens, position, new _utils.PositionInfo(), posInfoHolder);
    return { contents: array, positionInfo: posInfoHolder.getOrElse(null), tokens: tokensArray };
  }
  return { contents: null, positionInfo: null, tokens: tokensArray }; // don't bother with strings, numbers, etc. for now
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2F1dG9jb21wbGV0ZS1qc29uL3NyYy9zdHJ1Y3R1cmUtcHJvdmlkZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OzswQkFFaUIsYUFBYTs7OztxQkFDNEIsU0FBUzs7eUJBQ3pDLGFBQWE7O0FBSnZDLFdBQVcsQ0FBQTs7SUFNSCxNQUFNLHdCQUFOLE1BQU07SUFBRSxJQUFJLHdCQUFKLElBQUk7SUFBRSxNQUFNLHdCQUFOLE1BQU07SUFBRSxNQUFNLHdCQUFOLE1BQU07SUFBRSxZQUFZLHdCQUFaLFlBQVk7SUFBRSxVQUFVLHdCQUFWLFVBQVU7SUFBRSxXQUFXLHdCQUFYLFdBQVc7SUFBRSxTQUFTLHdCQUFULFNBQVM7SUFBRSxTQUFTLHdCQUFULFNBQVM7SUFBRSxLQUFLLHdCQUFMLEtBQUs7O0FBRXhHLFNBQVMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRTtBQUM1QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQTtBQUMzQixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFBO0FBQ3pCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUE7QUFDdEIsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUE7QUFDaEMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQTs7QUFFNUIsTUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtBQUN6QixXQUFPLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLEdBQUcsT0FBTyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUE7R0FDbEU7QUFDRCxTQUFPLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQTtDQUU5RDs7QUFFRCxTQUFT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RSxNQUFNLEVBQUUsUUFBUSxFQUFFLHlCQUFrQixFQUFFLGFBQWEsQ0FBQyxDQUFBO0FBQ3hFLFdBQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQTtHQUM3RjtBQUNELFNBQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFBO0NBQ25FIiwiZmlsZSI6Ii9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2F1dG9jb21wbGV0ZS1qc29uL3NyYy9zdHJ1Y3R1cmUtcHJvdmlkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJ1xuXG5pbXBvcnQgdHJpbSBmcm9tICdsb2Rhc2gvdHJpbSdcbmltcG9ydCB7IEFycmF5VHJhdmVyc2VyLCBQb3NpdGlvbkluZm8sIFZhbHVlSG9sZGVyIH0gZnJvbSAnLi91dGlscydcbmltcG9ydCB7IFRva2VuVHlwZSB9IGZyb20gJy4vdG9rZW5pemVyJ1xuXG5jb25zdCB7IFNUUklORywgTlVMTCwgU1lNQk9MLCBOVU1CRVIsIEJFR0lOX09CSkVDVCwgRU5EX09CSkVDVCwgQkVHSU5fQVJSQVksIEVORF9BUlJBWSwgRU5EX0xBQkVMLCBDT01NQSB9ID0gVG9rZW5UeXBlXG5cbmZ1bmN0aW9uIGludGVyc2VjdHNXaXRoVG9rZW4ocG9zaXRpb24sIHRva2VuKSB7XG4gIGNvbnN0IHRSb3cgPSB0b2tlbi5saW5lIC0gMVxuICBjb25zdCBwUm93ID0gcG9zaXRpb24ucm93XG4gIGNvbnN0IHRDb2wgPSB0b2tlbi5jb2xcbiAgY29uc3QgdExlbmd0aCA9IHRva2VuLnNyYy5sZW5ndGhcbiAgY29uc3QgcENvbCA9IHBvc2l0aW9uLmNvbHVtblxuXG4gIGlmICh0b2tlbi50eXBlID09PSBTVFJJTkcpIHtcbiAgICByZXR1cm4gdFJvdyA9PT0gcFJvdyAmJiB0Q29sIDw9IHBDb2wgJiYgdENvbCArIHRMZW5ndGggLSAxID4gcENvbCAvLyBhdHRlbnRpb24gdG8gXCJcIlxuICB9XG4gIHJldHVybiB0Um93ID09PSBwUm93ICYmIHRDb2wgPD0gcENvbCAmJiB0Q29sICsgdExlbmd0aCA+IHBDb2xcblxufVxuXG5mdW5jdGlvbiBpc0JldHdlZW5Ub2tlblR5cGUocG9zaXRpb24sIGZpcnN0VG9rZW4sIHNlY29uZFRva2VuKSB7XG4gIGNvbnN0IHBSb3cgPSBwb3NpdGlvbi5yb3dcbiAgY29uc3QgcENvbCA9IHBvc2l0aW9uLmNvbHVtblxuICBjb25zdCBmUm93ID0gZmlyc3RUb2tlbi5saW5lIC0gMVxuICBjb25zdCBzUm93ID0gc2Vjb25kVG9rZW4ubGluZSAtIDFcbiAgY29uc3QgZkVuZCA9IGZpcnN0VG9rZW4uY29sICsgZmlyc3RUb2tlbi5zcmMubGVuZ3RoIC0gMVxuICBjb25zdCBzU3RhcnQgPSBzZWNvbmRUb2tlbi5jb2xcblxuICAvLyBjdXJzb3IgcG9zaXRpb24gYW5kIHRoZSAyIHRva2VucyBhcmUgb24gdGhlIHNhbWUgbGluZVxuICBpZiAocFJvdyA9PT0gZlJvdyAmJiBwUm93ID09PSBzUm93KSB7XG4gICAgcmV0dXJuIHBDb2wgPj0gZkVuZCAmJiBwQ29sIDwgc1N0YXJ0XG4gIH1cbiAgLy8gY3Vyc29yIHBvc2l0aW9uIGlzIG5vdCBvbiB0aGUgc2FtZSBsaW5lIGFzIHRoZSAyIG90aGVyIHRva2VucyBidXQgaXMgYmV0d2VlbiB0aGVtXG4gIHJldHVybiAocFJvdyA+IGZSb3cgJiYgcFJvdyA8IHNSb3cpIC8vIGZpcnN0VG9rZW4gXFxuKyBwb3NpdGlvbiBcXG4rIHNlY29uZFRva2VuXG4gICAgfHwgKHBSb3cgPT09IGZSb3cgJiYgcFJvdyA8IHNSb3cgJiYgcENvbCA+PSBmRW5kKSAvLyBmaXN0VG9rZW4gcG9zaXRpb24gXFxuKyBzZWNvbmRUb2tlblxuICAgIHx8IChwUm93ID4gZlJvdyAmJiBwUm93ID09PSBzUm93ICYmIHBDb2wgPCBzU3RhcnQpIC8vIGZpcnN0VG9rZW4gXFxuKyBwb3NpdGlvbiBzZWNvbmRUb2tlblxufVxuXG5mdW5jdGlvbiBjb25zdW1lVmFsdWUodG9rZW5zLCBjb250YWluZXIsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKSB7XG4gIGNvbnN0IHZhbHVlU3RhcnRUb2tlbiA9IHRva2Vucy5uZXh0KClcblxuICBmdW5jdGlvbiBjaGVja1Bvc2l0aW9uKCkge1xuICAgIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGludGVyc2VjdHNXaXRoVG9rZW4ocG9zaXRpb24sIHZhbHVlU3RhcnRUb2tlbikpIHtcbiAgICAgIGNvbnN0IGluZm8gPSBwb3NJbmZvLnNldFZhbHVlUG9zaXRpb24oKVxuICAgICAgICAuc2V0RWRpdGVkVG9rZW4odmFsdWVTdGFydFRva2VuKVxuICAgICAgICAuc2V0UHJldmlvdXNUb2tlbih0b2tlbnMucGVla1ByZXZpb3VzKCkpXG4gICAgICAgIC5zZXROZXh0VG9rZW4odG9rZW5zLnBlZWtOZXh0KCkpXG4gICAgICAgIC50b09iamVjdCgpXG4gICAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICAgIH1cbiAgfVxuXG4gIHN3aXRjaCAodmFsdWVTdGFydFRva2VuLnR5cGUpIHtcbiAgICBjYXNlIFNUUklORzpcbiAgICAgIGNvbnRhaW5lci5wdXNoKHRyaW0odmFsdWVTdGFydFRva2VuLnNyYywgJ1wiJykpXG4gICAgICBjaGVja1Bvc2l0aW9uKClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBOVUxMOlxuICAgICAgY29udGFpbmVyLnB1c2gobnVsbClcbiAgICAgIGNoZWNrUG9zaXRpb24oKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIFNZTUJPTDpcbiAgICAgIGNvbnRhaW5lci5wdXNoKHVuZGVmaW5lZClcbiAgICAgIGNoZWNrUG9zaXRpb24oKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIE5VTUJFUjpcbiAgICAgIGNvbnRhaW5lci5wdXNoKE51bWJlcih2YWx1ZVN0YXJ0VG9rZW4uc3JjKSlcbiAgICAgIGNoZWNrUG9zaXRpb24oKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEJFR0lOX09CSkVDVDpcbiAgICAgIGNvbnN0IG9iamVjdCA9IHt9XG4gICAgICBjb25zdW1lT2JqZWN0KG9iamVjdCwgdG9rZW5zLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcilcbiAgICAgIGNvbnRhaW5lci5wdXNoKG9iamVjdClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBCRUdJTl9BUlJBWTpcbiAgICAgIGNvbnN0IGFycmF5ID0gW11cbiAgICAgIGNvbnN1bWVBcnJheShhcnJheSwgdG9rZW5zLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcilcbiAgICAgIGNvbnRhaW5lci5wdXNoKGFycmF5KVxuICAgICAgYnJlYWtcbiAgICBkZWZhdWx0OiBicmVha1xuICB9XG4gIHJldHVybiBwb3NJbmZvXG59XG5cbmZ1bmN0aW9uIGNvbnN1bWVLZXlWYWx1ZVBhaXIob2JqZWN0LCB0b2tlbnMsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKSB7XG4gIGlmICh0b2tlbnMuaGFzTmV4dCgpICYmIHRva2Vucy5wZWVrTmV4dCgpLnR5cGUgPT09IEVORF9PQkpFQ1QpIHtcbiAgICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpc0JldHdlZW5Ub2tlblR5cGUocG9zaXRpb24sIHRva2Vucy5jdXJyZW50KCksIHRva2Vucy5wZWVrTmV4dCgpKSkge1xuICAgICAgY29uc3QgaW5mbyA9IHBvc0luZm8uc2V0S2V5UG9zaXRpb24oKVxuICAgICAgICAuc2V0UHJldmlvdXNUb2tlbih0b2tlbnMuY3VycmVudCgpKVxuICAgICAgICAuc2V0TmV4dFRva2VuKHRva2Vucy5wZWVrTmV4dCgpKVxuICAgICAgICAudG9PYmplY3QoKVxuICAgICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgICB9XG4gICAgcmV0dXJuXG4gIH1cblxuICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpc0JldHdlZW5Ub2tlblR5cGUocG9zaXRpb24sIHRva2Vucy5jdXJyZW50KCksIHRva2Vucy5wZWVrTmV4dCgpKSkge1xuICAgIGNvbnN0IGluZm8gPSBwb3NJbmZvLnNldEtleVBvc2l0aW9uKClcbiAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHRva2Vucy5jdXJyZW50KCkpXG4gICAgICAuc2V0TmV4dFRva2VuKHRva2Vucy5wZWVrTmV4dCgpKVxuICAgICAgLnRvT2JqZWN0KClcbiAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICB9XG5cbiAgY29uc3Qga2V5VG9rZW4gPSB0b2tlbnMubmV4dCgpXG4gIC8vIEZpcnN0IHRva2VuIGlzIG5vdCBhIGtleSwgc2tpcCBpdC5cbiAgaWYgKGtleVRva2VuLnR5cGUgIT09IFNUUklORyAmJiBrZXlUb2tlbi50eXBlICE9PSBTWU1CT0wpIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGludGVyc2VjdHNXaXRoVG9rZW4ocG9zaXRpb24sIGtleVRva2VuKSkge1xuICAgIGNvbnN0IGluZm8gPSBwb3NJbmZvLnNldEtleVBvc2l0aW9uKClcbiAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHRva2Vucy5wZWVrUHJldmlvdXMoKSlcbiAgICAgIC5zZXRFZGl0ZWRUb2tlbihrZXlUb2tlbilcbiAgICAgIC5zZXROZXh0VG9rZW4odG9rZW5zLnBlZWtOZXh0KCkpXG4gICAgICAudG9PYmplY3QoKVxuICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gIH1cblxuICBjb25zdCBrZXkgPSB0cmltKGtleVRva2VuLnNyYywgJ1wiJylcbiAgY29uc3Qgc2VwYXJhdG9yVG9rZW4gPSB0b2tlbnMubmV4dCgpXG4gIGlmIChzZXBhcmF0b3JUb2tlbi50eXBlID09PSBFTkRfTEFCRUwpIHtcbiAgICBjb25zdCBwYXRoV2l0aEtleSA9IHBvc0luZm8uYWRkKGtleSlcbiAgICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpc0JldHdlZW5Ub2tlblR5cGUocG9zaXRpb24sIHNlcGFyYXRvclRva2VuLCB0b2tlbnMucGVla05leHQoKSkpIHtcbiAgICAgIGNvbnN0IGluZm8gPSBwYXRoV2l0aEtleS5zZXRWYWx1ZVBvc2l0aW9uKClcbiAgICAgICAgLnNldFByZXZpb3VzVG9rZW4oc2VwYXJhdG9yVG9rZW4pXG4gICAgICAgIC5zZXROZXh0VG9rZW4odG9rZW5zLnBlZWtOZXh0KCkpXG4gICAgICAgIC50b09iamVjdCgpXG4gICAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICAgIH1cbiAgICAvLyBDb21wbGV0ZSBrZXktdmFsdWUgcGFpclxuICAgIGNvbnN0IHZhbENvbnRhaW5lciA9IFtdXG4gICAgY29uc3VtZVZhbHVlKHRva2VucywgdmFsQ29udGFpbmVyLCBwb3NpdGlvbiwgcGF0aFdpdGhLZXksIHBvc0luZm9Ib2xkZXIpXG4gICAgY29uc3QgW3ZhbHVlXSA9IHZhbENvbnRhaW5lclxuICAgIG9iamVjdFtrZXldID0gdmFsdWVcbiAgfSBlbHNlIHtcbiAgICAvLyBzZXBhcmF0b3IgaW4gcGxhY2UsIHZhbHVlIHByb2JhYmx5IHVuZGVyIGVkaXRpbmdcbiAgICBvYmplY3Rba2V5XSA9IHVuZGVmaW5lZFxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnN1bWVPYmplY3Qob2JqZWN0LCB0b2tlbnMsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKSB7XG4gIHdoaWxlICh0b2tlbnMuaGFzTmV4dCgpKSB7XG4gICAgY29uc3VtZUtleVZhbHVlUGFpcihvYmplY3QsIHRva2VucywgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpXG4gICAgaWYgKHRva2Vucy5oYXNOZXh0KCkpIHtcbiAgICAgIGNvbnN0IHRva2VuID0gdG9rZW5zLm5leHQoKVxuICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7XG4gICAgICAgIGNhc2UgRU5EX09CSkVDVDogcmV0dXJuIC8vIGVuZCBvZiBvYmplY3RcbiAgICAgICAgY2FzZSBDT01NQTogYnJlYWsgLy8gJywnIHJlYWQgLSBub3RoaW5nIGVsc2UgdG8gZG9cbiAgICAgICAgZGVmYXVsdDogdG9rZW5zLnByZXZpb3VzKCkgLy8gc29tZXRoaW5nIGVsc2UsIGdvIGJhY2tcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gY29uc3VtZUFycmF5KGFycmF5LCB0b2tlbnMsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKSB7XG4gIGxldCBpbmRleCA9IDBcbiAgd2hpbGUgKHRva2Vucy5oYXNOZXh0KCkpIHtcbiAgICBpZiAodG9rZW5zLmhhc05leHQoKSkge1xuICAgICAgY29uc3QgdG9rZW4gPSB0b2tlbnMubmV4dCgpXG4gICAgICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpc0JldHdlZW5Ub2tlblR5cGUocG9zaXRpb24sIHRva2Vucy5wZWVrUHJldmlvdXMoKSwgdG9rZW4pKSB7XG4gICAgICAgIGNvbnN0IGluZm8gPSBwb3NJbmZvLmFkZChpbmRleClcbiAgICAgICAgICAuc2V0VmFsdWVQb3NpdGlvbigpXG4gICAgICAgICAgLnNldFByZXZpb3VzVG9rZW4odG9rZW5zLnBlZWtQcmV2aW91cygpKVxuICAgICAgICAgIC5zZXROZXh0VG9rZW4odG9rZW4pXG4gICAgICAgICAgLnRvT2JqZWN0KClcbiAgICAgICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgICAgIH1cbiAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkge1xuICAgICAgICBjYXNlIEVORF9BUlJBWTogcmV0dXJuIC8vIGVuZCBvZiBhcnJheVxuICAgICAgICBkZWZhdWx0OiB0b2tlbnMucHJldmlvdXMoKSAvLyBzb21ldGhpbmcgZWxzZSwgZ28gYmFja1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHZhbENvbnRhaW5lciA9IFtdXG4gICAgY29uc3VtZVZhbHVlKHRva2VucywgdmFsQ29udGFpbmVyLCBwb3NpdGlvbiwgcG9zSW5mby5hZGQoaW5kZXgpLCBwb3NJbmZvSG9sZGVyKVxuICAgIGNvbnN0IFt2YWx1ZV0gPSB2YWxDb250YWluZXJcbiAgICBhcnJheS5wdXNoKHZhbHVlKVxuICAgIGluZGV4KytcblxuICAgIGlmICh0b2tlbnMuaGFzTmV4dCgpKSB7XG4gICAgICBjb25zdCB0b2tlbiA9IHRva2Vucy5uZXh0KClcbiAgICAgIGlmICghcG9zSW5mb0hvbGRlci5oYXNWYWx1ZSgpICYmIGlzQmV0d2VlblRva2VuVHlwZShwb3NpdGlvbiwgdG9rZW4sIHRva2Vucy5wZWVrTmV4dCgpKSkge1xuICAgICAgICBjb25zdCBpbmZvID0gcG9zSW5mby5hZGQoaW5kZXgpXG4gICAgICAgICAgLnNldFZhbHVlUG9zaXRpb24oKVxuICAgICAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHRva2VuKVxuICAgICAgICAgIC5zZXROZXh0VG9rZW4odG9rZW5zLnBlZWtOZXh0KCkpXG4gICAgICAgICAgLnRvT2JqZWN0KClcbiAgICAgICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgICAgIH1cbiAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkge1xuICAgICAgICBjYXNlIEVORF9BUlJBWTogcmV0dXJuIC8vIGVuZCBvZiBvYmplY3RcbiAgICAgICAgY2FzZSBDT01NQTogYnJlYWsgLy8gJywnIHJlYWQgLSBub3RoaW5nIGVsc2UgdG8gZG9cbiAgICAgICAgZGVmYXVsdDogdG9rZW5zLnByZXZpb3VzKCkgLy8gc29tZXRoaW5nIGVsc2UsIGdvIGJhY2tcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVTdHJ1Y3R1cmUodG9rZW5zQXJyYXksIHBvc2l0aW9uKSB7XG4gIGNvbnN0IHRva2VucyA9IG5ldyBBcnJheVRyYXZlcnNlcih0b2tlbnNBcnJheSlcblxuICBpZiAoIXRva2Vucy5oYXNOZXh0KCkpIHtcbiAgICByZXR1cm4geyBjb250ZW50czogbnVsbCwgcG9zaXRpb25JbmZvOiBudWxsLCB0b2tlbnM6IHRva2Vuc0FycmF5IH0gLy8gbm8gdG9rZW5zXG4gIH1cblxuICBjb25zdCBwb3NJbmZvSG9sZGVyID0gbmV3IFZhbHVlSG9sZGVyKClcbiAgY29uc3QgZmlyc3RUb2tlbiA9IHRva2Vucy5uZXh0KClcbiAgaWYgKGZpcnN0VG9rZW4udHlwZSA9PT0gQkVHSU5fT0JKRUNUKSB7XG4gICAgY29uc3Qgb2JqZWN0ID0ge31cbiAgICBjb25zdW1lT2JqZWN0KG9iamVjdCwgdG9rZW5zLCBwb3NpdGlvbiwgbmV3IFBvc2l0aW9uSW5mbygpLCBwb3NJbmZvSG9sZGVyKVxuICAgIHJldHVybiB7IGNvbnRlbnRzOiBvYmplY3QsIHBvc2l0aW9uSW5mbzogcG9zSW5mb0hvbGRlci5nZXRPckVsc2UobnVsbCksIHRva2VuczogdG9rZW5zQXJyYXkgfVxuICB9IGVsc2UgaWYgKGZpcnN0VG9rZW4udHlwZSA9PT0gQkVHSU5fQVJSQVkpIHtcbiAgICBjb25zdCBhcnJheSA9IFtdXG4gICAgY29uc3VtZUFycmF5KGFycmF5LCB0b2tlbnMsIHBvc2l0aW9uLCBuZXcgUG9zaXRpb25JbmZvKCksIHBvc0luZm9Ib2xkZXIpXG4gICAgcmV0dXJuIHsgY29udGVudHM6IGFycmF5LCBwb3NpdGlvbkluZm86IHBvc0luZm9Ib2xkZXIuZ2V0T3JFbHNlKG51bGwpLCB0b2tlbnM6IHRva2Vuc0FycmF5IH1cbiAgfVxuICByZXR1cm4geyBjb250ZW50czogbnVsbCwgcG9zaXRpb25JbmZvOiBudWxsLCB0b2tlbnM6IHRva2Vuc0FycmF5IH0gLy8gZG9uJ3QgYm90aGVyIHdpdGggc3RyaW5ncywgbnVtYmVycywgZXRjLiBmb3Igbm93XG59XG4iXX0=