
"use strict";

var dynamicRequire = require("./dynamicRequire");
var fs = require("fs");
var lessSyntax = require("postcss-less");
var path = require("path");
var postcss = require("postcss");
var scssSyntax = require("postcss-scss");
var sugarssSyntax = require("sugarss");

var postcssProcessor = postcss();

module.exports = function (stylelint /*: stylelint$internalApi*/
) /*: Promise<?Object>*/{
  var options /*: {
              code?: string,
              codeFilename?: string,
              filePath?: string,
              codeProcessors?: Array<Function>,
              syntax?: stylelint$syntaxes,
              customSyntax?: string
              }*/ = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  var cached /*: ?postcss$result*/ = stylelint._postcssResultCache.get(options.filePath);
  if (cached) return Promise.resolve(cached);

  var getCode = undefined;
  if (options.code !== undefined) {
    getCode = Promise.resolve(options.code);
  } else if (options.filePath) {
    getCode = readFile(options.filePath);
  }

  if (!getCode) {
    throw new Error("code or filePath required");
  }

  return getCode.then(function (code) {
    var customSyntax = stylelint._options.customSyntax;
    var syntax = stylelint._options.syntax;

    if (customSyntax) {
      try {
        syntax = dynamicRequire(customSyntax);
      } catch (e) {
        throw new Error("Cannot resolve custom syntax module " + customSyntax);
      }
    } else {
      var fileExtension = path.extname(options.filePath || "");
      if (syntax === "scss" || !syntax && fileExtension === ".scss") {
        syntax = scssSyntax;
      } else if (syntax === "less" || !syntax && fileExtension === ".less") {
        syntax = lessSyntax;
      } else if (syntax === "sugarss" || !syntax && fileExtension === ".sss") {
        syntax = sugarssSyntax;
      } else if (syntax) {
        throw new Error("You must use a valid syntax option, either: scss, less or sugarss");
      }
    }

    var postcssOptions /*: postcss$options*/ = {};

    postcssOptions.from = options.filePath;

    /*
    * PostCSS allows for syntaxes that only contain a parser, however,
    * it then expects the syntax to be set as the `parser` option rather than `syntax.
    */
    if (syntax && !syntax.stringify) {
      postcssOptions.parser = syntax;
    } else {
      postcssOptions.syntax = syntax;
    }

    var source = options.code ? options.codeFilename : options.filePath;
    var preProcessedCode = code;
    if (options.codeProcessors) {
      options.codeProcessors.forEach(function (codeProcessor) {
        preProcessedCode = codeProcessor(preProcessedCode, source);
      });
    }

    return postcssProcessor.process(preProcessedCode, postcssOptions);
  }).then(function (postcssResult) {
    stylelint._postcssResultCache.set(options.filePath, postcssResult);
    return postcssResult;
  });
};

function readFile(filePath /*: string*/) /*: Promise<string>*/{
  return new Promise(function (resolve, reject) {
    fs.readFile(filePath, "utf8", function (err, content) {
      if (err) {
        return reject(err);
      }
      resolve(content);
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2xpbnRlci1zdHlsZWxpbnQvbm9kZV9tb2R1bGVzL3N0eWxlbGludC9saWIvZ2V0UG9zdGNzc1Jlc3VsdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsWUFBWSxDQUFDOztBQUViLElBQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ25ELElBQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6QixJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDM0MsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzdCLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNuQyxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDM0MsSUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDOztBQUV6QyxJQUFNLGdCQUFnQixHQUFHLE9BQU8sRUFBRSxDQUFDOztBQUVuQyxNQUFNLENBQUMsT0FBTyxHQUFHLFVBQ2YsU0FBUzt3QkFDYztBQUN2QixNQUFNLE9BQU87Ozs7Ozs7b0JBUVgsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDOztBQUV6RSxNQUFNLE1BQU0seUJBQXlCLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQ3BFLE9BQU8sQ0FBQyxRQUFRLENBQ2pCLENBQUM7QUFDRixNQUFJLE1BQU0sRUFBRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7O0FBRTNDLE1BQUksT0FBTyxZQUFBLENBQUM7QUFDWixNQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssU0FBUyxFQUFF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LENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsVUFBQyxHQUFHLEVBQUUsT0FBTyxFQUFLO0FBQzlDLFVBQUksR0FBRyxFQUFFO0FBQ1AsZUFBTyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDcEI7QUFDRCxhQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDbEIsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0oiLCJmaWxlIjoiL2hvbWUvamVzdXMvLmF0b20vcGFja2FnZXMvbGludGVyLXN0eWxlbGludC9ub2RlX21vZHVsZXMvc3R5bGVsaW50L2xpYi9nZXRQb3N0Y3NzUmVzdWx0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBkeW5hbWljUmVxdWlyZSA9IHJlcXVpcmUoXCIuL2R5bmFtaWNSZXF1aXJlXCIpO1xuY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XG5jb25zdCBsZXNzU3ludGF4ID0gcmVxdWlyZShcInBvc3Rjc3MtbGVzc1wiKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHBvc3Rjc3MgPSByZXF1aXJlKFwicG9zdGNzc1wiKTtcbmNvbnN0IHNjc3NTeW50YXggPSByZXF1aXJlKFwicG9zdGNzcy1zY3NzXCIpO1xuY29uc3Qgc3VnYXJzc1N5bnRheCA9IHJlcXVpcmUoXCJzdWdhcnNzXCIpO1xuXG5jb25zdCBwb3N0Y3NzUHJvY2Vzc29yID0gcG9zdGNzcygpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFxuICBzdHlsZWxpbnQgLyo6IHN0eWxlbGludCRpbnRlcm5hbEFwaSovXG4pIC8qOiBQcm9taXNlPD9PYmplY3Q+Ki8ge1xuICBjb25zdCBvcHRpb25zIC8qOiB7XG4gICAgY29kZT86IHN0cmluZyxcbiAgICBjb2RlRmlsZW5hbWU/OiBzdHJpbmcsXG4gICAgZmlsZVBhdGg/OiBzdHJpbmcsXG4gICAgY29kZVByb2Nlc3NvcnM/OiBBcnJheTxGdW5jdGlvbj4sXG4gICAgc3ludGF4Pzogc3R5bGVsaW50JHN5bnRheGVzLFxuICAgIGN1c3RvbVN5bnRheD86IHN0cmluZ1xuICB9Ki8gPVxuICAgIGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDoge307XG5cbiAgY29uc3QgY2FjaGVkIC8qOiA/cG9zdGNzcyRyZXN1bHQqLyA9IHN0eWxlbGludC5fcG9zdGNzc1Jlc3VsdENhY2hlLmdldChcbiAgICBvcHRpb25zLmZpbGVQYXRoXG4gICk7XG4gIGlmIChjYWNoZWQpIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2FjaGVkKTtcblxuICBsZXQgZ2V0Q29kZTtcbiAgaWYgKG9wdGlvbnMuY29kZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgZ2V0Q29kZSA9IFByb21pc2UucmVzb2x2ZShvcHRpb25zLmNvZGUpO1xuICB9IGVsc2UgaWYgKG9wdGlvbnMuZmlsZVBhdGgpIHtcbiAgICBnZXRDb2RlID0gcmVhZEZpbGUob3B0aW9ucy5maWxlUGF0aCk7XG4gIH1cblxuICBpZiAoIWdldENvZGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJjb2RlIG9yIGZpbGVQYXRoIHJlcXVpcmVkXCIpO1xuICB9XG5cbiAgcmV0dXJuIGdldENvZGVcbiAgICAudGhlbihjb2RlID0+IHtcbiAgICAgIGNvbnN0IGN1c3RvbVN5bnRheCA9IHN0eWxlbGludC5fb3B0aW9ucy5jdXN0b21TeW50YXg7XG4gICAgICBsZXQgc3ludGF4ID0gc3R5bGVsaW50Ll9vcHRpb25zLnN5bnRheDtcblxuICAgICAgaWYgKGN1c3RvbVN5bnRheCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHN5bnRheCA9IGR5bmFtaWNSZXF1aXJlKGN1c3RvbVN5bnRheCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQ2Fubm90IHJlc29sdmUgY3VzdG9tIHN5bnRheCBtb2R1bGUgJHtjdXN0b21TeW50YXh9YFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGZpbGVFeHRlbnNpb24gPSBwYXRoLmV4dG5hbWUob3B0aW9ucy5maWxlUGF0aCB8fCBcIlwiKTtcbiAgICAgICAgaWYgKHN5bnRheCA9PT0gXCJzY3NzXCIgfHwgKCFzeW50YXggJiYgZmlsZUV4dGVuc2lvbiA9PT0gXCIuc2Nzc1wiKSkge1xuICAgICAgICAgIHN5bnRheCA9IHNjc3NTeW50YXg7XG4gICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgc3ludGF4ID09PSBcImxlc3NcIiB8fFxuICAgICAgICAgICghc3ludGF4ICYmIGZpbGVFeHRlbnNpb24gPT09IFwiLmxlc3NcIilcbiAgICAgICAgKSB7XG4gICAgICAgICAgc3ludGF4ID0gbGVzc1N5bnRheDtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICBzeW50YXggPT09IFwic3VnYXJzc1wiIHx8XG4gICAgICAgICAgKCFzeW50YXggJiYgZmlsZUV4dGVuc2lvbiA9PT0gXCIuc3NzXCIpXG4gICAgICAgICkge1xuICAgICAgICAgIHN5bnRheCA9IHN1Z2Fyc3NTeW50YXg7XG4gICAgICAgIH0gZWxzZSBpZiAoc3ludGF4KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgXCJZb3UgbXVzdCB1c2UgYSB2YWxpZCBzeW50YXggb3B0aW9uLCBlaXRoZXI6IHNjc3MsIGxlc3Mgb3Igc3VnYXJzc1wiXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBwb3N0Y3NzT3B0aW9ucyAvKjogcG9zdGNzcyRvcHRpb25zKi8gPSB7fTtcblxuICAgICAgcG9zdGNzc09wdGlvbnMuZnJvbSA9IG9wdGlvbnMuZmlsZVBhdGg7XG5cbiAgICAgIC8qXG4gICAgICogUG9zdENTUyBhbGxvd3MgZm9yIHN5bnRheGVzIHRoYXQgb25seSBjb250YWluIGEgcGFyc2VyLCBob3dldmVyLFxuICAgICAqIGl0IHRoZW4gZXhwZWN0cyB0aGUgc3ludGF4IHRvIGJlIHNldCBhcyB0aGUgYHBhcnNlcmAgb3B0aW9uIHJhdGhlciB0aGFuIGBzeW50YXguXG4gICAgICovXG4gICAgICBpZiAoc3ludGF4ICYmICFzeW50YXguc3RyaW5naWZ5KSB7XG4gICAgICAgIHBvc3Rjc3NPcHRpb25zLnBhcnNlciA9IHN5bnRheDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBvc3Rjc3NPcHRpb25zLnN5bnRheCA9IHN5bnRheDtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc291cmNlID0gb3B0aW9ucy5jb2RlID8gb3B0aW9ucy5jb2RlRmlsZW5hbWUgOiBvcHRpb25zLmZpbGVQYXRoO1xuICAgICAgbGV0IHByZVByb2Nlc3NlZENvZGUgPSBjb2RlO1xuICAgICAgaWYgKG9wdGlvbnMuY29kZVByb2Nlc3NvcnMpIHtcbiAgICAgICAgb3B0aW9ucy5jb2RlUHJvY2Vzc29ycy5mb3JFYWNoKGNvZGVQcm9jZXNzb3IgPT4ge1xuICAgICAgICAgIHByZVByb2Nlc3NlZENvZGUgPSBjb2RlUHJvY2Vzc29yKHByZVByb2Nlc3NlZENvZGUsIHNvdXJjZSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcG9zdGNzc1Byb2Nlc3Nvci5wcm9jZXNzKHByZVByb2Nlc3NlZENvZGUsIHBvc3Rjc3NPcHRpb25zKTtcbiAgICB9KVxuICAgIC50aGVuKHBvc3Rjc3NSZXN1bHQgPT4ge1xuICAgICAgc3R5bGVsaW50Ll9wb3N0Y3NzUmVzdWx0Q2FjaGUuc2V0KG9wdGlvbnMuZmlsZVBhdGgsIHBvc3Rjc3NSZXN1bHQpO1xuICAgICAgcmV0dXJuIHBvc3Rjc3NSZXN1bHQ7XG4gICAgfSk7XG59O1xuXG5mdW5jdGlvbiByZWFkRmlsZShmaWxlUGF0aCAvKjogc3RyaW5nKi8pIC8qOiBQcm9taXNlPHN0cmluZz4qLyB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZnMucmVhZEZpbGUoZmlsZVBhdGgsIFwidXRmOFwiLCAoZXJyLCBjb250ZW50KSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICAgIHJlc29sdmUoY29udGVudCk7XG4gICAgfSk7XG4gIH0pO1xufVxuIl19