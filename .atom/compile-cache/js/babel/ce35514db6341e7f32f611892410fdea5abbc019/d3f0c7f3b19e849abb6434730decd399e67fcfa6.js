
"use strict";
var _ = require("lodash");

var COMMAND_PREFIX = "stylelint-";
var disableCommand = COMMAND_PREFIX + "disable";
var enableCommand = COMMAND_PREFIX + "enable";
var disableLineCommand = COMMAND_PREFIX + "disable-line";
var disableNextLineCommand = COMMAND_PREFIX + "disable-next-line";
var ALL_RULES = "all";

/*:: type disabledRangeObject = {
  [ruleName: string]: Array<{
    start: number,
    end?: number,
  }>
}*/

// Run it like a plugin ...
module.exports = function (root, /*: Object*/
result /*: Object*/
) /*: postcss$result*/{
  result.stylelint = result.stylelint || {};

  // Most of the functions below work via side effects mutating
  // this object
  var disabledRanges /*: disabledRangeObject*/ = {
    all: []
  };
  result.stylelint.disabledRanges = disabledRanges;
  root.walkComments(checkComment);

  return result;

  function processDisableLineCommand(comment /*: postcss$comment*/) {
    getCommandRules(disableLineCommand, comment.text).forEach(function (ruleName) {
      disableLine(comment.source.start.line, ruleName, comment);
    });
  }

  function processDisableNextLineCommand(comment /*: postcss$comment*/) {
    getCommandRules(disableNextLineCommand, comment.text).forEach(function (ruleName) {
      disableLine(comment.source.start.line + 1, ruleName, comment);
    });
  }

  function disableLine(line, /*: number*/
  ruleName, /*: string*/
  comment /*: postcss$comment*/
  ) {
    if (ruleIsDisabled(ALL_RULES)) {
      throw comment.error("All rules have already been disabled", { plugin: "stylelint" });
    }
    if (ruleIsDisabled(ruleName)) {
      throw comment.error("\"" + ruleName + "\" has already been disabled", { plugin: "stylelint" });
    }
    if (ruleName === ALL_RULES) {
      Object.keys(disabledRanges).forEach(function (disabledRuleName) {
        startDisabledRange(line, disabledRuleName);
        endDisabledRange(line, disabledRuleName);
      });
    } else {
      startDisabledRange(line, ruleName);
      endDisabledRange(line, ruleName);
    }
  }

  function processDisableCommand(comment /*: postcss$comment*/) {
    getCommandRules(disableCommand, comment.text).forEach(function (ruleToDisable) {
      if (ruleToDisable === ALL_RULES) {
        if (ruleIsDisabled(ALL_RULES)) {
          throw comment.error("All rules have already been disabled", { plugin: "stylelint" });
        }
        Object.keys(disabledRanges).forEach(function (ruleName) {
          startDisabledRange(comment.source.start.line, ruleName);
        });
        return;
      }

      if (ruleIsDisabled(ruleToDisable)) {
        throw comment.error("\"" + ruleToDisable + "\" has already been disabled", { plugin: "stylelint" });
      }
      startDisabledRange(comment.source.start.line, ruleToDisable);
    });
  }

  function processEnableCommand(comment /*: postcss$comment*/) {
    getCommandRules(enableCommand, comment.text).forEach(function (ruleToEnable) {
      if (ruleToEnable === ALL_RULES) {
        if (_.values(disabledRanges).every(function (ranges) {
          return _.isEmpty(ranges) || !!_.last(ranges.end);
        })) {
          throw comment.error("No rules have been disabled", { plugin: "stylelint" });
        }
        Object.keys(disabledRanges).forEach(function (ruleName) {
          if (!_.get(_.last(disabledRanges[ruleName]), "end")) {
            endDisabledRange(comment.source.end.line, ruleName);
          }
        });
        return;
      }

      if (ruleIsDisabled(ALL_RULES) && disabledRanges[ruleToEnable] === undefined) {
        // Get a starting point from the where all rules were disabled
        if (!disabledRanges[ruleToEnable]) {
          disabledRanges[ruleToEnable] = _.cloneDeep(disabledRanges.all);
        } else {
          disabledRanges[ruleToEnable].push(_.clone(_.last(disabledRanges[ALL_RULES])));
        }
        endDisabledRange(comment.source.end.line, ruleToEnable);
        return;
      }

      if (ruleIsDisabled(ruleToEnable)) {
        endDisabledRange(comment.source.end.line, ruleToEnable);
        return;
      }

      throw comment.error("\"" + ruleToEnable + "\" has not been disabled", { plugin: "stylelint" });
    });
  }

  function checkComment(comment /*: postcss$comment*/) {
    var text = comment.text;

    // Ignore comments that are not relevant commands

    if (text.indexOf(COMMAND_PREFIX) !== 0) {
      return result;
    }

    if (text.indexOf(disableLineCommand) === 0) {
      processDisableLineCommand(comment);
    } else if (text.indexOf(disableNextLineCommand) === 0) {
      processDisableNextLineCommand(comment);
    } else if (text.indexOf(disableCommand) === 0) {
      processDisableCommand(comment);
    } else if (text.indexOf(enableCommand) === 0) {
      processEnableCommand(comment);
    }
  }

  function getCommandRules(command, /*: string*/
  fullText /*: string*/
  ) /*: Array<string>*/{
    var rules = _.compact(fullText.slice(command.length).split(",")).map(function (r) {
      return r.trim();
    });
    if (_.isEmpty(rules)) {
      return [ALL_RULES];
    }
    return rules;
  }

  function startDisabledRange(line, /*: number*/ruleName /*: string*/) {
    var rangeObj = { start: line };
    ensureRuleRanges(ruleName);
    disabledRanges[ruleName].push(rangeObj);
  }

  function endDisabledRange(line, /*: number*/ruleName /*: string*/) {
    var lastRangeForRule = _.last(disabledRanges[ruleName]);
    if (!lastRangeForRule) {
      return;
    }
    // Add an `end` prop to the last range of that rule
    lastRangeForRule.end = line;
  }

  function ensureRuleRanges(ruleName /*: string*/) {
    if (!disabledRanges[ruleName]) {
      disabledRanges[ruleName] = _.cloneDeep(disabledRanges.all);
    }
  }

  function ruleIsDisabled(ruleName /*: string*/) /*: boolean*/{
    if (disabledRanges[ruleName] === undefined) return false;
    if (_.last(disabledRanges[ruleName]) === undefined) return false;
    if (_.get(_.last(disabledRanges[ruleName]), "end") === undefined) return true;
    return false;
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2xpbnRlci1zdHlsZWxpbnQvbm9kZV9tb2R1bGVzL3N0eWxlbGludC9saWIvYXNzaWduRGlzYWJsZWRSYW5nZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLFlBQVksQ0FBQTtBQUNaLElBQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTs7QUFFM0IsSUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFBO0FBQ25DLElBQU0sY0FBYyxHQUFHLGNBQWMsR0FBRyxTQUFTLENBQUE7QUFDakQsSUFBTSxhQUFhLEdBQUcsY0FBYyxHQUFHLFFBQVEsQ0FBQTtBQUMvQyxJQUFNLGtCQUFrQixHQUFHLGNBQWMsR0FBRyxjQUFjLENBQUE7QUFDMUQsSUFBTSxzQkFBc0IsR0FBRyxjQUFjLEdBQUcsbUJBQW1CLENBQUE7QUFDbkUsSUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFBOzs7Ozs7Ozs7O0FBVXZCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFDZixJQUFJO0FBQ0osTUFBTTtzQkFDYztBQUNwQixRQUFNLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFBOzs7O0FBSXpDLE1BQU0sY0FBYyw2QkFBNEI7QUFDOUMsT0FBRyxFQUFFLEVBQUU7R0FDUixDQUFBO0FBQ0QsUUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFBO0FBQ2hELE1BQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUE7O0FBRS9CLFNBQU8sTUFBTSxDQUFBOztBQUViLFdBQVMseUJBQXlCLENBQUMsT0FBTyx3QkFBdUI7QUFDL0QsbUJBQWUsQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsUUFBUSxFQUFJO0FBQ3BFLGlCQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFB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Q0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEtBQUssU0FBUyxFQUFFLE9BQU8sSUFBSSxDQUFBO0FBQzdFLFdBQU8sS0FBSyxDQUFBO0dBQ2I7Q0FDRixDQUFBIiwiZmlsZSI6Ii9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL2xpbnRlci1zdHlsZWxpbnQvbm9kZV9tb2R1bGVzL3N0eWxlbGludC9saWIvYXNzaWduRGlzYWJsZWRSYW5nZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXCJ1c2Ugc3RyaWN0XCJcbmNvbnN0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpXG5cbmNvbnN0IENPTU1BTkRfUFJFRklYID0gXCJzdHlsZWxpbnQtXCJcbmNvbnN0IGRpc2FibGVDb21tYW5kID0gQ09NTUFORF9QUkVGSVggKyBcImRpc2FibGVcIlxuY29uc3QgZW5hYmxlQ29tbWFuZCA9IENPTU1BTkRfUFJFRklYICsgXCJlbmFibGVcIlxuY29uc3QgZGlzYWJsZUxpbmVDb21tYW5kID0gQ09NTUFORF9QUkVGSVggKyBcImRpc2FibGUtbGluZVwiXG5jb25zdCBkaXNhYmxlTmV4dExpbmVDb21tYW5kID0gQ09NTUFORF9QUkVGSVggKyBcImRpc2FibGUtbmV4dC1saW5lXCJcbmNvbnN0IEFMTF9SVUxFUyA9IFwiYWxsXCJcblxuLyo6OiB0eXBlIGRpc2FibGVkUmFuZ2VPYmplY3QgPSB7XG4gIFtydWxlTmFtZTogc3RyaW5nXTogQXJyYXk8e1xuICAgIHN0YXJ0OiBudW1iZXIsXG4gICAgZW5kPzogbnVtYmVyLFxuICB9PlxufSovXG5cbi8vIFJ1biBpdCBsaWtlIGEgcGx1Z2luIC4uLlxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoXG4gIHJvb3QvKjogT2JqZWN0Ki8sXG4gIHJlc3VsdC8qOiBPYmplY3QqL1xuKS8qOiBwb3N0Y3NzJHJlc3VsdCovIHtcbiAgcmVzdWx0LnN0eWxlbGludCA9IHJlc3VsdC5zdHlsZWxpbnQgfHwge31cblxuICAvLyBNb3N0IG9mIHRoZSBmdW5jdGlvbnMgYmVsb3cgd29yayB2aWEgc2lkZSBlZmZlY3RzIG11dGF0aW5nXG4gIC8vIHRoaXMgb2JqZWN0XG4gIGNvbnN0IGRpc2FibGVkUmFuZ2VzLyo6IGRpc2FibGVkUmFuZ2VPYmplY3QqLyA9IHtcbiAgICBhbGw6IFtdLFxuICB9XG4gIHJlc3VsdC5zdHlsZWxpbnQuZGlzYWJsZWRSYW5nZXMgPSBkaXNhYmxlZFJhbmdlc1xuICByb290LndhbGtDb21tZW50cyhjaGVja0NvbW1lbnQpXG5cbiAgcmV0dXJuIHJlc3VsdFxuXG4gIGZ1bmN0aW9uIHByb2Nlc3NEaXNhYmxlTGluZUNvbW1hbmQoY29tbWVudC8qOiBwb3N0Y3NzJGNvbW1lbnQqLykge1xuICAgIGdldENvbW1hbmRSdWxlcyhkaXNhYmxlTGluZUNvbW1hbmQsIGNvbW1lbnQudGV4dCkuZm9yRWFjaChydWxlTmFtZSA9PiB7XG4gICAgICBkaXNhYmxlTGluZShjb21tZW50LnNvdXJjZS5zdGFydC5saW5lLCBydWxlTmFtZSwgY29tbWVudClcbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gcHJvY2Vzc0Rpc2FibGVOZXh0TGluZUNvbW1hbmQoY29tbWVudC8qOiBwb3N0Y3NzJGNvbW1lbnQqLykge1xuICAgIGdldENvbW1hbmRSdWxlcyhkaXNhYmxlTmV4dExpbmVDb21tYW5kLCBjb21tZW50LnRleHQpLmZvckVhY2gocnVsZU5hbWUgPT4ge1xuICAgICAgZGlzYWJsZUxpbmUoY29tbWVudC5zb3VyY2Uuc3RhcnQubGluZSArIDEsIHJ1bGVOYW1lLCBjb21tZW50KVxuICAgIH0pXG4gIH1cblxuICBmdW5jdGlvbiBkaXNhYmxlTGluZShcbiAgICBsaW5lLyo6IG51bWJlciovLFxuICAgIHJ1bGVOYW1lLyo6IHN0cmluZyovLFxuICAgIGNvbW1lbnQvKjogcG9zdGNzcyRjb21tZW50Ki9cbiAgKSB7XG4gICAgaWYgKHJ1bGVJc0Rpc2FibGVkKEFMTF9SVUxFUykpIHtcbiAgICAgIHRocm93IGNvbW1lbnQuZXJyb3IoXCJBbGwgcnVsZXMgaGF2ZSBhbHJlYWR5IGJlZW4gZGlzYWJsZWRcIiwgeyBwbHVnaW46IFwic3R5bGVsaW50XCIgfSlcbiAgICB9XG4gICAgaWYgKHJ1bGVJc0Rpc2FibGVkKHJ1bGVOYW1lKSkge1xuICAgICAgdGhyb3cgY29tbWVudC5lcnJvcihgXCIke3J1bGVOYW1lfVwiIGhhcyBhbHJlYWR5IGJlZW4gZGlzYWJsZWRgLCB7IHBsdWdpbjogXCJzdHlsZWxpbnRcIiB9KVxuICAgIH1cbiAgICBpZiAocnVsZU5hbWUgPT09IEFMTF9SVUxFUykge1xuICAgICAgT2JqZWN0LmtleXMoZGlzYWJsZWRSYW5nZXMpLmZvckVhY2goZGlzYWJsZWRSdWxlTmFtZSA9PiB7XG4gICAgICAgIHN0YXJ0RGlzYWJsZWRSYW5nZShsaW5lLCBkaXNhYmxlZFJ1bGVOYW1lKVxuICAgICAgICBlbmREaXNhYmxlZFJhbmdlKGxpbmUsIGRpc2FibGVkUnVsZU5hbWUpXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBzdGFydERpc2FibGVkUmFuZ2UobGluZSwgcnVsZU5hbWUpXG4gICAgICBlbmREaXNhYmxlZFJhbmdlKGxpbmUsIHJ1bGVOYW1lKVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHByb2Nlc3NEaXNhYmxlQ29tbWFuZChjb21tZW50Lyo6IHBvc3Rjc3MkY29tbWVudCovKSB7XG4gICAgZ2V0Q29tbWFuZFJ1bGVzKGRpc2FibGVDb21tYW5kLCBjb21tZW50LnRleHQpLmZvckVhY2gocnVsZVRvRGlzYWJsZSA9PiB7XG4gICAgICBpZiAocnVsZVRvRGlzYWJsZSA9PT0gQUxMX1JVTEVTKSB7XG4gICAgICAgIGlmIChydWxlSXNEaXNhYmxlZChBTExfUlVMRVMpKSB7XG4gICAgICAgICAgdGhyb3cgY29tbWVudC5lcnJvcihcIkFsbCBydWxlcyBoYXZlIGFscmVhZHkgYmVlbiBkaXNhYmxlZFwiLCB7IHBsdWdpbjogXCJzdHlsZWxpbnRcIiB9KVxuICAgICAgICB9XG4gICAgICAgIE9iamVjdC5rZXlzKGRpc2FibGVkUmFuZ2VzKS5mb3JFYWNoKHJ1bGVOYW1lID0+IHtcbiAgICAgICAgICBzdGFydERpc2FibGVkUmFuZ2UoY29tbWVudC5zb3VyY2Uuc3RhcnQubGluZSwgcnVsZU5hbWUpXG4gICAgICAgIH0pXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBpZiAocnVsZUlzRGlzYWJsZWQocnVsZVRvRGlzYWJsZSkpIHtcbiAgICAgICAgdGhyb3cgY29tbWVudC5lcnJvcihgXCIke3J1bGVUb0Rpc2FibGV9XCIgaGFzIGFscmVhZHkgYmVlbiBkaXNhYmxlZGAsIHsgcGx1Z2luOiBcInN0eWxlbGludFwiIH0pXG4gICAgICB9XG4gICAgICBzdGFydERpc2FibGVkUmFuZ2UoY29tbWVudC5zb3VyY2Uuc3RhcnQubGluZSwgcnVsZVRvRGlzYWJsZSlcbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gcHJvY2Vzc0VuYWJsZUNvbW1hbmQoY29tbWVudC8qOiBwb3N0Y3NzJGNvbW1lbnQqLykge1xuICAgIGdldENvbW1hbmRSdWxlcyhlbmFibGVDb21tYW5kLCBjb21tZW50LnRleHQpLmZvckVhY2gocnVsZVRvRW5hYmxlID0+IHtcbiAgICAgIGlmIChydWxlVG9FbmFibGUgPT09IEFMTF9SVUxFUykge1xuICAgICAgICBpZiAoXy52YWx1ZXMoZGlzYWJsZWRSYW5nZXMpLmV2ZXJ5KHJhbmdlcyA9PiBfLmlzRW1wdHkocmFuZ2VzKSB8fCAhIV8ubGFzdChyYW5nZXMuZW5kKSkpIHtcbiAgICAgICAgICB0aHJvdyBjb21tZW50LmVycm9yKFwiTm8gcnVsZXMgaGF2ZSBiZWVuIGRpc2FibGVkXCIsIHsgcGx1Z2luOiBcInN0eWxlbGludFwiIH0pXG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmtleXMoZGlzYWJsZWRSYW5nZXMpLmZvckVhY2gocnVsZU5hbWUgPT4ge1xuICAgICAgICAgIGlmICghXy5nZXQoXy5sYXN0KGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSksIFwiZW5kXCIpKSB7XG4gICAgICAgICAgICBlbmREaXNhYmxlZFJhbmdlKGNvbW1lbnQuc291cmNlLmVuZC5saW5lLCBydWxlTmFtZSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBpZiAocnVsZUlzRGlzYWJsZWQoQUxMX1JVTEVTKSAmJiBkaXNhYmxlZFJhbmdlc1tydWxlVG9FbmFibGVdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gR2V0IGEgc3RhcnRpbmcgcG9pbnQgZnJvbSB0aGUgd2hlcmUgYWxsIHJ1bGVzIHdlcmUgZGlzYWJsZWRcbiAgICAgICAgaWYgKCFkaXNhYmxlZFJhbmdlc1tydWxlVG9FbmFibGVdKSB7XG4gICAgICAgICAgZGlzYWJsZWRSYW5nZXNbcnVsZVRvRW5hYmxlXSA9IF8uY2xvbmVEZWVwKGRpc2FibGVkUmFuZ2VzLmFsbClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkaXNhYmxlZFJhbmdlc1tydWxlVG9FbmFibGVdLnB1c2goXy5jbG9uZShfLmxhc3QoZGlzYWJsZWRSYW5nZXNbQUxMX1JVTEVTXSkpKVxuICAgICAgICB9XG4gICAgICAgIGVuZERpc2FibGVkUmFuZ2UoY29tbWVudC5zb3VyY2UuZW5kLmxpbmUsIHJ1bGVUb0VuYWJsZSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGlmIChydWxlSXNEaXNhYmxlZChydWxlVG9FbmFibGUpKSB7XG4gICAgICAgIGVuZERpc2FibGVkUmFuZ2UoY29tbWVudC5zb3VyY2UuZW5kLmxpbmUsIHJ1bGVUb0VuYWJsZSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIHRocm93IGNvbW1lbnQuZXJyb3IoYFwiJHtydWxlVG9FbmFibGV9XCIgaGFzIG5vdCBiZWVuIGRpc2FibGVkYCwgeyBwbHVnaW46IFwic3R5bGVsaW50XCIgfSlcbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gY2hlY2tDb21tZW50KGNvbW1lbnQvKjogcG9zdGNzcyRjb21tZW50Ki8pIHtcbiAgICBjb25zdCB0ZXh0ID0gY29tbWVudC50ZXh0XG5cbiAgICAvLyBJZ25vcmUgY29tbWVudHMgdGhhdCBhcmUgbm90IHJlbGV2YW50IGNvbW1hbmRzXG5cbiAgICBpZiAodGV4dC5pbmRleE9mKENPTU1BTkRfUFJFRklYKSAhPT0gMCkge1xuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH1cblxuICAgIGlmICh0ZXh0LmluZGV4T2YoZGlzYWJsZUxpbmVDb21tYW5kKSA9PT0gMCkge1xuICAgICAgcHJvY2Vzc0Rpc2FibGVMaW5lQ29tbWFuZChjb21tZW50KVxuICAgIH0gZWxzZSBpZiAodGV4dC5pbmRleE9mKGRpc2FibGVOZXh0TGluZUNvbW1hbmQpID09PSAwKSB7XG4gICAgICBwcm9jZXNzRGlzYWJsZU5leHRMaW5lQ29tbWFuZChjb21tZW50KVxuICAgIH0gZWxzZSBpZiAodGV4dC5pbmRleE9mKGRpc2FibGVDb21tYW5kKSA9PT0gMCkge1xuICAgICAgcHJvY2Vzc0Rpc2FibGVDb21tYW5kKGNvbW1lbnQpXG4gICAgfSBlbHNlIGlmICh0ZXh0LmluZGV4T2YoZW5hYmxlQ29tbWFuZCkgPT09IDApIHtcbiAgICAgIHByb2Nlc3NFbmFibGVDb21tYW5kKGNvbW1lbnQpXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZ2V0Q29tbWFuZFJ1bGVzKFxuICAgIGNvbW1hbmQvKjogc3RyaW5nKi8sXG4gICAgZnVsbFRleHQvKjogc3RyaW5nKi9cbiAgKS8qOiBBcnJheTxzdHJpbmc+Ki8ge1xuICAgIGNvbnN0IHJ1bGVzID0gXy5jb21wYWN0KGZ1bGxUZXh0LnNsaWNlKGNvbW1hbmQubGVuZ3RoKS5zcGxpdChcIixcIikpLm1hcChyID0+IHIudHJpbSgpKVxuICAgIGlmIChfLmlzRW1wdHkocnVsZXMpKSB7XG4gICAgICByZXR1cm4gW0FMTF9SVUxFU11cbiAgICB9XG4gICAgcmV0dXJuIHJ1bGVzXG4gIH1cblxuICBmdW5jdGlvbiBzdGFydERpc2FibGVkUmFuZ2UobGluZS8qOiBudW1iZXIqLywgcnVsZU5hbWUvKjogc3RyaW5nKi8pIHtcbiAgICBjb25zdCByYW5nZU9iaiA9IHsgc3RhcnQ6IGxpbmUgfVxuICAgIGVuc3VyZVJ1bGVSYW5nZXMocnVsZU5hbWUpXG4gICAgZGlzYWJsZWRSYW5nZXNbcnVsZU5hbWVdLnB1c2gocmFuZ2VPYmopXG4gIH1cblxuICBmdW5jdGlvbiBlbmREaXNhYmxlZFJhbmdlKGxpbmUvKjogbnVtYmVyKi8sIHJ1bGVOYW1lLyo6IHN0cmluZyovKSB7XG4gICAgY29uc3QgbGFzdFJhbmdlRm9yUnVsZSA9IF8ubGFzdChkaXNhYmxlZFJhbmdlc1tydWxlTmFtZV0pXG4gICAgaWYgKCFsYXN0UmFuZ2VGb3JSdWxlKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgLy8gQWRkIGFuIGBlbmRgIHByb3AgdG8gdGhlIGxhc3QgcmFuZ2Ugb2YgdGhhdCBydWxlXG4gICAgbGFzdFJhbmdlRm9yUnVsZS5lbmQgPSBsaW5lXG4gIH1cblxuICBmdW5jdGlvbiBlbnN1cmVSdWxlUmFuZ2VzKHJ1bGVOYW1lLyo6IHN0cmluZyovKSB7XG4gICAgaWYgKCFkaXNhYmxlZFJhbmdlc1tydWxlTmFtZV0pIHtcbiAgICAgIGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSA9IF8uY2xvbmVEZWVwKGRpc2FibGVkUmFuZ2VzLmFsbClcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBydWxlSXNEaXNhYmxlZChydWxlTmFtZS8qOiBzdHJpbmcqLykvKjogYm9vbGVhbiovIHtcbiAgICBpZiAoZGlzYWJsZWRSYW5nZXNbcnVsZU5hbWVdID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZVxuICAgIGlmIChfLmxhc3QoZGlzYWJsZWRSYW5nZXNbcnVsZU5hbWVdKSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2VcbiAgICBpZiAoXy5nZXQoXy5sYXN0KGRpc2FibGVkUmFuZ2VzW3J1bGVOYW1lXSksIFwiZW5kXCIpID09PSB1bmRlZmluZWQpIHJldHVybiB0cnVlXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cbiJdfQ==