Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.normalizeString = normalizeString;
exports.getRow = getRow;
exports.getTextInRange = getTextInRange;
exports.getRows = getRows;
exports.getSelectedText = getSelectedText;
exports.isComment = isComment;
exports.isBlank = isBlank;
exports.escapeBlankRows = escapeBlankRows;
exports.getFoldRange = getFoldRange;
exports.getFoldContents = getFoldContents;
exports.getCodeToInspect = getCodeToInspect;
exports.getRegexString = getRegexString;
exports.getBreakpoints = getBreakpoints;
exports.getCurrentCell = getCurrentCell;
exports.getCells = getCells;
exports.getCellsForBreakPoints = getCellsForBreakPoints;
exports.moveDown = moveDown;
exports.findPrecedingBlock = findPrecedingBlock;
exports.findCodeBlock = findCodeBlock;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _atom = require("atom");

var _escapeStringRegexp = require("escape-string-regexp");

var _escapeStringRegexp2 = _interopRequireDefault(_escapeStringRegexp);

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var _utils = require("./utils");

function normalizeString(code) {
  if (code) {
    return code.replace(/\r\n|\r/g, "\n").trim();
  }
  return null;
}

function getRow(editor, row) {
  return normalizeString(editor.lineTextForBufferRow(row));
}

function getTextInRange(editor, start, end) {
  var code = editor.getTextInBufferRange([start, end]);
  return normalizeString(code);
}

function getRows(editor, startRow, endRow) {
  var code = editor.getTextInBufferRange({
    start: {
      row: startRow,
      column: 0
    },
    end: {
      row: endRow,
      column: 9999999
    }
  });
  return normalizeString(code);
}

function getSelectedText(editor) {
  return normalizeString(editor.getSelectedText());
}

function isComment(editor, position) {
  var scope = editor.scopeDescriptorForBufferPosition(position);
  var scopeString = scope.getScopeChain();
  return _lodash2["default"].includes(scopeString, "comment.line");
}

function isBlank(editor, row) {
  return editor.getBuffer().isRowBlank(row) || editor.isBufferRowCommented(row);
}

function escapeBlankRows(editor, startRow, endRow) {
  while (endRow > startRow) {
    if (!isBlank(editor, endRow)) break;
    endRow -= 1;
  }
  return endRow;
}

function getFoldRange(editor, row) {
  var range = (0, _utils.rowRangeForCodeFoldAtBufferRow)(editor, row);
  if (!range) return;
  if (range[1] < editor.getLastBufferRow() && getRow(editor, range[1] + 1) === "end") {
    range[1] += 1;
  }
  (0, _utils.log)("getFoldRange:", range);
  return range;
}

function getFoldContents(editor, row) {
  var range = getFoldRange(editor, row);
  if (!range) return;
  return [getRows(editor, range[0], range[1]), range[1]];
}

function getCodeToInspect(editor) {
  var selectedText = getSelectedText(editor);
  var code = undefined;
  var cursorPosition = undefined;
  if (selectedText) {
    code = selectedText;
    cursorPosition = code.length;
  } else {
    var cursor = editor.getLastCursor();
    var row = cursor.getBufferRow();
    code = getRow(editor, row);
    cursorPosition = cursor.getBufferColumn();

    // TODO: use kernel.complete to find a selection
    var identifierEnd = code ? code.slice(cursorPosition).search(/\W/) : -1;
    if (identifierEnd !== -1) {
      cursorPosition += identifierEnd;
    }
  }

  return [code, cursorPosition];
}

function getRegexString(editor) {
  var scope = editor.getRootScopeDescriptor();

  var _editor$getCommentStrings = editor.getCommentStrings(scope);

  var commentStartString = _editor$getCommentStrings.commentStartString;

  if (!commentStartString) {
    (0, _utils.log)("CellManager: No comment string defined in root scope");
    return null;
  }

  var escapedCommentStartString = (0, _escapeStringRegexp2["default"])(commentStartString.trimRight());

  var regexString = escapedCommentStartString + "(%%| %%| <codecell>| In[[0-9 ]*]:?)";

  return regexString;
}

function getBreakpoints(editor) {
  var buffer = editor.getBuffer();
  var breakpoints = [];

  var regexString = getRegexString(editor);
  if (regexString) {
    var regex = new RegExp(regexString, "g");
    buffer.scan(regex, function (_ref) {
      var range = _ref.range;

      breakpoints.push(range.start);
    });
  }

  breakpoints.push(buffer.getEndPosition());

  (0, _utils.log)("CellManager: Breakpoints:", breakpoints);

  return breakpoints;
}

function getCurrentCodeCell(editor) {
  var buffer = editor.getBuffer();
  var start = new _atom.Point(0, 0);
  var end = buffer.getEndPosition();
  var regexString = getRegexString(editor);

  if (!regexString) {
    return new _atom.Range(start, end);
  }

  var regex = new RegExp(regexString);
  var cursor = editor.getCursorBufferPosition();

  while (cursor.row < end.row && isComment(editor, cursor)) {
    cursor.row += 1;
    cursor.column = 0;
  }

  if (cursor.row > 0) {
    buffer.backwardsScanInRange(regex, new _atom.Range(start, cursor), function (_ref2) {
      var range = _ref2.range;

      start = new _atom.Point(range.start.row + 1, 0);
    });
  }

  buffer.scanInRange(regex, new _atom.Range(cursor, end), function (_ref3) {
    var range = _ref3.range;

    end = range.start;
  });

  (0, _utils.log)("CellManager: Cell [start, end]:", [start, end], "cursor:", cursor);

  return new _atom.Range(start, end);
}

function isEmbeddedCode(editor, referenceScope, row) {
  var scopes = editor.scopeDescriptorForBufferPosition(new _atom.Point(row, 0)).getScopesArray();
  return _lodash2["default"].includes(scopes, referenceScope);
}

function getCurrentFencedCodeBlock(editor) {
  var buffer = editor.getBuffer();

  var _buffer$getEndPosition = buffer.getEndPosition();

  var bufferEndRow = _buffer$getEndPosition.row;

  var cursor = editor.getCursorBufferPosition();
  var start = cursor.row;
  var end = cursor.row;
  var scope = (0, _utils.getEmbeddedScope)(editor, cursor);
  if (!scope) return getCurrentCodeCell(editor);
  while (start > 0 && isEmbeddedCode(editor, scope, start - 1)) {
    start -= 1;
  }

  while (end < bufferEndRow && isEmbeddedCode(editor, scope, end + 1)) {
    end += 1;
  }

  return new _atom.Range([start, 0], [end, 9999999]);
}

function getCurrentCell(editor) {
  if ((0, _utils.isMultilanguageGrammar)(editor.getGrammar())) {
    return getCurrentFencedCodeBlock(editor);
  }
  return getCurrentCodeCell(editor);
}

function getCells(editor) {
  var breakpoints = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];

  if (breakpoints.length !== 0) {
    breakpoints.sort(function (a, b) {
      return a.compare(b);
    });
  } else {
    breakpoints = getBreakpoints(editor);
  }
  return getCellsForBreakPoints(breakpoints);
}

function getCellsForBreakPoints(breakpoints) {
  var start = new _atom.Point(0, 0);
  return _lodash2["default"].map(breakpoints, function (end) {
    var cell = new _atom.Range(start, end);
    start = new _atom.Point(end.row + 1, 0);
    return cell;
  });
}

function moveDown(editor, row) {
  var lastRow = editor.getLastBufferRow();

  if (row >= lastRow) {
    editor.moveToBottom();
    editor.insertNewline();
    return;
  }

  while (row < lastRow) {
    row += 1;
    if (!isBlank(editor, row)) break;
  }

  editor.setCursorBufferPosition({
    row: row,
    column: 0
  });
}

function findPrecedingBlock(editor, row, indentLevel) {
  var previousRow = row - 1;
  while (previousRow >= 0) {
    var previousIndentLevel = editor.indentationForBufferRow(previousRow);
    var sameIndent = previousIndentLevel <= indentLevel;
    var blank = isBlank(editor, previousRow);
    var isEnd = getRow(editor, previousRow) === "end";

    if (isBlank(editor, row)) {
      row = previousRow;
    }
    if (sameIndent && !blank && !isEnd) {
      return [getRows(editor, previousRow, row), row];
    }
    previousRow -= 1;
  }
  return null;
}

function findCodeBlock(editor) {
  var selectedText = getSelectedText(editor);

  if (selectedText) {
    var selectedRange = editor.getSelectedBufferRange();
    var endRow = selectedRange.end.row;
    if (selectedRange.end.column === 0) {
      endRow -= 1;
    }
    endRow = escapeBlankRows(editor, selectedRange.start.row, endRow);
    return [selectedText, endRow];
  }

  var cursor = editor.getLastCursor();

  var row = cursor.getBufferRow();
  (0, _utils.log)("findCodeBlock:", row);

  var indentLevel = cursor.getIndentLevel();
  var foldable = editor.isFoldableAtBufferRow(row);
  var foldRange = (0, _utils.rowRangeForCodeFoldAtBufferRow)(editor, row);
  if (!foldRange || foldRange[0] == null || foldRange[1] == null) {
    foldable = false;
  }

  if (foldable) {
    return getFoldContents(editor, row);
  }
  if (isBlank(editor, row) || getRow(editor, row) === "end") {
    return findPrecedingBlock(editor, row, indentLevel);
  }
  return [getRow(editor, row), row];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2plc3VzLy5hdG9tL3BhY2thZ2VzL0h5ZHJvZ2VuL2xpYi9jb2RlLW1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFFNkIsTUFBTTs7a0NBRUosc0JBQXNCOzs7O3NCQUN2QyxRQUFROzs7O3FCQUVKLFNBQVM7Ozs7cUJBTXBCLFNBQVM7O0FBRVQsU0FBUyxlQUFlLENBQUMsSUFBYSxFQUFFO0FBQzdDLE1BQUksSUFBSSxFQUFFO0FBQ1IsV0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztHQUM5QztBQUNELFNBQU8sSUFBSSxDQUFDO0NBQ2I7O0FBRU0sU0FBUyxNQUFNLENBQUMsTUFBdUIsRUFBRSxHQUFXLEVBQUU7QUFDM0QsU0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Q0FDMUQ7O0FBRU0sU0FBUyxjQUFjLENBQzVCLE1BQXVCLEVBQ3ZCLEtBQWlCLEVBQ2pCLEdBQWUsRUFDZjtBQUNBLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELFNBQU8sZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQzlCOztBQUVNLFNBQVMsT0FBTyxDQUNyQixNQUF1QixFQUN2QixRQUFnQixFQUNoQixNQUFjLEVBQ2Q7QUFDQSxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUM7QUFDdkMsU0FBSyxFQUFFO0FBQ0wsU0FBRyxFQUFFLFFBQVE7QUFDYixZQUFNLEVBQUUsQ0FBQztLQUNWO0FBQ0QsT0FBRyxFQUFFO0FBQ0gsU0FBRyxFQUFFLE1BQU07QUFDWCxZQUFNLEVBQUUsT0FBTztLQUNoQjtHQUNGLENBQUMsQ0FBQztBQUNILFNBQU8sZUFBZSxDQUFDLElBQUks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QUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNqRCxNQUFNLFNBQVMsR0FBRywyQ0FBK0IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzlELE1BQUksQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxFQUFFO0FBQzlELFlBQVEsR0FBRyxLQUFLLENBQUM7R0FDbEI7O0FBRUQsTUFBSSxRQUFRLEVBQUU7QUFDWixXQUFPLGVBQWUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7R0FDckM7QUFDRCxNQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsS0FBSyxLQUFLLEVBQUU7QUFDekQsV0FBTyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0dBQ3JEO0FBQ0QsU0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Q0FDbkMiLCJmaWxlIjoiL2hvbWUvamVzdXMvLmF0b20vcGFja2FnZXMvSHlkcm9nZW4vbGliL2NvZGUtbWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmltcG9ydCB7IFBvaW50LCBSYW5nZSB9IGZyb20gXCJhdG9tXCI7XG5cbmltcG9ydCBlc2NhcGVTdHJpbmdSZWdleHAgZnJvbSBcImVzY2FwZS1zdHJpbmctcmVnZXhwXCI7XG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5cbmltcG9ydCBzdG9yZSBmcm9tIFwiLi9zdG9yZVwiO1xuaW1wb3J0IHtcbiAgbG9nLFxuICBpc011bHRpbGFuZ3VhZ2VHcmFtbWFyLFxuICBnZXRFbWJlZGRlZFNjb3BlLFxuICByb3dSYW5nZUZvckNvZGVGb2xkQXRCdWZmZXJSb3dcbn0gZnJvbSBcIi4vdXRpbHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVN0cmluZyhjb2RlOiA/c3RyaW5nKSB7XG4gIGlmIChjb2RlKSB7XG4gICAgcmV0dXJuIGNvZGUucmVwbGFjZSgvXFxyXFxufFxcci9nLCBcIlxcblwiKS50cmltKCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSb3coZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIHJldHVybiBub3JtYWxpemVTdHJpbmcoZWRpdG9yLmxpbmVUZXh0Rm9yQnVmZmVyUm93KHJvdykpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGV4dEluUmFuZ2UoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydDogYXRvbSRQb2ludCxcbiAgZW5kOiBhdG9tJFBvaW50XG4pIHtcbiAgY29uc3QgY29kZSA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShbc3RhcnQsIGVuZF0pO1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGNvZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um93cyhcbiAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gIHN0YXJ0Um93OiBudW1iZXIsXG4gIGVuZFJvdzogbnVtYmVyXG4pIHtcbiAgY29uc3QgY29kZSA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZSh7XG4gICAgc3RhcnQ6IHtcbiAgICAgIHJvdzogc3RhcnRSb3csXG4gICAgICBjb2x1bW46IDBcbiAgICB9LFxuICAgIGVuZDoge1xuICAgICAgcm93OiBlbmRSb3csXG4gICAgICBjb2x1bW46IDk5OTk5OTlcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbm9ybWFsaXplU3RyaW5nKGNvZGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VsZWN0ZWRUZXh0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIHJldHVybiBub3JtYWxpemVTdHJpbmcoZWRpdG9yLmdldFNlbGVjdGVkVGV4dCgpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzQ29tbWVudChlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcG9zaXRpb246IGF0b20kUG9pbnQpIHtcbiAgY29uc3Qgc2NvcGUgPSBlZGl0b3Iuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24ocG9zaXRpb24pO1xuICBjb25zdCBzY29wZVN0cmluZyA9IHNjb3BlLmdldFNjb3BlQ2hhaW4oKTtcbiAgcmV0dXJuIF8uaW5jbHVkZXMoc2NvcGVTdHJpbmcsIFwiY29tbWVudC5saW5lXCIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNCbGFuayhlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgcm93OiBudW1iZXIpIHtcbiAgcmV0dXJuIGVkaXRvci5nZXRCdWZmZXIoKS5pc1Jvd0JsYW5rKHJvdykgfHwgZWRpdG9yLmlzQnVmZmVyUm93Q29tbWVudGVkKHJvdyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlc2NhcGVCbGFua1Jvd3MoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBzdGFydFJvdzogbnVtYmVyLFxuICBlbmRSb3c6IG51bWJlclxuKSB7XG4gIHdoaWxlIChlbmRSb3cgPiBzdGFydFJvdykge1xuICAgIGlmICghaXNCbGFuayhlZGl0b3IsIGVuZFJvdykpIGJyZWFrO1xuICAgIGVuZFJvdyAtPSAxO1xuICB9XG4gIHJldHVybiBlbmRSb3c7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb2xkUmFuZ2UoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IHJhbmdlID0gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KGVkaXRvciwgcm93KTtcbiAgaWYgKCFyYW5nZSkgcmV0dXJuO1xuICBpZiAoXG4gICAgcmFuZ2VbMV0gPCBlZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpICYmXG4gICAgZ2V0Um93KGVkaXRvciwgcmFuZ2VbMV0gKyAxKSA9PT0gXCJlbmRcIlxuICApIHtcbiAgICByYW5nZVsxXSArPSAxO1xuICB9XG4gIGxvZyhcImdldEZvbGRSYW5nZTpcIiwgcmFuZ2UpO1xuICByZXR1cm4gcmFuZ2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGb2xkQ29udGVudHMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IHJhbmdlID0gZ2V0Rm9sZFJhbmdlKGVkaXRvciwgcm93KTtcbiAgaWYgKCFyYW5nZSkgcmV0dXJuO1xuICByZXR1cm4gW2dldFJvd3MoZWRpdG9yLCByYW5nZVswXSwgcmFuZ2VbMV0pLCByYW5nZVsxXV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb2RlVG9JbnNwZWN0KGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHNlbGVjdGVkVGV4dCA9IGdldFNlbGVjdGVkVGV4dChlZGl0b3IpO1xuICBsZXQgY29kZTtcbiAgbGV0IGN1cnNvclBvc2l0aW9uO1xuICBpZiAoc2VsZWN0ZWRUZXh0KSB7XG4gICAgY29kZSA9IHNlbGVjdGVkVGV4dDtcbiAgICBjdXJzb3JQb3NpdGlvbiA9IGNvZGUubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG4gICAgY29uc3Qgcm93ID0gY3Vyc29yLmdldEJ1ZmZlclJvdygpO1xuICAgIGNvZGUgPSBnZXRSb3coZWRpdG9yLCByb3cpO1xuICAgIGN1cnNvclBvc2l0aW9uID0gY3Vyc29yLmdldEJ1ZmZlckNvbHVtbigpO1xuXG4gICAgLy8gVE9ETzogdXNlIGtlcm5lbC5jb21wbGV0ZSB0byBmaW5kIGEgc2VsZWN0aW9uXG4gICAgY29uc3QgaWRlbnRpZmllckVuZCA9IGNvZGUgPyBjb2RlLnNsaWNlKGN1cnNvclBvc2l0aW9uKS5zZWFyY2goL1xcVy8pIDogLTE7XG4gICAgaWYgKGlkZW50aWZpZXJFbmQgIT09IC0xKSB7XG4gICAgICBjdXJzb3JQb3NpdGlvbiArPSBpZGVudGlmaWVyRW5kO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBbY29kZSwgY3Vyc29yUG9zaXRpb25dO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3Qgc2NvcGUgPSBlZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpO1xuXG4gIGNvbnN0IHsgY29tbWVudFN0YXJ0U3RyaW5nIH0gPSBlZGl0b3IuZ2V0Q29tbWVudFN0cmluZ3Moc2NvcGUpO1xuXG4gIGlmICghY29tbWVudFN0YXJ0U3RyaW5nKSB7XG4gICAgbG9nKFwiQ2VsbE1hbmFnZXI6IE5vIGNvbW1lbnQgc3RyaW5nIGRlZmluZWQgaW4gcm9vdCBzY29wZVwiKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGVzY2FwZWRDb21tZW50U3RhcnRTdHJpbmcgPSBlc2NhcGVTdHJpbmdSZWdleHAoXG4gICAgY29tbWVudFN0YXJ0U3RyaW5nLnRyaW1SaWdodCgpXG4gICk7XG5cbiAgY29uc3QgcmVnZXhTdHJpbmcgPSBgJHtlc2NhcGVkQ29tbWVudFN0YXJ0U3RyaW5nfSglJXwgJSV8IDxjb2RlY2VsbD58IEluXFxbWzAtOSBdKlxcXTo/KWA7XG5cbiAgcmV0dXJuIHJlZ2V4U3RyaW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QnJlYWtwb2ludHMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBjb25zdCBicmVha3BvaW50cyA9IFtdO1xuXG4gIGNvbnN0IHJlZ2V4U3RyaW5nID0gZ2V0UmVnZXhTdHJpbmcoZWRpdG9yKTtcbiAgaWYgKHJlZ2V4U3RyaW5nKSB7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHJlZ2V4U3RyaW5nLCBcImdcIik7XG4gICAgYnVmZmVyLnNjYW4ocmVnZXgsICh7IHJhbmdlIH0pID0+IHtcbiAgICAgIGJyZWFrcG9pbnRzLnB1c2gocmFuZ2Uuc3RhcnQpO1xuICAgIH0pO1xuICB9XG5cbiAgYnJlYWtwb2ludHMucHVzaChidWZmZXIuZ2V0RW5kUG9zaXRpb24oKSk7XG5cbiAgbG9nKFwiQ2VsbE1hbmFnZXI6IEJyZWFrcG9pbnRzOlwiLCBicmVha3BvaW50cyk7XG5cbiAgcmV0dXJuIGJyZWFrcG9pbnRzO1xufVxuXG5mdW5jdGlvbiBnZXRDdXJyZW50Q29kZUNlbGwoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBsZXQgc3RhcnQgPSBuZXcgUG9pbnQoMCwgMCk7XG4gIGxldCBlbmQgPSBidWZmZXIuZ2V0RW5kUG9zaXRpb24oKTtcbiAgY29uc3QgcmVnZXhTdHJpbmcgPSBnZXRSZWdleFN0cmluZyhlZGl0b3IpO1xuXG4gIGlmICghcmVnZXhTdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFJhbmdlKHN0YXJ0LCBlbmQpO1xuICB9XG5cbiAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHJlZ2V4U3RyaW5nKTtcbiAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCk7XG5cbiAgd2hpbGUgKGN1cnNvci5yb3cgPCBlbmQucm93ICYmIGlzQ29tbWVudChlZGl0b3IsIGN1cnNvcikpIHtcbiAgICBjdXJzb3Iucm93ICs9IDE7XG4gICAgY3Vyc29yLmNvbHVtbiA9IDA7XG4gIH1cblxuICBpZiAoY3Vyc29yLnJvdyA+IDApIHtcbiAgICBidWZmZXIuYmFja3dhcmRzU2NhbkluUmFuZ2UoXG4gICAgICByZWdleCxcbiAgICAgIG5ldyBSYW5nZShzdGFydCwgY3Vyc29yKSxcbiAgICAgICh7IHJhbmdlIH0pID0+IHtcbiAgICAgICAgc3RhcnQgPSBuZXcgUG9pbnQocmFuZ2Uuc3RhcnQucm93ICsgMSwgMCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGJ1ZmZlci5zY2FuSW5SYW5nZShyZWdleCwgbmV3IFJhbmdlKGN1cnNvciwgZW5kKSwgKHsgcmFuZ2UgfSkgPT4ge1xuICAgIGVuZCA9IHJhbmdlLnN0YXJ0O1xuICB9KTtcblxuICBsb2coXCJDZWxsTWFuYWdlcjogQ2VsbCBbc3RhcnQsIGVuZF06XCIsIFtzdGFydCwgZW5kXSwgXCJjdXJzb3I6XCIsIGN1cnNvcik7XG5cbiAgcmV0dXJuIG5ldyBSYW5nZShzdGFydCwgZW5kKTtcbn1cblxuZnVuY3Rpb24gaXNFbWJlZGRlZENvZGUoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICByZWZlcmVuY2VTY29wZTogc3RyaW5nLFxuICByb3c6IG51bWJlclxuKSB7XG4gIGNvbnN0IHNjb3BlcyA9IGVkaXRvclxuICAgIC5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihuZXcgUG9pbnQocm93LCAwKSlcbiAgICAuZ2V0U2NvcGVzQXJyYXkoKTtcbiAgcmV0dXJuIF8uaW5jbHVkZXMoc2NvcGVzLCByZWZlcmVuY2VTY29wZSk7XG59XG5cbmZ1bmN0aW9uIGdldEN1cnJlbnRGZW5jZWRDb2RlQmxvY2soZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBjb25zdCB7IHJvdzogYnVmZmVyRW5kUm93IH0gPSBidWZmZXIuZ2V0RW5kUG9zaXRpb24oKTtcblxuICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKTtcbiAgbGV0IHN0YXJ0ID0gY3Vyc29yLnJvdztcbiAgbGV0IGVuZCA9IGN1cnNvci5yb3c7XG4gIGNvbnN0IHNjb3BlID0gZ2V0RW1iZWRkZWRTY29wZShlZGl0b3IsIGN1cnNvcik7XG4gIGlmICghc2NvcGUpIHJldHVybiBnZXRDdXJyZW50Q29kZUNlbGwoZWRpdG9yKTtcbiAgd2hpbGUgKHN0YXJ0ID4gMCAmJiBpc0VtYmVkZGVkQ29kZShlZGl0b3IsIHNjb3BlLCBzdGFydCAtIDEpKSB7XG4gICAgc3RhcnQgLT0gMTtcbiAgfVxuXG4gIHdoaWxlIChlbmQgPCBidWZmZXJFbmRSb3cgJiYgaXNFbWJlZGRlZENvZGUoZWRpdG9yLCBzY29wZSwgZW5kICsgMSkpIHtcbiAgICBlbmQgKz0gMTtcbiAgfVxuXG4gIHJldHVybiBuZXcgUmFuZ2UoW3N0YXJ0LCAwXSwgW2VuZCwgOTk5OTk5OV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VycmVudENlbGwoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpIHtcbiAgaWYgKGlzTXVsdGlsYW5ndWFnZUdyYW1tYXIoZWRpdG9yLmdldEdyYW1tYXIoKSkpIHtcbiAgICByZXR1cm4gZ2V0Q3VycmVudEZlbmNlZENvZGVCbG9jayhlZGl0b3IpO1xuICB9XG4gIHJldHVybiBnZXRDdXJyZW50Q29kZUNlbGwoZWRpdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENlbGxzKFxuICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgYnJlYWtwb2ludHM6IEFycmF5PGF0b20kUG9pbnQ+ID0gW11cbikge1xuICBpZiAoYnJlYWtwb2ludHMubGVuZ3RoICE9PSAwKSB7XG4gICAgYnJlYWtwb2ludHMuc29ydCgoYSwgYikgPT4gYS5jb21wYXJlKGIpKTtcbiAgfSBlbHNlIHtcbiAgICBicmVha3BvaW50cyA9IGdldEJyZWFrcG9pbnRzKGVkaXRvcik7XG4gIH1cbiAgcmV0dXJuIGdldENlbGxzRm9yQnJlYWtQb2ludHMoYnJlYWtwb2ludHMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2VsbHNGb3JCcmVha1BvaW50cyhicmVha3BvaW50czogQXJyYXk8YXRvbSRQb2ludD4pIHtcbiAgbGV0IHN0YXJ0ID0gbmV3IFBvaW50KDAsIDApO1xuICByZXR1cm4gXy5tYXAoYnJlYWtwb2ludHMsIGVuZCA9PiB7XG4gICAgY29uc3QgY2VsbCA9IG5ldyBSYW5nZShzdGFydCwgZW5kKTtcbiAgICBzdGFydCA9IG5ldyBQb2ludChlbmQucm93ICsgMSwgMCk7XG4gICAgcmV0dXJuIGNlbGw7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbW92ZURvd24oZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJvdzogbnVtYmVyKSB7XG4gIGNvbnN0IGxhc3RSb3cgPSBlZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpO1xuXG4gIGlmIChyb3cgPj0gbGFzdFJvdykge1xuICAgIGVkaXRvci5tb3ZlVG9Cb3R0b20oKTtcbiAgICBlZGl0b3IuaW5zZXJ0TmV3bGluZSgpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHdoaWxlIChyb3cgPCBsYXN0Um93KSB7XG4gICAgcm93ICs9IDE7XG4gICAgaWYgKCFpc0JsYW5rKGVkaXRvciwgcm93KSkgYnJlYWs7XG4gIH1cblxuICBlZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oe1xuICAgIHJvdyxcbiAgICBjb2x1bW46IDBcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kUHJlY2VkaW5nQmxvY2soXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICByb3c6IG51bWJlcixcbiAgaW5kZW50TGV2ZWw6IG51bWJlclxuKSB7XG4gIGxldCBwcmV2aW91c1JvdyA9IHJvdyAtIDE7XG4gIHdoaWxlIChwcmV2aW91c1JvdyA+PSAwKSB7XG4gICAgY29uc3QgcHJldmlvdXNJbmRlbnRMZXZlbCA9IGVkaXRvci5pbmRlbnRhdGlvbkZvckJ1ZmZlclJvdyhwcmV2aW91c1Jvdyk7XG4gICAgY29uc3Qgc2FtZUluZGVudCA9IHByZXZpb3VzSW5kZW50TGV2ZWwgPD0gaW5kZW50TGV2ZWw7XG4gICAgY29uc3QgYmxhbmsgPSBpc0JsYW5rKGVkaXRvciwgcHJldmlvdXNSb3cpO1xuICAgIGNvbnN0IGlzRW5kID0gZ2V0Um93KGVkaXRvciwgcHJldmlvdXNSb3cpID09PSBcImVuZFwiO1xuXG4gICAgaWYgKGlzQmxhbmsoZWRpdG9yLCByb3cpKSB7XG4gICAgICByb3cgPSBwcmV2aW91c1JvdztcbiAgICB9XG4gICAgaWYgKHNhbWVJbmRlbnQgJiYgIWJsYW5rICYmICFpc0VuZCkge1xuICAgICAgcmV0dXJuIFtnZXRSb3dzKGVkaXRvciwgcHJldmlvdXNSb3csIHJvdyksIHJvd107XG4gICAgfVxuICAgIHByZXZpb3VzUm93IC09IDE7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ29kZUJsb2NrKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IHNlbGVjdGVkVGV4dCA9IGdldFNlbGVjdGVkVGV4dChlZGl0b3IpO1xuXG4gIGlmIChzZWxlY3RlZFRleHQpIHtcbiAgICBjb25zdCBzZWxlY3RlZFJhbmdlID0gZWRpdG9yLmdldFNlbGVjdGVkQnVmZmVyUmFuZ2UoKTtcbiAgICBsZXQgZW5kUm93ID0gc2VsZWN0ZWRSYW5nZS5lbmQucm93O1xuICAgIGlmIChzZWxlY3RlZFJhbmdlLmVuZC5jb2x1bW4gPT09IDApIHtcbiAgICAgIGVuZFJvdyAtPSAxO1xuICAgIH1cbiAgICBlbmRSb3cgPSBlc2NhcGVCbGFua1Jvd3MoZWRpdG9yLCBzZWxlY3RlZFJhbmdlLnN0YXJ0LnJvdywgZW5kUm93KTtcbiAgICByZXR1cm4gW3NlbGVjdGVkVGV4dCwgZW5kUm93XTtcbiAgfVxuXG4gIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG5cbiAgY29uc3Qgcm93ID0gY3Vyc29yLmdldEJ1ZmZlclJvdygpO1xuICBsb2coXCJmaW5kQ29kZUJsb2NrOlwiLCByb3cpO1xuXG4gIGNvbnN0IGluZGVudExldmVsID0gY3Vyc29yLmdldEluZGVudExldmVsKCk7XG4gIGxldCBmb2xkYWJsZSA9IGVkaXRvci5pc0ZvbGRhYmxlQXRCdWZmZXJSb3cocm93KTtcbiAgY29uc3QgZm9sZFJhbmdlID0gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KGVkaXRvciwgcm93KTtcbiAgaWYgKCFmb2xkUmFuZ2UgfHwgZm9sZFJhbmdlWzBdID09IG51bGwgfHwgZm9sZFJhbmdlWzFdID09IG51bGwpIHtcbiAgICBmb2xkYWJsZSA9IGZhbHNlO1xuICB9XG5cbiAgaWYgKGZvbGRhYmxlKSB7XG4gICAgcmV0dXJuIGdldEZvbGRDb250ZW50cyhlZGl0b3IsIHJvdyk7XG4gIH1cbiAgaWYgKGlzQmxhbmsoZWRpdG9yLCByb3cpIHx8IGdldFJvdyhlZGl0b3IsIHJvdykgPT09IFwiZW5kXCIpIHtcbiAgICByZXR1cm4gZmluZFByZWNlZGluZ0Jsb2NrKGVkaXRvciwgcm93LCBpbmRlbnRMZXZlbCk7XG4gIH1cbiAgcmV0dXJuIFtnZXRSb3coZWRpdG9yLCByb3cpLCByb3ddO1xufVxuIl19